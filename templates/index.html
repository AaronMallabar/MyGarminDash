<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Garmin Dashboard</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap"
        rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

</head>

<body>

    <div class="container">

        <header>

            <h1>Garmin Dashboard</h1>

            <div id="last-sync" class="last-sync">Syncing...</div>

        </header>

        <div id="error-message"
            style="display: none; color: #f87171; background: rgba(248, 113, 113, 0.1); padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem;">

        </div>

        <!-- Health Metrics Grid (Small, Side-by-Side) -->

        <h2 style="margin-bottom: 1.5rem; font-size: 1.5rem;">Daily Health</h2>

        <div class="health-grid">

            <!-- Steps -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <div>

                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">Steps</h2>

                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">

                            <div class="metric-value" style="font-size: 2rem; margin-bottom: 0;"><span
                                    id="steps">--</span></div>

                            <div class="metric-unit" id="steps-goal-text" style="font-size: 0.8rem;">/ 10k</div>

                        </div>

                    </div>

                    <div style="text-align: right;">

                        <div style="font-size: 0.7rem; color: var(--text-secondary);">Streak</div>

                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--success-color);"><span
                                id="steps-streak">--</span></div>

                    </div>

                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">

                    <div class="range-selector" style="display: inline-flex; padding: 0.2rem;">

                        <button class="range-btn" onclick="updateStepsRange('1d', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1d</button>

                        <button class="range-btn active" onclick="updateStepsRange('1w', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1w</button>

                        <button class="range-btn" onclick="updateStepsRange('1m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1m</button>

                        <button class="range-btn" onclick="updateStepsRange('1y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1y</button>

                    </div>

                    <div style="flex-grow:1"></div>

                    <button class="nav-btn" id="steps-prev" onclick="shiftStepsDate(-1)"
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg></button>

                    <button class="nav-btn" id="steps-next" onclick="shiftStepsDate(1)" disabled
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg></button>

                </div>

                <div id="steps-visual-container" class="chart-container"
                    style="min-height: 200px; padding: 0; background: transparent; border: none; box-shadow: none;">

                    <canvas id="stepsHistoryChart"></canvas>

                    <div id="steps-donut-container"
                        style="display: none; width: 100%; height: 100%; position: relative;">

                        <!-- Donut logic kept, just resized via CSS or inline -->

                        <div class="donut-chart" id="steps-day-chart"
                            style="width: 140px; height: 140px; margin: 0 auto;">

                            <div class="donut-inner" style="width: 110px; height: 110px;">

                                <span class="donut-percent" id="steps-day-percent" style="font-size: 1.5rem;">0%</span>

                            </div>

                        </div>

                    </div>

                </div>

            </div>

            <!-- Sleep -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <div>

                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">Sleep</h2>

                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">

                            <div class="metric-value" style="font-size: 2rem; margin-bottom: 0;"><span
                                    id="sleep">--</span><span class="metric-unit">h</span></div>

                            <div class="metric-unit">Score: <span id="sleep-score-val">--</span></div>

                        </div>

                    </div>

                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">

                    <div class="range-selector" style="display: inline-flex; padding: 0.2rem;">

                        <button class="range-btn active" onclick="updateSleepRange('1d', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1d</button>

                        <button class="range-btn" onclick="updateSleepRange('1w', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1w</button>

                        <button class="range-btn" onclick="updateSleepRange('1m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1m</button>

                        <button class="range-btn" onclick="updateSleepRange('1y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1y</button>

                    </div>

                    <div style="flex-grow:1"></div>

                    <button class="nav-btn" id="sleep-prev" onclick="shiftSleepDate(-1)"
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg></button>

                    <button class="nav-btn" id="sleep-next" onclick="shiftSleepDate(1)" disabled
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg></button>

                </div>

                <div id="sleep-visual-container" class="chart-container"
                    style="min-height: 200px; padding: 0; background: transparent; border: none; box-shadow: none;">

                    <canvas id="sleepHistoryChart"></canvas>

                </div>

            </div>

            <!-- Hydration -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <div>

                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">Hydration</h2>

                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">

                            <div class="metric-value" style="font-size: 2rem; margin-bottom: 0;"><span
                                    id="hydration-val">--</span></div>

                            <div class="metric-unit">oz</div>

                        </div>

                    </div>

                    <div style="text-align: right;">

                        <div id="hydration-goal" style="font-size: 0.8rem; color: var(--text-secondary);">Goal: -- oz

                        </div>

                    </div>

                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">

                    <div class="range-selector" style="display: inline-flex; padding: 0.2rem;">

                        <button class="range-btn active" onclick="updateHydrationRange('1d', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1d</button>

                        <button class="range-btn" onclick="updateHydrationRange('1w', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1w</button>

                        <button class="range-btn" onclick="updateHydrationRange('1m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1m</button>

                        <button class="range-btn" onclick="updateHydrationRange('1y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1y</button>

                    </div>

                    <div style="flex-grow:1"></div>

                    <button class="nav-btn" id="hydration-prev" onclick="shiftHydrationDate(-1)"
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg></button>

                    <button class="nav-btn" id="hydration-next" onclick="shiftHydrationDate(1)" disabled
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg></button>

                </div>

                <div id="hydration-visual-container" class="chart-container"
                    style="min-height: 200px; padding: 0; background: transparent; border: none; box-shadow: none;">

                    <canvas id="hydrationHistoryChart"></canvas>

                    <div id="hydration-donut-container"
                        style="display: none; width: 100%; height: 100%; position: relative;">

                        <div class="donut-chart" id="hydration-chart"
                            style="width: 140px; height: 140px; margin: 0 auto;">

                            <div class="donut-inner" style="width: 110px; height: 110px;">

                                <span class="donut-percent" id="hydration-percent" style="font-size: 1.5rem;">0%</span>

                            </div>

                        </div>

                    </div>

                </div>

            </div>

            <!-- Heart Rate -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <div>

                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">Heart Rate</h2>

                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">

                            <div class="metric-value" style="font-size: 2rem; margin-bottom: 0;"><span
                                    id="rhr">--</span></div>

                            <div class="metric-unit">RHR</div>

                        </div>

                    </div>

                    <div style="text-align: right;">

                        <div style="font-size: 0.7rem; color: var(--text-secondary);">Max</div>

                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--danger-color);"><span
                                id="hr-max-val">--</span></div>

                    </div>

                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">

                    <div class="range-selector" style="display: inline-flex; padding: 0.2rem;">

                        <button class="range-btn active" onclick="updateHRVRange('1d', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1d</button>

                        <button class="range-btn" onclick="updateHRVRange('1w', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1w</button>

                        <button class="range-btn" onclick="updateHRVRange('1m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1m</button>

                        <button class="range-btn" onclick="updateHRVRange('1y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1y</button>

                    </div>

                    <div style="flex-grow:1"></div>

                    <button class="nav-btn" id="hr-prev" onclick="shiftHRDate(-1)" style="width:24px; height:24px;"><svg
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg></button>

                    <button class="nav-btn" id="hr-next" onclick="shiftHRDate(1)" disabled
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg></button>

                </div>

                <div id="hr-visual-container" class="chart-container"
                    style="min-height: 200px; padding: 0; background: transparent; border: none; box-shadow: none;">

                    <canvas id="hrHistoryChart"></canvas>

                </div>

            </div>

            <!-- Stress -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <div>

                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">Stress</h2>

                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">

                            <div class="metric-value" style="font-size: 2rem; margin-bottom: 0;"><span
                                    id="stress">--</span></div>

                            <div class="metric-unit">Avg</div>

                        </div>

                    </div>

                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">

                    <div class="range-selector" style="display: inline-flex; padding: 0.2rem;">

                        <button class="range-btn active" onclick="updateStressRange('1d', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1d</button>

                        <button class="range-btn" onclick="updateStressRange('1w', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1w</button>

                        <button class="range-btn" onclick="updateStressRange('1m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1m</button>

                        <button class="range-btn" onclick="updateStressRange('1y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1y</button>

                    </div>

                    <div style="flex-grow:1"></div>

                    <button class="nav-btn" id="stress-prev" onclick="shiftStressDate(-1)"
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg></button>

                    <button class="nav-btn" id="stress-next" onclick="shiftStressDate(1)" disabled
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg></button>

                </div>

                <div style="height: 200px;">

                    <canvas id="stressHistoryChart"></canvas>

                </div>

            </div>

            <!-- HRV Status -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <div>

                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">HRV Status</h2>

                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">

                            <div class="metric-value" style="font-size: 2rem; margin-bottom: 0;"><span
                                    id="hrv-val">--</span></div>

                            <div class="metric-unit">ms (Avg)</div>

                        </div>

                    </div>

                    <div style="text-align: right;">

                        <div id="hrv-status-badge" class="badge" style="margin-bottom: 0.25rem;">--</div>

                        <div id="hrv-weekly-avg" style="font-size: 0.75rem; color: var(--text-secondary);">7d Avg: -- ms
                        </div>

                    </div>

                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">

                    <div class="range-selector" style="display: inline-flex; padding: 0.2rem;">

                        <button class="range-btn active" onclick="updateHRVRange('1d', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1d</button>

                        <button class="range-btn" onclick="updateHRVRange('1w', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1w</button>

                        <button class="range-btn" onclick="updateHRVRange('1m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1m</button>

                        <button class="range-btn" onclick="updateHRVRange('1y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1y</button>

                    </div>

                    <div style="flex-grow:1"></div>

                    <button class="nav-btn" id="hrv-prev" onclick="shiftHRVDate(-1)"
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg></button>

                    <button class="nav-btn" id="hrv-next" onclick="shiftHRVDate(1)" disabled
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg></button>

                </div>

                <div id="hrv-visual-container" class="chart-container"
                    style="min-height: 200px; padding: 0; background: transparent; border: none; box-shadow: none;">

                    <canvas id="hrvHistoryChart" style="display: none;"></canvas>

                    <div id="hrv-status-container" style="margin-top: 1.5rem;">

                        <div
                            style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            <span>Baseline: <span id="hrv-baseline-low">--</span> - <span
                                    id="hrv-baseline-high">--</span>
                                ms</span>
                        </div>

                        <div class="hrv-gauge-container"
                            style="height: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; position: relative; overflow: hidden; margin-bottom: 2rem;">
                            <div id="hrv-baseline-zone"
                                style="position: absolute; height: 100%; background: rgba(74, 222, 128, 0.2); left: 30%; width: 40%;">
                            </div>
                            <div id="hrv-marker"
                                style="position: absolute; height: 100%; width: 4px; background: var(--text-primary); border-radius: 2px; left: 0; transition: left 0.5s ease; box-shadow: 0 0 10px rgba(255,255,255,0.5); z-index: 2;">
                            </div>
                        </div>

                        <div id="hrv-feedback"
                            style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4; min-height: 3em;">
                            --
                        </div>

                    </div>

                </div>

            </div>
            <!-- Intensity Minutes -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <div>

                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">Intensity Minutes</h2>

                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">

                            <div class="metric-value" style="font-size: 2rem; margin-bottom: 0;"><span
                                    id="im-val">--</span></div>

                            <div class="metric-unit">min</div>

                        </div>

                    </div>

                    <div style="text-align: right;">

                        <div style="font-size: 0.7rem; color: var(--text-secondary);">Goal</div>

                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--accent-color);"><span
                                id="im-goal">--</span></div>

                    </div>

                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">

                    <div class="range-selector" style="display: inline-flex; padding: 0.2rem;">

                        <button class="range-btn" onclick="updateIMRange('1d', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1d</button>

                        <button class="range-btn active" onclick="updateIMRange('1w', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1w</button>

                        <button class="range-btn" onclick="updateIMRange('1m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1m</button>

                        <button class="range-btn" onclick="updateIMRange('6m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">6m</button>

                        <button class="range-btn" onclick="updateIMRange('1y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1y</button>

                    </div>

                    <div style="flex-grow:1"></div>

                    <button class="nav-btn" id="im-prev" onclick="shiftIMDate(-1)" style="width:24px; height:24px;"><svg
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg></button>

                    <button class="nav-btn" id="im-next" onclick="shiftIMDate(1)" disabled
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg></button>

                </div>

                <div style="height: 200px;">

                    <canvas id="imHistoryChart"></canvas>

                </div>

            </div>

            <!-- Weight -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <div>

                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">Weight</h2>

                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">

                            <div class="metric-value" style="font-size: 2rem; margin-bottom: 0;"><span
                                    id="weight">--</span></div>

                            <div class="metric-unit">lbs</div>

                        </div>

                    </div>

                    <button class="range-btn" onclick="openWeightModal()"
                        style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">+ Log</button>

                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">

                    <div class="range-selector" style="display: inline-flex; padding: 0.2rem;">

                        <button class="range-btn active" onclick="updateWeightRange('1m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1m</button>

                        <button class="range-btn" onclick="updateWeightRange('6m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">6m</button>

                        <button class="range-btn" onclick="updateWeightRange('1y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1y</button>

                        <button class="range-btn" onclick="updateWeightRange('5y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">5y</button>

                    </div>

                    <div style="flex-grow:1"></div>

                    <button class="nav-btn" id="weight-prev" onclick="shiftWeightDate(-1)"
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg></button>

                    <button class="nav-btn" id="weight-next" onclick="shiftWeightDate(1)" disabled
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg></button>

                </div>

                <div style="height: 200px;">

                    <canvas id="weightHistoryChart"></canvas>

                </div>

            </div>

        </div>

        <!-- Performance Trends Grid -->

        <h2 style="margin-bottom: 1.5rem; font-size: 1.5rem;">Performance Goals & Trends</h2>

        <div class="dashboard-grid-1">

            <!-- Monthly Goals -->

            <div class="card">

                <h2 style="font-size: 1rem; margin-bottom: 1rem;">Monthly Goals</h2>

                <div class="goals-grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">

                    <div style="text-align: center;">

                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">Run</div>

                        <div class="donut-chart" id="month-run-chart"
                            style="width: 100px; height: 100px; margin: 0 auto 0.5rem auto;">

                            <div class="donut-inner" style="width: 80px; height: 80px;">

                                <span class="donut-percent" id="month-run-percent" style="font-size: 1.2rem;">0%</span>

                            </div>

                        </div>

                        <div id="month-run" style="font-size: 1rem; font-weight: 600; margin-bottom: 0.2rem;">--</div>

                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Goal: <span
                                id="month-run-goal">20</span></div>

                    </div>

                    <div style="text-align: center;">

                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">Cycle</div>

                        <div class="donut-chart" id="month-cycle-chart"
                            style="width: 100px; height: 100px; margin: 0 auto 0.5rem auto;">

                            <div class="donut-inner" style="width: 80px; height: 80px;">

                                <span class="donut-percent" id="month-cycle-percent"
                                    style="font-size: 1.2rem;">0%</span>

                            </div>

                        </div>

                        <div id="month-cycle" style="font-size: 1rem; font-weight: 600; margin-bottom: 0.2rem;">--</div>

                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Goal: <span
                                id="month-cycle-goal">200</span></div>

                    </div>

                </div>

            </div>

            <!-- Yearly Goals -->

            <div class="card">

                <h2 style="font-size: 1rem; margin-bottom: 1rem;">Yearly Goals</h2>

                <div class="goals-grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">

                    <div style="text-align: center;">

                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">Run</div>

                        <div class="donut-chart" id="year-run-chart"
                            style="width: 100px; height: 100px; margin: 0 auto 0.5rem auto;">

                            <div class="donut-inner" style="width: 80px; height: 80px;">

                                <span class="donut-percent" id="year-run-percent" style="font-size: 1.2rem;">0%</span>

                            </div>

                        </div>

                        <div id="year-run" style="font-size: 1rem; font-weight: 600; margin-bottom: 0.2rem;">--</div>

                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Goal: <span
                                id="year-run-goal">600</span></div>

                    </div>

                    <div style="text-align: center;">

                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">Cycle</div>

                        <div class="donut-chart" id="year-cycle-chart"
                            style="width: 100px; height: 100px; margin: 0 auto 0.5rem auto;">

                            <div class="donut-inner" style="width: 80px; height: 80px;">

                                <span class="donut-percent" id="year-cycle-percent" style="font-size: 1.2rem;">0%</span>

                            </div>

                        </div>

                        <div id="year-cycle" style="font-size: 1rem; font-weight: 600; margin-bottom: 0.2rem;">--</div>

                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Goal: <span
                                id="year-cycle-goal">2400</span></div>

                    </div>

                </div>

            </div>

            <!-- YTD Cycling -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <h2 style="font-size: 1rem; margin-bottom: 0;">YTD Cycling Trend</h2>

                    <button class="range-btn" onclick="resetChartZoom('ytdCyclingChart')"
                        style="padding: 0.2rem 0.5rem; font-size: 0.7rem;">Reset</button>

                </div>

                <div style="height: 350px;">

                    <canvas id="ytdCyclingChart"></canvas>

                </div>

            </div>

            <!-- YTD Running -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <h2 style="font-size: 1rem; margin-bottom: 0;">YTD Running Trend</h2>

                    <button class="range-btn" onclick="resetChartZoom('ytdRunningChart')"
                        style="padding: 0.2rem 0.5rem; font-size: 0.7rem;">Reset</button>

                </div>

                <div style="height: 350px;">

                    <canvas id="ytdRunningChart"></canvas>

                </div>

            </div>

        </div>

        <!-- Activity Heatmap -->

        <section style="margin-bottom: 3rem;">

            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 1rem;">

                <h2>Activity Calendar</h2>

                <div
                    style="font-size: 0.9rem; color: var(--text-secondary); display: flex; align-items: center; gap: 0.5rem;">

                    <span>Less</span>

                    <div style="display: flex; gap: 2px;">

                        <div style="width: 10px; height: 10px; background: rgba(255,255,255,0.05); border-radius: 2px;">

                        </div>

                        <div style="width: 10px; height: 10px; background: rgba(34, 197, 94, 0.3); border-radius: 2px;">

                        </div>

                        <div style="width: 10px; height: 10px; background: rgba(34, 197, 94, 0.6); border-radius: 2px;">

                        </div>

                        <div style="width: 10px; height: 10px; background: rgba(34, 197, 94, 1); border-radius: 2px;">

                        </div>

                    </div>

                    <span>More</span>

                </div>

            </div>

            <div id="heatmap-scroll-container" style="overflow-x: auto; padding-bottom: 1rem;">

                <div id="activity-heatmap" style="display: flex; gap: 4px; min-width: max-content;">

                    <!-- Heatmap injected via JS -->

                </div>

            </div>

        </section>

        <!-- Detailed Calendar Widget -->

        <section class="calendar-widget">

            <div class="calendar-header">

                <div class="calendar-nav">

                    <button class="nav-btn" onclick="shiftCalendarMonth(-1)">

                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg>

                    </button>

                    <div class="calendar-title" id="calendar-title">January 2026</div>

                    <button class="nav-btn" onclick="shiftCalendarMonth(1)">

                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg>

                    </button>

                    <button class="range-btn" onclick="resetCalendarToToday()">Today</button>

                </div>

                <div class="range-selector">

                    <button class="range-btn" id="cal-view-week" onclick="setCalendarView('week')">Week</button>

                    <button class="range-btn active" id="cal-view-month"
                        onclick="setCalendarView('month')">Month</button>

                    <button class="range-btn" id="cal-view-year" onclick="setCalendarView('year')">Year</button>

                </div>

            </div>

            <div class="calendar-grid-wrapper">
                <div class="calendar-layout">
                    <!-- Sidebar Totals -->
                    <div class="calendar-totals" id="calendar-totals">
                        <!-- Totals injected via JS -->
                    </div>

                    <!-- Calendar Grid -->
                    <div>
                        <div class="calendar-grid" style="margin-bottom: 0;">
                            <div class="calendar-day-header">Mon</div>
                            <div class="calendar-day-header">Tue</div>
                            <div class="calendar-day-header">Wed</div>
                            <div class="calendar-day-header">Thu</div>
                            <div class="calendar-day-header">Fri</div>
                            <div class="calendar-day-header">Sat</div>
                            <div class="calendar-day-header">Sun</div>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            <!-- Days injected via JS -->
                        </div>
                    </div>
                </div>
            </div>

        </section>

        <section class="activities-section">

            <h2>Recent Activities</h2>

            <div id="activity-list" class="activity-list">

                <!-- Activities will be injected here -->

                <div class="activity-item" style="justify-content: center; padding: 2rem;">

                    <div class="loading"></div>

                </div>

            </div>

        </section>

    </div>

    <!-- Activity Detail Modal -->

    <div id="activityModal" class="modal">

        <div class="modal-content">

            <button class="modal-close" onclick="closeModal()">&times;</button>

            <h2 id="modal-title">Activity Details</h2>

            <p id="modal-date" style="color: var(--text-secondary); margin-bottom: 2rem;"></p>

            <div class="activity-detail-grid">

                <div class="activity-detail-card">

                    <div class="activity-detail-label">Distance</div>

                    <div class="activity-detail-value" id="modal-distance">--</div>

                </div>

                <div class="activity-detail-card" id="modal-pace-label-container">

                    <div class="activity-detail-label" id="modal-pace-label">Overall Pace</div>

                    <div class="activity-detail-value" id="modal-pace">--</div>

                </div>

                <div class="activity-detail-card">

                    <div class="activity-detail-label">Duration</div>

                    <div class="activity-detail-value" id="modal-duration">--</div>

                </div>

                <div class="activity-detail-card">

                    <div class="activity-detail-label">Avg HR</div>

                    <div class="activity-detail-value" id="modal-hr">--</div>

                </div>

                <div class="activity-detail-card">

                    <div class="activity-detail-label">Elevation</div>

                    <div class="activity-detail-value" id="modal-elevation">--</div>

                </div>

                <div class="activity-detail-card">

                    <div class="activity-detail-label">Avg Cadence</div>

                    <div class="activity-detail-value" id="modal-cadence">--</div>

                </div>

                <div class="activity-detail-card" id="power-summary-card" style="display: none;">

                    <div class="activity-detail-label">Avg Power</div>

                    <div class="activity-detail-value" id="modal-power">--</div>

                </div>

                <div class="activity-detail-card">

                    <div class="activity-detail-label">Calories</div>

                    <div class="activity-detail-value" id="modal-calories">--</div>

                </div>

            </div>

            <div id="splits-section" style="display: none; margin-bottom: 2rem;">

                <h3 style="margin-bottom: 1rem;">Mile Splits</h3>

                <div id="splits-table">

                    <!-- Splits table injected here -->

                </div>

            </div>

            <h3 style="margin-bottom: 1rem;">Elevation</h3>

            <div class="small-chart-container">

                <canvas id="activityElevChart"></canvas>

            </div>

            <h3 style="margin-bottom: 1rem;">Heart Rate</h3>

            <div class="small-chart-container">

                <canvas id="activityHrChart"></canvas>

            </div>

            <h3 style="margin-bottom: 1rem;">Cadence</h3>

            <div class="small-chart-container">

                <canvas id="activityCadenceChart"></canvas>

            </div>

            <h3 style="margin-bottom: 1rem;" id="power-title">Power</h3>

            <div class="small-chart-container" id="power-chart-container" style="display: none;">

                <canvas id="activityPowerChart"></canvas>

            </div>

            <h3 style="margin-bottom: 1rem;">Speed/Pace</h3>

            <div class="small-chart-container">

                <canvas id="activitySpeedChart"></canvas>

            </div>

            <div style="display: flex; justify-content: center; margin-top: 2rem;">

                <button class="range-btn active" style="padding: 0.8rem 2rem;" onclick="closeModal()">Close

                    Details</button>

            </div>

        </div>

    </div>

    <!-- Weight Log Modal -->

    <div id="weightModal" class="modal">

        <div class="modal-content" style="max-width: 400px; text-align: center;">

            <button class="modal-close" onclick="closeWeightModal()">&times;</button>

            <h2 style="margin-bottom: 2rem;">Log Weight</h2>

            <div style="margin-bottom: 2rem;">

                <input type="number" id="weight-input" step="0.1" placeholder="Enter weight"
                    style="width: 100%; padding: 1rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; font-size: 1.5rem; text-align: center; margin-bottom: 1rem;">

                <div style="display: flex; justify-content: center; gap: 2rem;">

                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">

                        <input type="radio" name="weight-unit" value="lbs" checked style="transform: scale(1.5);">

                        <span style="font-size: 1.1rem;">lbs</span>

                    </label>

                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">

                        <input type="radio" name="weight-unit" value="kg" style="transform: scale(1.5);">

                        <span style="font-size: 1.1rem;">kg</span>

                    </label>

                </div>

            </div>

            <button class="range-btn active" style="padding: 0.8rem 2rem; width: 100%; font-size: 1.1rem;"
                onclick="submitWeight()">Save Weight</button>

        </div>

    </div>

    <script>
        // Global chart instances
        const chartInstances = {};

        // Helper to get local date string YYYY-MM-DD
        function getLocalDateStr(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseLocalDate(dateStr) {
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        // Helper to format distance in both miles and km
        function formatDualDistance(miles) {
            const km = (miles * 1.60934).toFixed(1);
            const mi = Number(miles).toFixed(1);
            return `${mi} mi / ${km} km`;
        }

        function safeSetText(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }

        function showError(msg) {
            const el = document.getElementById('error-message');
            if (el) {
                el.textContent = msg;
                el.style.display = 'block';
            }
            safeSetText('last-sync', 'Error');
        }

        // HRV Support
        let currentHRVEndDate = new Date();
        let currentHRVRange = '1d';

        async function updateHRVRange(range, btn) {
            if (range) currentHRVRange = range;
            if (btn) {
                btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            try {
                const res = await fetch(`/api/hrv?end_date=${currentHRVEndDate.toISOString().split('T')[0]}&range=${currentHRVRange}`);
                if (res.ok) {
                    const data = await res.json();
                    if (!data.error) renderHRVVisual(data);
                }
            } catch (err) {
                console.error('HRV error:', err);
            }
        }

        function shiftHRVDate(dir) {
            currentHRVEndDate.setDate(currentHRVEndDate.getDate() + (dir * (currentHRVRange === '1d' ? 1 : 7)));
            if (currentHRVEndDate > new Date()) currentHRVEndDate = new Date();
            updateHRVRange();
        }

        function renderHRVVisual(data) {
            const canvasId = 'hrvHistoryChart';
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const statusContainer = document.getElementById('hrv-status-container');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            const range = data.range || currentHRVRange;

            if (range === '1d') {
                if (canvas) canvas.style.display = 'none';
                if (statusContainer) statusContainer.style.display = 'block';

                if (!data.hrvSummary) return;
                const summary = data.hrvSummary;

                // Use 7-day average (weeklyAvg) as the primary metric
                safeSetText('hrv-val', summary.weeklyAvg || '--');
                safeSetText('hrv-weekly-avg', `7d Avg: ${summary.weeklyAvg || '--'} ms`);

                const statusEl = document.getElementById('hrv-status-badge');
                if (statusEl) {
                    const status = summary.status || 'NO_STATUS';
                    statusEl.textContent = status.replace(/_/g, ' ');
                    statusEl.className = 'badge';

                    if (status === 'BALANCED') statusEl.classList.add('badge-balanced');
                    else if (status === 'UNBALANCED') statusEl.classList.add('badge-unbalanced');
                    else if (status === 'LOW') statusEl.classList.add('badge-low');
                    else statusEl.classList.add('badge-gray');
                }

                const baseline = summary.baseline;
                if (baseline) {
                    safeSetText('hrv-baseline-low', baseline.balancedLow || '--');
                    safeSetText('hrv-baseline-high', baseline.balancedUpper || '--');

                    const low = (baseline.balancedLow || 40) - 15;
                    const high = (baseline.balancedUpper || 80) + 15;
                    const rangeVal = high - low;
                    const val = summary.weeklyAvg || low;
                    const pct = Math.max(0, Math.min(100, ((val - low) / rangeVal) * 100));

                    const marker = document.getElementById('hrv-marker');
                    if (marker) marker.style.left = `${pct}%`;

                    const zone = document.getElementById('hrv-baseline-zone');
                    if (zone) {
                        const zoneStart = Math.max(0, ((baseline.balancedLow - low) / rangeVal) * 100);
                        const zoneWidth = ((baseline.balancedUpper - baseline.balancedLow) / rangeVal) * 100;
                        zone.style.left = `${zoneStart}%`;
                        zone.style.width = `${zoneWidth}%`;
                    }
                }

                const feedback = summary.feedbackPhrase || '';
                const friendlyFeedback = feedback
                    .replace(/HRV_STATUS_FEEDBACK_/g, '')
                    .replace(/HRV_UNBALANCED_/g, 'Unbalanced: ')
                    .replace(/_/g, ' ')
                    .toLowerCase()
                    .replace(/^\w/, c => c.toUpperCase());
                safeSetText('hrv-feedback', friendlyFeedback || 'No feedback available');

            } else {
                if (canvas) canvas.style.display = 'block';
                if (statusContainer) statusContainer.style.display = 'none';

                if (!data.history || data.history.length === 0) return;

                const labels = data.history.map(d => {
                    const p = d.calendarDate.split('-');
                    return p[1] + '/' + p[2];
                });

                const lastSummary = data.history[data.history.length - 1];
                if (lastSummary) {
                    safeSetText('hrv-val', lastSummary.weeklyAvg || '--');
                    safeSetText('hrv-weekly-avg', `7d Avg: ${lastSummary.weeklyAvg || '--'} ms`);

                    const statusEl = document.getElementById('hrv-status-badge');
                    if (statusEl) {
                        const status = lastSummary.status || 'NO_STATUS';
                        statusEl.textContent = status.replace(/_/g, ' ');
                        statusEl.className = 'badge';
                        if (status === 'BALANCED') statusEl.classList.add('badge-balanced');
                        else if (status === 'UNBALANCED') statusEl.classList.add('badge-unbalanced');
                        else if (status === 'LOW') statusEl.classList.add('badge-low');
                        else statusEl.classList.add('badge-gray');
                    }
                }

                // Prepare datasets for dot plot with shaded baseline
                const hrvData = data.history.map(d => d.weeklyAvg);
                const baselineHighs = data.history.map(d => d.baseline ? d.baseline.balancedUpper : null);
                const baselineLows = data.history.map(d => d.baseline ? d.baseline.balancedLow : null);

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'HRV (7d Avg)',
                                data: hrvData,
                                borderColor: 'rgba(56, 189, 248, 0.5)',
                                backgroundColor: data.history.map(d => {
                                    if (d.status === 'BALANCED') return '#4ade80';
                                    if (d.status === 'UNBALANCED') return '#fb923c';
                                    if (d.status === 'LOW') return '#f87171';
                                    return '#38bdf8';
                                }),
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                showLine: false, // Dot plot
                                order: 1
                            },
                            {
                                label: 'Baseline Upper',
                                data: baselineHighs,
                                borderColor: 'transparent',
                                backgroundColor: 'rgba(74, 222, 128, 0.1)',
                                fill: {
                                    target: 2,
                                    above: 'rgba(74, 222, 128, 0.1)'
                                },
                                pointRadius: 0,
                                tension: 0.2,
                                order: 2
                            },
                            {
                                label: 'Baseline Lower',
                                data: baselineLows,
                                borderColor: 'transparent',
                                pointRadius: 0,
                                fill: false,
                                tension: 0.2,
                                order: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: '#94a3b8',
                                    filter: item => item.text !== 'Baseline Lower' && item.text !== 'Baseline Upper'
                                }
                            }
                        },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 7 } },
                            y: {
                                beginAtZero: false,
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#94a3b8' }
                            }
                        }
                    }
                });
            }
        }

        // Intensity Minutes Support
        let currentIMEndDate = new Date();
        let currentIMRange = '1w';

        async function updateIMRange(range, btn) {
            if (range) currentIMRange = range;
            if (btn) {
                btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            updateNavButtons('im', currentIMEndDate);
            try {
                const res = await fetch(`/api/intensity_minutes_history?range=${currentIMRange}&end_date=${getLocalDateStr(currentIMEndDate)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (!data.error) renderIntensityMinutesVisualV2(data);
                }
            } catch (err) {
                console.error('Intensity minutes error:', err);
            }
        }

        function shiftIMDate(dir) {
            const shift = currentIMRange === '1d' ? 1 : 7;
            currentIMEndDate.setDate(currentIMEndDate.getDate() + (dir * shift));
            if (currentIMEndDate > new Date()) currentIMEndDate = new Date();
            updateIMRange();
        }

        function renderIntensityMinutesVisual(data) {
            const canvasId = 'imHistoryChart';
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            const range = data.range || currentIMRange;
            const history = data.history || [];
            const goal = data.goal || 150;

            // Updated im-val should be the cumulative total for THIS WEEK (Mon-Sun)
            if (history.length > 0) {
                let thisWeekTotal = 0;
                // Walk backwards to find the current week's total starting Monday
                for (let i = history.length - 1; i >= 0; i--) {
                    const d = history[i];
                    const dt = parseLocalDate(d.date);
                    thisWeekTotal += d.total;
                    if (dt.getDay() === 1) break; // Monday found
                }
                safeSetText('im-val', thisWeekTotal);
                safeSetText('im-goal', goal);
            }

            if (range === '1d') {
                safeSetText('im-val', data.summary.total || '0');
                safeSetText('im-goal', data.summary.goal || '150');

                // Cumulative for the day, starting from startDayMinutes (total at beginning of day)
                let cumulative = data.summary.startDayMinutes || 0;
                const points = data.samples.map(s => {
                    cumulative += s[1];
                    return { x: s[0], y: cumulative };
                });

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Intensity Minutes',
                            data: points,
                            borderColor: '#38bdf8',
                            backgroundColor: 'rgba(56, 189, 248, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { type: 'time', time: { displayFormats: { hour: 'HH:mm' } }, grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            } else if (range === '1w') {
                const lastDay = data.history[data.history.length - 1];
                safeSetText('im-val', lastDay ? lastDay.total : '--');
                safeSetText('im-goal', data.goal || '150');

                // Calculate cumulative, resetting on Monday
                let cumulative = 0;
                const cumulativeData = data.history.map(d => {
                    const date = parseLocalDate(d.date);
                    if (date.getDay() === 1) cumulative = 0; // Monday reset
                    cumulative += d.total;
                    return cumulative;
                });

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.history.map(d => parseLocalDate(d.date).toLocaleDateString([], { weekday: 'short' })),
                        datasets: [{
                            label: 'Cumulative Intensity Minutes',
                            data: cumulativeData,
                            borderColor: '#38bdf8',
                            borderWidth: 3,
                            pointRadius: 4,
                            fill: true,
                            backgroundColor: 'rgba(56, 189, 248, 0.1)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            } else if (range === '1m') {
                // Separate lines for each week (last 4 weeks)
                const lastDay = data.history[data.history.length - 1];
                safeSetText('im-val', lastDay ? lastDay.total : '--');

                const weeks = [];
                for (let i = 0; i < data.history.length; i += 7) {
                    weeks.push(data.history.slice(i, i + 7));
                }

                const datasets = weeks.map((week, idx) => {
                    let cumulative = 0;
                    const cData = week.map(d => {
                        cumulative += d.total;
                        return cumulative;
                    });

                    return {
                        label: `Week ${weeks.length - idx}`,
                        data: cData,
                        borderColor: `hsla(${200 + idx * 40}, 70%, 60%, ${1 - idx * 0.2})`,
                        borderWidth: idx === 0 ? 3 : 2,
                        pointRadius: idx === 0 ? 3 : 0,
                        tension: 0.1,
                        fill: idx === 0 ? 'origin' : false,
                        backgroundColor: idx === 0 ? 'rgba(56, 189, 248, 0.05)' : 'transparent'
                    };
                }).reverse();

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: datasets
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'top', labels: { color: '#94a3b8', boxWidth: 10 } } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            } else { // 6m or 1y
                const lastWeek = history[history.length - 1];
                safeSetText('im-val', lastWeek ? lastWeek.total : '--');
                safeSetText('im-goal', lastWeek ? lastWeek.goal : '150');

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: history.map((d, i) => (i % 4 === 0) ? parseLocalDate(d.date).toLocaleDateString([], { month: 'short', day: 'numeric' }) : ''),
                        datasets: [{
                            label: 'Weekly Total',
                            data: history.map(d => d.total),
                            backgroundColor: history.map(d => d.total >= d.goal ? '#4ade80' : '#38bdf8'),
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94a3b8', autoSkip: false } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }

        async function fetchData() {
            try {
                // Fetch basic stats
                const statsRes = await fetch('/api/stats');
                if (statsRes.ok) {
                    const stats = await statsRes.json();
                    if (!stats.error) updateDashboard(stats);
                    else showError(stats.error);
                }

                // Fetch Goals Config
                const goalsConfigRes = await fetch('/api/goals_config');
                if (goalsConfigRes.ok) {
                    const goalsConfig = await goalsConfigRes.json();
                    if (!goalsConfig.error) {
                        const runGoalEl = document.getElementById('month-run-goal');
                        const cycleGoalEl = document.getElementById('month-cycle-goal');
                        const yearRunGoalEl = document.getElementById('year-run-goal');
                        const yearCycleGoalEl = document.getElementById('year-cycle-goal');

                        if (runGoalEl) runGoalEl.innerHTML = formatDualDistance(goalsConfig.monthly.running);
                        if (cycleGoalEl) cycleGoalEl.innerHTML = formatDualDistance(goalsConfig.monthly.cycling);
                        if (yearRunGoalEl) yearRunGoalEl.innerHTML = formatDualDistance(goalsConfig.yearly.running);
                        if (yearCycleGoalEl) yearCycleGoalEl.innerHTML = formatDualDistance(goalsConfig.yearly.cycling);
                    }
                }

                // Fetch Longterm Stats
                const ltRes = await fetch('/api/longterm_stats');
                if (ltRes.ok) {
                    const ltStats = await ltRes.json();
                    if (!ltStats.error) updateLongtermStats(ltStats);
                }

                // Fetch YTD Mileage Comparison
                const ytdRes = await fetch('/api/ytd_mileage_comparison');
                if (ytdRes.ok) {
                    const ytdData = await ytdRes.json();
                    if (!ytdData.error) {
                        renderYTDChart('ytdCyclingChart', ytdData.labels, ytdData.cycling);
                        renderYTDChart('ytdRunningChart', ytdData.labels, ytdData.running);
                    }
                }

                // Initialize historical charts
                updateWeightRange('1m');
                updateStepsRange('1w');
                updateHRRange('1d');
                updateStressRange('1d');
                updateSleepRange('1d');
                updateHydrationRange('1d');
                updateHRVRange('1d');
                updateIMRange('1w');
                fetchActivityHeatmap();
                fetchCalendarData();

                // Update timestamp
                const syncEl = document.getElementById('last-sync');
                if (syncEl) syncEl.textContent = 'Synced: ' + new Date().toLocaleTimeString();

            } catch (err) {
                console.error(err);
                showError('Could not load data. Check console.');
            }
        }

        window.updateDashboard = function (data) {
            safeSetText('steps', data.steps ? data.steps.toLocaleString() : '0');
            safeSetText('rhr', data.resting_hr || '--');
            safeSetText('stress', data.stress_avg || '--');

            if (data.weight_grams) {
                const kg = (data.weight_grams / 1000).toFixed(1);
                const lbs = (kg * 2.20462).toFixed(1);
                safeSetText('weight', lbs + ' lbs');
                safeSetText('weight-dual', kg + ' kg');
            }

            const sleepHours = data.sleep_seconds ? (data.sleep_seconds / 3600).toFixed(1) : '--';
            safeSetText('sleep', sleepHours);
            safeSetText('sleep-score-val', data.sleep_score || '--');

            const activityList = document.getElementById('activity-list');
            if (activityList) {
                activityList.innerHTML = '';
                if (data.activities && data.activities.length > 0) {
                    data.activities.forEach(activity => {
                        const el = document.createElement('div');
                        el.className = 'activity-item';
                        const date = new Date(activity.startTimeLocal).toLocaleDateString([], { month: 'short', day: 'numeric' });
                        const distanceKm = (activity.distance / 1000).toFixed(2);
                        const distanceMi = (activity.distance / 1609.34).toFixed(2);
                        const durationMin = Math.round(activity.duration / 60);

                        el.innerHTML = `
                            <div class="activity-info">
                                <div class="activity-icon">${getActivityIcon(activity.activityType.typeKey)}</div>
                                <div class="activity-details">
                                    <h3>${activity.activityName}</h3>
                                    <div class="activity-meta">${date}  ${activity.activityType.display}</div>
                                </div>
                            </div>
                            <div class="activity-stats">
                                <div class="stat-group">
                                    <div>${distanceMi} mi / ${distanceKm} km</div>
                                    <div>distance</div>
                                </div>
                                <div class="stat-group">
                                    <div>${durationMin}</div>
                                    <div>min</div>
                                </div>
                            </div>
                        `;
                        el.onclick = () => openActivityDetail(activity.activityId, activity);
                        activityList.appendChild(el);
                    });
                } else {
                    activityList.innerHTML = '<div class="activity-item" style="justify-content: center;">No recent activities found</div>';
                }
            }
        }

        function getActivityIcon(type) {
            if (type.includes('running')) return '';
            if (type.includes('cycling') || type.includes('ride')) return '';
            if (type.includes('swimming')) return '';
            if (type.includes('walking')) return '';
            if (type.includes('strength')) return '';
            return '';
        }

        function updateLongtermStats(data) {
            const getSafeGoal = (id) => {
                const el = document.getElementById(id);
                if (!el) return 1;
                const val = parseFloat(el.textContent);
                return (isNaN(val) || val <= 0) ? 1 : val;
            };

            const updateMetric = (type, timeframe, goalId, valId, percentId, chartId) => {
                const goal = getSafeGoal(goalId);
                const value = data[timeframe][type];
                const percent = Math.min(100, Math.round((value / goal) * 100));

                const valEl = document.getElementById(valId);
                const percentEl = document.getElementById(percentId);
                const chartEl = document.getElementById(chartId);

                if (valEl) valEl.innerHTML = formatDualDistance(value);
                if (percentEl) percentEl.textContent = percent + '%';
                if (chartEl) chartEl.style.background = `conic-gradient(var(--accent-color) 0% ${percent}%, rgba(255,255,255,0.1) ${percent}% 100%)`;
            };

            updateMetric('running', 'month', 'month-run-goal', 'month-run', 'month-run-percent', 'month-run-chart');
            updateMetric('cycling', 'month', 'month-cycle-goal', 'month-cycle', 'month-cycle-percent', 'month-cycle-chart');
            updateMetric('running', 'year', 'year-run-goal', 'year-run', 'year-run-percent', 'year-run-chart');
            updateMetric('cycling', 'year', 'year-cycle-goal', 'year-cycle', 'year-cycle-percent', 'year-cycle-chart');
        }

        // --- Historical & Chart Functions ---

        function resetChartZoom(id) {
            if (chartInstances[id]) chartInstances[id].resetZoom();
        }

        function renderYTDChart(canvasId, labels, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: '2024', data: data.years['2024'], borderColor: '#818cf8', backgroundColor: 'rgba(129, 140, 248, 0.1)', borderWidth: 2, tension: 0.1, pointRadius: 0 },
                        { label: '2025', data: data.years['2025'], borderColor: '#38bdf8', backgroundColor: 'rgba(56, 189, 248, 0.1)', borderWidth: 2, tension: 0.1, pointRadius: 0 },
                        { label: '2026 (Current)', data: data.years['2026'], borderColor: '#4ade80', backgroundColor: 'rgba(74, 222, 128, 0.1)', borderWidth: 3, tension: 0.1, pointRadius: 0 },
                        { label: `Goal (${data.yearly_goal} mi)`, data: data.goal_line, borderColor: '#f87171', backgroundColor: 'rgba(248, 113, 113, 0.1)', borderWidth: 2, borderDash: [5, 5], tension: 0, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } },
                        legend: { position: 'top', labels: { color: '#f1f5f9', boxWidth: 12, boxHeight: 2, padding: 10, font: { size: 11 } } },
                        tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)} mi / ${(ctx.parsed.y * 1.60934).toFixed(1)} km` } }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#94a3b8', font: { size: 12 }, callback: val => val + ' mi' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        x: { ticks: { color: '#94a3b8', font: { size: 12 }, maxTicksLimit: 15 }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                    }
                }
            });
        }

        let currentWeightEndDate = new Date();
        let currentWeightRange = '1m';
        async function updateWeightRange(range, btn) {
            if (range) currentWeightRange = range;
            if (btn) {
                btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            updateNavButtons('weight', currentWeightEndDate);
            try {
                const res = await fetch(`/api/weight_history?range=${currentWeightRange}&end_date=${getLocalDateStr(currentWeightEndDate)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (!data.error) renderWeightChart(data, currentWeightRange);
                }
            } catch (err) { console.error('Weight history error:', err); }
        }

        function renderWeightChart(history, range) {
            const canvasId = 'weightHistoryChart';
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            const weights = history.map(d => d.weight_lbs);
            const min = Math.floor(Math.min(...weights) - 2);
            const max = Math.ceil(Math.max(...weights) + 2);

            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{ label: 'Weight (lbs)', data: history.map(d => ({ x: d.date, y: d.weight_lbs })), borderColor: '#818cf8', backgroundColor: 'rgba(129, 140, 248, 0.1)', borderWidth: 3, tension: 0.3, pointRadius: 3, fill: true }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } },
                        legend: { display: false },
                        tooltip: { callbacks: { label: (ctx) => `Weight: ${ctx.parsed.y.toFixed(1)} lbs` } }
                    },
                    scales: {
                        x: { type: 'time', time: { unit: 'month' }, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                        y: { min, max, ticks: { color: '#94a3b8', callback: v => v + ' lbs' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        let currentStepsEndDate = new Date();
        let currentStepsRange = '1w';
        async function updateStepsRange(range, btn) {
            if (range) currentStepsRange = range;
            if (btn) {
                btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            updateNavButtons('steps', currentStepsEndDate);
            try {
                const res = await fetch(`/api/steps_history?range=${currentStepsRange}&end_date=${getLocalDateStr(currentStepsEndDate)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (!data.error) renderStepsVisual(data);
                }
            } catch (err) { console.error('Steps history error:', err); }
        }

        function renderStepsVisual(data) {
            const canvasId = 'stepsHistoryChart';
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const donutContainer = document.getElementById('steps-donut-container');
            const streakEl = document.getElementById('steps-streak');
            if (streakEl) streakEl.textContent = data.streak || 0;

            if (data.range === '1d') {
                if (canvas) canvas.style.display = 'none';
                if (donutContainer) donutContainer.style.display = 'flex';
                const day = data.history[data.history.length - 1] || { totalSteps: 0, stepGoal: 10000 };
                const percent = Math.min(100, Math.round((day.totalSteps / day.stepGoal) * 100));
                safeSetText('steps', day.totalSteps.toLocaleString());
                safeSetText('steps-day-percent', percent + '%');
                const chart = document.getElementById('steps-day-chart');
                if (chart) chart.style.background = `conic-gradient(${percent >= 100 ? 'var(--success-color)' : 'var(--accent-color)'} 0% ${percent}%, rgba(255,255,255,0.1) ${percent}% 100%)`;
            } else {
                if (canvas) canvas.style.display = 'block';
                if (donutContainer) donutContainer.style.display = 'none';
                if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.history.map(d => { const p = d.calendarDate.split('-'); return `${p[1]}/${p[2]}`; }),
                        datasets: [{ label: 'Steps', data: data.history.map(d => d.totalSteps), backgroundColor: data.history.map(d => d.totalSteps >= d.stepGoal ? '#4ade80' : '#38bdf8'), borderRadius: 4 }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } },
                            legend: { display: false },
                            tooltip: { callbacks: { label: (ctx) => `Steps: ${ctx.parsed.y.toLocaleString()}` } }
                        },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 7 } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }

        let currentHREndDate = new Date();
        let currentHRRange = '1d';
        async function updateHRRange(range, btn) {
            if (range) currentHRRange = range;
            if (btn) {
                btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            updateNavButtons('hr', currentHREndDate);
            try {
                const res = await fetch(`/api/hr_history?range=${currentHRRange}&end_date=${getLocalDateStr(currentHREndDate)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (!data.error) renderHRVisual(data);
                }
            } catch (err) { console.error('HR history error:', err); }
        }

        function renderHRVisual(data) {
            const canvasId = 'hrHistoryChart';
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            if (data.range === '1d') {
                const maxHR = data.max_hr || 190;
                const zones = data.zones || [95, 114, 133, 152, 171];
                safeSetText('hr-max-val', data.summary.max || '--');

                const points = data.samples.map(s => ({ x: s[0], y: s[1] }));
                const getZoneColor = (hr) => {
                    if (hr >= zones[4]) return '#a855f7';
                    if (hr >= zones[3]) return '#ef4444';
                    if (hr >= zones[2]) return '#f97316';
                    if (hr >= zones[1]) return '#22c55e';
                    if (hr >= zones[0]) return '#3b82f6';
                    return '#94a3b8';
                };

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Heart Rate',
                            data: points,
                            borderWidth: 2,
                            pointRadius: 0,
                            segment: { borderColor: ctx => getZoneColor(ctx.p1.parsed.y) },
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } } },
                        scales: {
                            x: { type: 'time', time: { displayFormats: { hour: 'HH:mm', minute: 'HH:mm' } }, grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { min: 40, max: Math.max(200, maxHR + 5), grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            } else {
                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.history.map(d => d.date),
                        datasets: [
                            { label: 'Resting HR', data: data.history.map(d => d.rhr), borderColor: '#38bdf8', backgroundColor: 'rgba(56, 189, 248, 0.1)', borderWidth: 3, fill: true, tension: 0.3 },
                            { label: 'Max HR', data: data.history.map(d => d.max), borderColor: '#ef4444', borderDash: [5, 5], borderWidth: 2, pointRadius: 2, tension: 0.3 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } },
                            legend: { display: true, position: 'top', labels: { color: '#94a3b8', boxWidth: 12 } }
                        },
                        scales: {
                            x: { type: 'time', time: { unit: 'day' }, grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }

        let currentStressEndDate = new Date();
        let currentStressRange = '1d';
        async function updateStressRange(range, btn) {
            if (range) currentStressRange = range;
            if (btn) {
                btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            updateNavButtons('stress', currentStressEndDate);
            try {
                const res = await fetch(`/api/stress_history?range=${currentStressRange}&end_date=${getLocalDateStr(currentStressEndDate)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (!data.error) renderStressVisual(data);
                }
            } catch (err) { console.error('Stress history error:', err); }
        }

        function renderStressVisual(data) {
            const canvasId = 'stressHistoryChart';
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            if (data.range === '1d') {
                safeSetText('stress', data.summary.avg || '--');
                const points = data.samples.map(s => ({ x: s[0], y: s[1] }));
                const getStressColor = (val) => {
                    if (val < 0) return 'rgba(148, 163, 184, 0.1)';
                    if (val <= 25) return '#94a3b8';
                    if (val <= 50) return '#f97316';
                    if (val <= 75) return '#f43f5e';
                    return '#ef4444';
                };

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Stress',
                            data: points,
                            borderWidth: 2,
                            pointRadius: 0,
                            segment: { borderColor: ctx => getStressColor(ctx.p1.parsed.y) },
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } } },
                        scales: {
                            x: { type: 'time', time: { displayFormats: { hour: 'HH:mm', minute: 'HH:mm' } }, grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { min: 0, max: 100, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            } else {
                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.history.map(d => d.date),
                        datasets: [
                            { label: 'Avg Stress', data: data.history.map(d => d.avg), borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', borderWidth: 3, fill: true, tension: 0.3 },
                            { label: 'Max Stress', data: data.history.map(d => d.max), borderColor: '#ef4444', borderDash: [5, 5], borderWidth: 2, pointRadius: 2, tension: 0.3 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } },
                            legend: { display: true, labels: { color: '#94a3b8' } }
                        },
                        scales: {
                            x: { type: 'time', time: { unit: 'day' }, grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { min: 0, max: 100, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }

        let currentSleepEndDate = new Date();
        let currentSleepRange = '1d';
        async function updateSleepRange(range, btn) {
            if (range) currentSleepRange = range;
            if (btn) {
                btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            updateNavButtons('sleep', currentSleepEndDate);
            try {
                const res = await fetch(`/api/sleep_history?range=${currentSleepRange}&end_date=${getLocalDateStr(currentSleepEndDate)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (!data.error) renderSleepVisual(data);
                }
            } catch (err) { console.error('Sleep history error:', err); }
        }

        function renderSleepVisual(data) {
            const canvasId = 'sleepHistoryChart';
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            if (data.range === '1d') {
                const s = data.summary;
                safeSetText('sleep', (s.total / 3600).toFixed(1));
                safeSetText('sleep-score-val', s.score || '--');
                const stageData = [
                    { label: 'Deep', value: s.deep || 0, color: '#6366f1' },
                    { label: 'Light', value: s.light || 0, color: '#3b82f6' },
                    { label: 'REM', value: s.rem || 0, color: '#2dd4bf' },
                    { label: 'Awake', value: s.awake || 0, color: '#f97316' }
                ].filter(d => d.value > 0);

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: stageData.map(d => d.label), datasets: [{ data: stageData.map(d => d.value), backgroundColor: stageData.map(d => d.color), borderWidth: 0 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: {
                            legend: { display: true, position: 'right', labels: { color: '#94a3b8', boxWidth: 12, padding: 20 } },
                            tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${Math.floor(ctx.raw / 3600)}h ${Math.round((ctx.raw % 3600) / 60)}m` } }
                        }
                    }
                });
            } else {
                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.history.map(d => d.date),
                        datasets: [{ label: 'Sleep Score', data: data.history.map(d => d.score), borderColor: '#818cf8', backgroundColor: 'rgba(129, 140, 248, 0.1)', borderWidth: 3, fill: true, tension: 0.3, pointRadius: 4 }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } } },
                        scales: {
                            x: { type: 'time', time: { unit: 'day' }, grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { min: 0, max: 100, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }

        let currentHydrationRange = '1d';
        let currentHydrationEndDate = new Date();
        async function updateHydrationRange(range, btn) {
            if (range) currentHydrationRange = range;
            if (btn) { btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
            const donut = document.getElementById('hydration-donut-container');
            const hChartCanvas = document.getElementById('hydrationHistoryChart');
            if (donut) donut.style.display = currentHydrationRange === '1d' ? 'block' : 'none';
            if (hChartCanvas) hChartCanvas.style.display = currentHydrationRange === '1d' ? 'none' : 'block';
            updateNavButtons('hydration', currentHydrationEndDate);
            await renderHydrationVisual();
        }

        async function renderHydrationVisual() {
            try {
                const res = await fetch(`/api/hydration_history?range=${currentHydrationRange}&end_date=${getLocalDateStr(currentHydrationEndDate)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.error) return;
                    const oz = (ml) => (ml * 0.033814).toFixed(1);
                    if (currentHydrationRange === '1d') {
                        const p = Math.min(100, Math.round((data.summary.intake / data.summary.goal) * 100));
                        safeSetText('hydration-val', oz(data.summary.intake) + ' oz');
                        safeSetText('hydration-goal', 'Goal: ' + oz(data.summary.goal) + ' oz');
                        safeSetText('hydration-percent', p + '%');
                        const hChart = document.getElementById('hydration-chart');
                        if (hChart) hChart.style.background = `conic-gradient(${p >= 100 ? '#22c55e' : '#38bdf8'} ${p}%, rgba(255,255,255,0.05) ${p}% 100%)`;
                    } else {
                        const ctx = document.getElementById('hydrationHistoryChart').getContext('2d');
                        if (chartInstances['hydrationHistoryChart']) chartInstances['hydrationHistoryChart'].destroy();
                        chartInstances['hydrationHistoryChart'] = new Chart(ctx, {
                            type: 'bar',
                            data: { labels: data.history.map(d => parseLocalDate(d.date).toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' })), datasets: [{ label: 'oz', data: data.history.map(d => parseFloat(oz(d.intake))), backgroundColor: data.history.map(d => d.intake >= d.goal ? '#22c55e' : '#38bdf8'), borderRadius: 6 }] },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: {
                                    zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } },
                                    legend: { display: false }
                                },
                                scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { grid: { display: false } } }
                            }
                        });
                    }
                }
            } catch (err) { console.error('Hydration error:', err); }
        }

        function updateNavButtons(metric, endDate) {
            const nextBtn = document.getElementById(`${metric}-next`);
            if (nextBtn) {
                const todayStr = getLocalDateStr(new Date());
                const endStr = getLocalDateStr(endDate);
                nextBtn.disabled = (endStr >= todayStr);
            }
        }

        function shiftStepsDate(dir) {
            const shift = currentStepsRange === '1d' ? 1 : (currentStepsRange === '1w' ? 7 : (currentStepsRange === '1m' ? 30 : 365));
            currentStepsEndDate.setDate(currentStepsEndDate.getDate() + (dir * shift));
            if (currentStepsEndDate > new Date()) currentStepsEndDate = new Date();
            updateNavButtons('steps', currentStepsEndDate);
            updateStepsRange();
        }

        function shiftSleepDate(dir) {
            const shift = currentSleepRange === '1d' ? 1 : (currentSleepRange === '1w' ? 7 : (currentSleepRange === '1m' ? 30 : 365));
            currentSleepEndDate.setDate(currentSleepEndDate.getDate() + (dir * shift));
            if (currentSleepEndDate > new Date()) currentSleepEndDate = new Date();
            updateNavButtons('sleep', currentSleepEndDate);
            updateSleepRange();
        }

        function shiftHydrationDate(dir) {
            const shift = currentHydrationRange === '1d' ? 1 : (currentHydrationRange === '1w' ? 7 : (currentHydrationRange === '1m' ? 30 : 365));
            currentHydrationEndDate.setDate(currentHydrationEndDate.getDate() + (dir * shift));
            if (currentHydrationEndDate > new Date()) currentHydrationEndDate = new Date();
            updateNavButtons('hydration', currentHydrationEndDate);
            renderHydrationVisual();
        }

        function shiftHRDate(dir) {
            const shift = currentHRRange === '1d' ? 1 : (currentHRRange === '1w' ? 7 : (currentHRRange === '1m' ? 30 : 365));
            currentHREndDate.setDate(currentHREndDate.getDate() + (dir * shift));
            if (currentHREndDate > new Date()) currentHREndDate = new Date();
            updateNavButtons('hr', currentHREndDate);
            updateHRRange();
        }

        function shiftStressDate(dir) {
            const shift = currentStressRange === '1d' ? 1 : (currentStressRange === '1w' ? 7 : (currentStressRange === '1m' ? 30 : 365));
            currentStressEndDate.setDate(currentStressEndDate.getDate() + (dir * shift));
            if (currentStressEndDate > new Date()) currentStressEndDate = new Date();
            updateNavButtons('stress', currentStressEndDate);
            updateStressRange();
        }

        function shiftWeightDate(dir) {
            const shift = currentWeightRange === '1m' ? 30 : (currentWeightRange === '6m' ? 180 : 365);
            currentWeightEndDate.setDate(currentWeightEndDate.getDate() + (dir * shift));
            if (currentWeightEndDate > new Date()) currentWeightEndDate = new Date();
            updateNavButtons('weight', currentWeightEndDate);
            updateWeightRange();
        }

        // --- Activity Modal & Detail Charts ---

        async function openActivityDetail(id, basic) {
            const modal = document.getElementById('activityModal');
            if (!modal) return;
            modal.classList.add('active');

            const isRun = basic.activityType.typeKey.toLowerCase().includes('run');
            const isCycle = basic.activityType.typeKey.toLowerCase().includes('cycling') || basic.activityType.typeKey.toLowerCase().includes('ride');

            safeSetText('modal-title', basic.activityName);
            safeSetText('modal-date', new Date(basic.startTimeLocal).toLocaleString());
            safeSetText('modal-distance', formatDualDistance(basic.distance / 1609.34));
            safeSetText('modal-duration', Math.round(basic.duration / 60) + ' min');
            safeSetText('modal-hr', basic.averageHR ? Math.round(basic.averageHR) + ' bpm' : '--');
            safeSetText('modal-calories', Math.round(basic.calories) + ' kcal');

            // Immediate population from basic summary data
            if (basic.elevationGain !== undefined) {
                const gainFeet = Math.round(basic.elevationGain * 3.28084);
                const gainMeters = Math.round(basic.elevationGain);
                safeSetText('modal-elevation', `${gainFeet} ft / ${gainMeters} m`);
            } else {
                safeSetText('modal-elevation', '--');
            }

            const basicCadence = basic.averageBikingCadenceInRevPerMinute || basic.averageRunningCadenceInStepsPerMinute || basic.averageCadence;
            if (basicCadence) {
                safeSetText('modal-cadence', Math.round(basicCadence) + (isRun ? ' spm' : ' rpm'));
            } else {
                safeSetText('modal-cadence', '--');
            }

            // Initial pace/speed from basic data
            if (isCycle) {
                safeSetText('modal-pace-label', 'Avg Speed');
                const mph = (basic.averageSpeed * 2.23694).toFixed(1);
                safeSetText('modal-pace', mph + ' mph');
            } else {
                safeSetText('modal-pace-label', 'Overall Pace');
                safeSetText('modal-pace', '--');
            }

            try {
                const res = await fetch(`/api/activity/${id}`);
                if (res.ok) {
                    const data = await res.json();
                    if (!data.error) {
                        const hasPower = data.charts.power && data.charts.power.length > 0 && data.charts.power.some(p => p > 0);
                        const powerCard = document.getElementById('power-summary-card');
                        const powerChartBox = document.getElementById('power-chart-container');
                        const powerTitle = document.getElementById('power-title');

                        if (powerCard) powerCard.style.display = hasPower ? 'block' : 'none';
                        if (powerChartBox) powerChartBox.style.display = hasPower ? 'block' : 'none';
                        if (powerTitle) powerTitle.style.display = hasPower ? 'block' : 'none';

                        if (hasPower && data.summary.averagePower) {
                            safeSetText('modal-power', Math.round(data.summary.averagePower) + ' W');
                        }

                        // Update with refined data if available
                        if (data.summary.elevationGain !== undefined) {
                            const gainFeet = Math.round(data.summary.elevationGain * 3.28084);
                            const gainMeters = Math.round(data.summary.elevationGain);
                            safeSetText('modal-elevation', `${gainFeet} ft / ${gainMeters} m`);
                        }

                        const avgCadence = data.summary.averageBikeCadence || data.summary.averageRunCadence || data.summary.averageCadence ||
                            data.summary.averageBikingCadenceInRevPerMinute || data.summary.averageRunningCadenceInStepsPerMinute;
                        if (avgCadence) {
                            safeSetText('modal-cadence', Math.round(avgCadence) + (isRun ? ' spm' : ' rpm'));
                        }

                        // Refined pace/speed if detailed data is available
                        if (!isCycle) {
                            safeSetText('modal-pace', data.avg_pace_str || '--');
                        }

                        renderActivityCharts(data.charts, isRun, isCycle);
                    }
                }
            } catch (err) { console.error('Activity detail error:', err); }
        }

        function closeModal() { document.getElementById('activityModal').classList.remove('active'); }

        const activityChartIds = ['activityElevChart', 'activityHrChart', 'activityCadenceChart', 'activityPowerChart', 'activitySpeedChart'];
        function syncActivityCharts(source) {
            const { min, max } = source.scales.x;
            activityChartIds.forEach(id => {
                const chart = chartInstances[id];
                if (chart && chart !== source) { chart.options.scales.x.min = min; chart.options.scales.x.max = max; chart.update('none'); }
            });
        }

        function renderActivityCharts(charts, isRun, isCycle) {
            if (!charts.timestamps) return;
            const start = new Date(charts.timestamps[0]).getTime();
            const elapsed = charts.timestamps.map(t => (new Date(t).getTime() - start) / 1000);

            renderDetailChart('activityElevChart', elapsed, charts.elevation.map(e => e * 3.28084), 'Elevation', '#94a3b8', 'ft');
            renderDetailChart('activityHrChart', elapsed, charts.heart_rate, 'Heart Rate', '#f87171', 'bpm');
            renderDetailChart('activityCadenceChart', elapsed, charts.cadence, isRun ? 'spm' : 'rpm', '#4ade80', '');

            if (charts.power && charts.power.length > 0) {
                renderDetailChart('activityPowerChart', elapsed, charts.power, 'Power', '#a855f7', 'W', false, getPowerZoneColor);
            }

            if (isRun) renderDetailChart('activitySpeedChart', elapsed, charts.speed.map(s => s > 0.5 ? 26.8224 / s : null), 'Pace', '#38bdf8', '/mi', true);
            else renderDetailChart('activitySpeedChart', elapsed, charts.speed.map(s => s * 2.23694), 'Speed', '#38bdf8', 'mph');
        }

        function renderDetailChart(id, x, y, label, color, unit, rev = false, colorFunc = null) {
            const canvas = document.getElementById(id);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chartInstances[id]) chartInstances[id].destroy();

            const dataset = {
                label,
                data: y,
                borderColor: color,
                backgroundColor: color + '22',
                fill: true,
                pointRadius: 0,
                tension: 0.4
            };

            if (colorFunc) {
                dataset.segment = {
                    borderColor: ctx => colorFunc(ctx.p1.parsed.y),
                    backgroundColor: ctx => colorFunc(ctx.p1.parsed.y) + '44' // ~25% opacity
                };
            }

            chartInstances[id] = new Chart(ctx, {
                type: 'line',
                data: { labels: x, datasets: [dataset] },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: { legend: { display: false }, zoom: { pan: { enabled: true, mode: 'x', onPan: (c) => syncActivityCharts(c.chart) }, zoom: { wheel: { enabled: true }, mode: 'x', onZoom: (c) => syncActivityCharts(c.chart) } } },
                    scales: {
                        y: { reverse: rev, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', callback: v => v ? v.toFixed(1) + ' ' + unit : '' } },
                        x: { type: 'linear', ticks: { color: '#94a3b8', callback: v => formatDuration(v) }, grid: { display: false } }
                    }
                }
            });
        }

        function getPowerZoneColor(p) {
            if (p >= 450) return '#a855f7'; // Purple
            if (p >= 350) return '#ef4444'; // Red
            if (p >= 300) return '#f97316'; // Orange
            if (p >= 250) return '#eab308'; // Yellow
            if (p >= 200) return '#22c55e'; // Green
            if (p >= 150) return '#3b82f6'; // Blue
            return '#94a3b8'; // Grey
        }

        function formatDuration(s) {
            const h = Math.floor(s / 3600); const m = Math.floor((s % 3600) / 60); const sec = Math.floor(s % 60);
            return h > 0 ? `${h}:${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}` : `${m}:${sec.toString().padStart(2, '0')}`;
        }

        // --- Heatmap & Calendar Functions ---

        async function fetchActivityHeatmap() {
            try {
                const res = await fetch('/api/activity_heatmap');
                if (res.ok) renderActivityHeatmap(await res.json());
            } catch (err) { console.error('Heatmap error:', err); }
        }

        function renderActivityHeatmap(data) {
            const container = document.getElementById('activity-heatmap');
            if (!container) return;
            container.innerHTML = '';
            const today = new Date();
            const start = new Date(); start.setDate(today.getDate() - 365);
            start.setDate(start.getDate() - ((start.getDay() + 6) % 7)); // Start on Monday

            let currentWeek = [];
            let current = new Date(start);
            while (current <= today || current.getDay() !== 1) {
                const dStr = getLocalDateStr(current);
                currentWeek.push({ count: data[dStr] || 0 });
                if (current.getDay() === 0) {
                    const col = document.createElement('div'); col.style.display = 'flex'; col.style.flexDirection = 'column'; col.style.gap = '4px';
                    currentWeek.forEach(day => {
                        const cell = document.createElement('div'); cell.style.width = '12px'; cell.style.height = '12px'; cell.style.borderRadius = '2px';
                        cell.style.background = day.count === 0 ? 'rgba(255,255,255,0.05)' : day.count === 1 ? 'rgba(34, 197, 94, 0.4)' : day.count === 2 ? 'rgba(34, 197, 94, 0.7)' : '#22c55e';
                        col.appendChild(cell);
                    });
                    container.appendChild(col);
                    currentWeek = [];
                }
                current.setDate(current.getDate() + 1);
            }
            const scroll = document.getElementById('heatmap-scroll-container');
            if (scroll) scroll.scrollLeft = scroll.scrollWidth;
        }

        let calendarDate = new Date();
        let currentCalendarView = 'month';

        async function fetchCalendarData() {
            let startStr, endStr;
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();

            if (currentCalendarView === 'year') {
                startStr = `${year}-01-01`; endStr = `${year}-12-31`;
            } else if (currentCalendarView === 'month') {
                const first = new Date(year, month, 1);
                const last = new Date(year, month + 1, 0);
                const startPad = (first.getDay() + 6) % 7;
                const endPad = 6 - ((last.getDay() + 6) % 7);
                startStr = getLocalDateStr(new Date(year, month, 1 - startPad));
                endStr = getLocalDateStr(new Date(year, month + 1, endPad));
            } else {
                const day = calendarDate.getDay();
                const diff = calendarDate.getDate() - day + (day == 0 ? -6 : 1);
                const start = new Date(calendarDate); start.setDate(diff);
                const end = new Date(start); end.setDate(start.getDate() + 6);
                startStr = getLocalDateStr(start); endStr = getLocalDateStr(end);
            }

            try {
                const res = await fetch(`/api/calendar_activities?start_date=${startStr}&end_date=${endStr}`);
                if (res.ok) {
                    const activities = await res.json();
                    renderDetailedCalendar(activities, year, month);
                }
            } catch (e) { console.error("Calendar fetch error", e); }
        }

        function setCalendarView(view) {
            currentCalendarView = view;
            document.querySelectorAll('.calendar-widget .range-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`cal-view-${view}`);
            if (btn) btn.classList.add('active');
            fetchCalendarData();
        }

        function shiftCalendarMonth(dir) {
            if (currentCalendarView === 'year') calendarDate.setFullYear(calendarDate.getFullYear() + dir);
            else if (currentCalendarView === 'month') calendarDate.setMonth(calendarDate.getMonth() + dir);
            else calendarDate.setDate(calendarDate.getDate() + (dir * 7));
            fetchCalendarData();
        }

        function resetCalendarToToday() { calendarDate = new Date(); fetchCalendarData(); }

        function renderDetailedCalendar(activities, currentYear, currentMonth) {
            const titleEl = document.getElementById('calendar-title');
            if (titleEl) {
                if (currentCalendarView === 'year') titleEl.textContent = currentYear;
                else if (currentCalendarView === 'month') titleEl.textContent = `${calendarDate.toLocaleString('default', { month: 'long' })} ${currentYear}`;
                else {
                    const start = new Date(calendarDate); const day = calendarDate.getDay();
                    start.setDate(calendarDate.getDate() - day + (day == 0 ? -6 : 1));
                    const end = new Date(start); end.setDate(start.getDate() + 6);
                    titleEl.textContent = `${start.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })} - ${end.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })} ${end.getFullYear()}`;
                }
            }

            const grid = document.getElementById('calendar-grid');
            if (!grid) return;
            grid.className = currentCalendarView === 'year' ? 'year-view-grid' : 'calendar-grid';
            grid.innerHTML = '';

            const activitiesByDate = {};
            activities.forEach(act => {
                const dateStr = act.startTimeLocal.split(' ')[0];
                if (!activitiesByDate[dateStr]) activitiesByDate[dateStr] = [];
                activitiesByDate[dateStr].push(act);
            });

            if (currentCalendarView === 'year') {
                renderYearView(grid, activitiesByDate, currentYear);
            } else if (currentCalendarView === 'month') {
                const first = new Date(currentYear, currentMonth, 1);
                const startPad = (first.getDay() + 6) % 7;
                const startDate = new Date(currentYear, currentMonth, 1 - startPad);
                for (let i = 0; i < 42; i++) {
                    const d = new Date(startDate); d.setDate(d.getDate() + i);
                    const dateStr = getLocalDateStr(d);
                    const cell = document.createElement('div');
                    cell.className = `calendar-cell ${dateStr === getLocalDateStr(new Date()) ? 'today' : ''} ${d.getMonth() !== currentMonth ? 'other-month' : ''}`;
                    cell.innerHTML = `<div class="calendar-date">${d.getDate()}</div>`;
                    if (activitiesByDate[dateStr]) {
                        activitiesByDate[dateStr].forEach(act => {
                            const pill = document.createElement('div');
                            pill.className = `activity-pill ${getActivityPillClass(act.activityType.typeKey)}`;
                            pill.innerHTML = `<span>${getActivityIcon(act.activityType.typeKey)}</span> ${act.distance > 0 ? (act.distance * 0.000621371).toFixed(1) + 'mi' : Math.round(act.duration / 60) + 'm'}`;
                            cell.appendChild(pill);
                        });
                    }
                    grid.appendChild(cell);
                }
            } else {
                // Week view
                const start = new Date(calendarDate); const day = calendarDate.getDay();
                start.setDate(calendarDate.getDate() - day + (day == 0 ? -6 : 1));
                for (let i = 0; i < 7; i++) {
                    const d = new Date(start); d.setDate(d.getDate() + i);
                    const dateStr = getLocalDateStr(d);
                    const cell = document.createElement('div');
                    cell.className = 'calendar-cell view-week';
                    cell.innerHTML = `<div class="calendar-date">${d.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' })}</div>`;
                    if (activitiesByDate[dateStr]) {
                        activitiesByDate[dateStr].forEach(act => {
                            const pill = document.createElement('div');
                            pill.className = `activity-pill ${getActivityPillClass(act.activityType.typeKey)}`;
                            pill.innerHTML = `<strong>${act.activityName}</strong><br>${act.distance > 0 ? (act.distance * 0.000621371).toFixed(2) + ' mi' : ''} | ${(act.duration / 60).toFixed(0)}m`;
                            cell.appendChild(pill);
                        });
                    }
                    grid.appendChild(cell);
                }
            }
            updateCalendarTotals(activities, currentYear, currentMonth);
        }

        function renderYearView(container, data, year) {
            for (let m = 0; m < 12; m++) {
                const monthDiv = document.createElement('div'); monthDiv.className = 'small-month';
                const mName = new Date(year, m, 1).toLocaleString('default', { month: 'short' });
                monthDiv.innerHTML = `<div class="small-month-title">${mName}</div>`;
                const mGrid = document.createElement('div'); mGrid.className = 'small-month-grid';
                const first = new Date(year, m, 1); const pad = (first.getDay() + 6) % 7;
                for (let p = 0; p < pad; p++) mGrid.appendChild(document.createElement('div'));
                const last = new Date(year, m + 1, 0).getDate();
                for (let d = 1; d <= last; d++) {
                    const dateStr = getLocalDateStr(new Date(year, m, d));
                    const dayEl = document.createElement('div'); dayEl.className = 'small-day'; dayEl.textContent = d;
                    if (data[dateStr]) {
                        const dot = document.createElement('div'); dot.className = 'day-dot';
                        dot.style.background = getActivityColor(data[dateStr][0].activityType.typeKey);
                        dayEl.appendChild(dot);
                    }
                    mGrid.appendChild(dayEl);
                }
                monthDiv.appendChild(mGrid); container.appendChild(monthDiv);
            }
        }

        function getActivityPillClass(type) {
            if (type.includes('running')) return 'act-running';
            if (type.includes('virtual_ride')) return 'act-virtual-ride';
            if (type.includes('cycling') || type.includes('ride')) return 'act-cycling';
            if (type.includes('swimming')) return 'act-swimming';
            if (type.includes('walking')) return 'act-walking';
            if (type.includes('strength')) return 'act-strength';
            return 'act-other';
        }

        function getActivityColor(type) {
            if (type.includes('running')) return '#3b82f6';
            if (type.includes('virtual_ride')) return '#f59e0b';
            if (type.includes('cycling') || type.includes('ride')) return '#f97316';
            if (type.includes('swimming')) return '#06b6d4';
            return '#64748b';
        }

        function updateCalendarTotals(activities, currentYear, currentMonth) {
            const container = document.getElementById('calendar-totals');
            if (!container) return;
            container.innerHTML = '';
            let totals = { count: 0, distance: 0, duration: 0, types: {} };

            activities.forEach(act => {
                const date = parseLocalDate(act.startTimeLocal.split(' ')[0]);
                const inRange = (currentCalendarView === 'year') ||
                    (currentCalendarView === 'month' && date.getMonth() === currentMonth) ||
                    (currentCalendarView === 'week');

                if (inRange) {
                    totals.count++;
                    totals.distance += act.distance || 0;
                    totals.duration += act.duration || 0;
                    const type = act.activityType.typeKey;
                    if (!totals.types[type]) totals.types[type] = { count: 0, distance: 0, time: 0 };
                    totals.types[type].count++;
                    totals.types[type].distance += act.distance || 0;
                    totals.types[type].time += act.duration || 0;
                }
            });

            container.innerHTML += `
                <div class="total-card">
                    <div class="total-type" style="font-size: 1.1rem; margin-bottom: 1rem;">Summary</div>
                    <div class="total-value-row"><span>Activities</span><span>${totals.count}</span></div>
                    <div class="total-value-row"><span>Distance</span><span>${(totals.distance * 0.000621371).toFixed(1)} mi</span></div>
                    <div class="total-value-row"><span>Time</span><span>${Math.floor(totals.duration / 3600)}h ${Math.round((totals.duration % 3600) / 60)}m</span></div>
                </div>`;

            Object.keys(totals.types).forEach(type => {
                const data = totals.types[type];
                container.innerHTML += `
                    <div class="total-card" style="border-left: 4px solid ${getActivityColor(type)};">
                        <div class="total-type">${type.replace(/_/g, ' ')}</div>
                        <div class="total-value-row"><span>Count</span><span>${data.count}</span></div>
                        <div class="total-value-row"><span>Distance</span><span>${(data.distance * 0.000621371).toFixed(1)} mi</span></div>
                    </div>`;
            });
        }

        function openWeightModal() { document.getElementById('weightModal').classList.add('active'); }
        function closeWeightModal() { document.getElementById('weightModal').classList.remove('active'); }
        async function submitWeight() {
            const val = parseFloat(document.getElementById('weight-input').value);
            const unit = document.querySelector('input[name="weight-unit"]:checked').value;
            if (!val) return;
            try {
                const res = await fetch('/api/add_weight', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ weight: unit === 'lbs' ? val / 2.20462 : val }) });
                if (res.ok) { closeWeightModal(); fetchData(); }
            } catch (err) { console.error('Add weight error:', err); }
        }

        function renderIntensityMinutesVisualV2(data) {
            const canvasId = 'imHistoryChart';
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            const range = data.range || currentIMRange;
            const history = data.history || [];
            const goal = data.goal || 150;

            if (history.length > 0) {
                let thisWeekTotal = 0;
                for (let i = history.length - 1; i >= 0; i--) {
                    const d = history[i];
                    const dt = parseLocalDate(d.date);
                    thisWeekTotal += d.total;
                    if (dt.getDay() === 1) break;
                }
                safeSetText('im-val', thisWeekTotal);
                safeSetText('im-goal', goal);
            }

            if (range === '1d') {
                const points = data.samples.map(s => ({ x: s[0], y: s[1] }));
                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Intensity Minutes',
                            data: points,
                            borderColor: '#38bdf8',
                            backgroundColor: 'rgba(56, 189, 248, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { type: 'time', time: { displayFormats: { hour: 'HH:mm' } }, grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            } else if (range === '1w' || range === '1m') {
                const weeks_seg = [];
                let curWeek = [];
                history.forEach(d => {
                    const dt = parseLocalDate(d.date);
                    if (dt.getDay() === 1 && curWeek.length > 0) {
                        weeks_seg.push(curWeek);
                        curWeek = [];
                    }
                    curWeek.push(d);
                });
                if (curWeek.length > 0) weeks_seg.push(curWeek);

                const dsLabels = history.map(d => {
                    const dt = parseLocalDate(d.date);
                    if (dt.getDay() === 1) return dt.toLocaleDateString([], { month: 'short', day: 'numeric' });
                    if (range === '1w') return dt.toLocaleDateString([], { weekday: 'short' });
                    return '';
                });

                const dsDatasets = weeks_seg.map((week, idx) => {
                    let cumulative = 0;
                    const weekData = history.map(h => {
                        const dayInWeek = week.find(w => w.date === h.date);
                        if (dayInWeek) {
                            cumulative += dayInWeek.total;
                            return cumulative;
                        }
                        return null;
                    });
                    const isGoalMet = cumulative >= goal;
                    const color = isGoalMet ? '#4ade80' : '#38bdf8';
                    return {
                        label: `Week ${idx + 1}`,
                        data: weekData,
                        borderColor: color,
                        borderWidth: 3,
                        pointRadius: 0,
                        stepped: 'before',
                        fill: false,
                        spanGaps: false
                    };
                });

                dsDatasets.push({
                    label: 'Weekly Goal',
                    data: history.map(() => goal),
                    borderColor: 'rgba(255, 255, 255, 0.3)',
                    borderDash: [5, 5],
                    borderWidth: 1.5,
                    pointRadius: 0,
                    fill: false,
                    order: 0
                });

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: { labels: dsLabels, datasets: dsDatasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', autoSkip: false } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            } else {
                const lw = history[history.length - 1];
                safeSetText('im-val', lw ? lw.total : '--');
                safeSetText('im-goal', lw ? lw.goal : '150');
                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: history.map((d, i) => (i % 4 === 0) ? parseLocalDate(d.date).toLocaleDateString([], { month: 'short', day: 'numeric' }) : ''),
                        datasets: [{
                            label: 'Weekly Total',
                            data: history.map(d => d.total),
                            backgroundColor: history.map(d => d.total >= d.goal ? '#4ade80' : '#38bdf8'),
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94a3b8', autoSkip: false } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }

        // Start everything
        fetchData();

        window.addEventListener('resize', () => {
            Object.values(chartInstances).forEach(chart => { chart.update(); });
        });
    </script>
</body>

</html>