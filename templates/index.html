<!DOCTYPE html>

<html lang="en">

<head>

    <meta charset="UTF-8">

    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <title>Aaron's Fitness Dashboard</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">

    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>

    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=Lexend:wght@300;400;500;600&display=swap"
        rel="stylesheet">

    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.1/dist/chart.umd.min.js"></script>

    <script
        src="https://cdn.jsdelivr.net/npm/chartjs-adapter-date-fns/dist/chartjs-adapter-date-fns.bundle.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/hammerjs@2.0.8/hammer.min.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chartjs-plugin-zoom@2.0.1/dist/chartjs-plugin-zoom.min.js"></script>

    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">

    <!-- Leaflet for Maps -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
        integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin="" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
        integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.heat/0.2.0/leaflet-heat.js"></script>

    <!-- MarkerCluster -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.css" />
    <link rel="stylesheet" href="https://unpkg.com/leaflet.markercluster@1.4.1/dist/MarkerCluster.Default.css" />
    <script src="https://unpkg.com/leaflet.markercluster@1.4.1/dist/leaflet.markercluster.js"></script>

    <style>
        /* Custom Cluster Styles for Dark Mode */
        .marker-cluster-small,
        .marker-cluster-medium,
        .marker-cluster-large {
            background-color: rgba(56, 189, 248, 0.6) !important;
            /* Sky blue */
        }

        .marker-cluster div {
            background-color: rgba(15, 23, 42, 0.9) !important;
            /* Slate 900 */
            color: white !important;
            font-family: 'Inter', sans-serif;
            font-weight: bold;
        }

        .grouped-badge {
            background: var(--accent-color);
            color: #0f172a;
            font-size: 0.65rem;
            font-weight: 700;
            padding: 0.1rem 0.4rem;
            border-radius: 1rem;
            text-transform: uppercase;
            letter-spacing: 0.02em;
        }

        .activity-item.grouped-session {
            border-left: 3px solid var(--accent-color);
        }
    </style>
</head>

<body>

    <div class="container">

        <header>

            <h1>Aaron's Fitness Dashboard</h1>

            <div style="display: flex; align-items: center; gap: 1rem;">
                <div id="last-sync" class="last-sync">Syncing...</div>
                <button onclick="openSettings()"
                    style="background: var(--card-bg); border: 1px solid rgba(255,255,255,0.1); color: var(--text-primary); padding: 0.5rem; border-radius: 0.5rem; cursor: pointer; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.2s;"
                    onmouseover="this.style.background='rgba(56, 189, 248, 0.1)'"
                    onmouseout="this.style.background='var(--card-bg)'">
                    <span style="font-size: 1.2rem;">‚öôÔ∏è</span>
                    <span>Settings</span>
                </button>
                <a href="{{ url_for('logout') }}"
                    style="background: rgba(248, 113, 113, 0.1); border: 1px solid rgba(248, 113, 113, 0.2); color: #f87171; padding: 0.5rem 1rem; border-radius: 0.5rem; cursor: pointer; text-decoration: none; display: flex; align-items: center; gap: 0.5rem; font-size: 0.9rem; transition: all 0.2s;"
                    onmouseover="this.style.background='rgba(248, 113, 113, 0.2)'"
                    onmouseout="this.style.background='rgba(248, 113, 113, 0.1)'">
                    <span>Logout</span>
                </a>
            </div>

        </header>

        <div id="error-message"
            style="display: none; color: #f87171; background: rgba(248, 113, 113, 0.1); padding: 1rem; border-radius: 0.5rem; margin-bottom: 2rem;">

        </div>

        <!-- AI Training Insights -->
        <div class="ai-insights-container" id="ai-insights-section" style="display: none;">
            <div class="ai-card">
                <div class="ai-header">
                    <div class="ai-badge">
                        <div class="pulse-dot"></div>
                        <span id="ai-insight-title">AI Training Insight</span>
                    </div>
                    <div id="ai-model-name"
                        style="font-size: 0.7rem; color: var(--text-secondary); font-style: italic;"></div>
                </div>
                <div class="ai-grid" id="ai-content-grid">
                    <div class="insight-section">
                        <h3>Daily Summary</h3>
                        <div class="insight-content" id="ai-daily-summary">
                            Generating your daily summary...
                        </div>
                    </div>
                    <div class="insight-section">
                        <h3>Yesterday's Recap</h3>
                        <div class="insight-content" id="ai-yesterday-summary">
                            Summarizing yesterday...
                        </div>
                    </div>
                    <div class="insight-section">
                        <h3>Optimization Suggestions</h3>
                        <div class="insight-content" id="ai-suggestions">
                            Analyzing your metrics for improvements...
                        </div>
                    </div>
                </div>

                <!-- Thinking State -->
                <div id="ai-thinking" class="ai-think-container">
                    <div class="ai-scan-line"></div>
                    <div class="ai-message" id="ai-loading-msg">Processing biometric data streams...</div>
                    <div style="font-size: 0.8rem; color: var(--text-secondary);">Athlete Intelligence is optimizing
                        your performance profile.</div>
                </div>

                <!-- Error State -->
                <div id="ai-error" class="ai-error-container">
                    <div class="ai-error-icon">‚ö†Ô∏è</div>
                    <div class="ai-error-title" id="ai-err-title">Analysis Interrupted</div>
                    <div class="ai-error-details" id="ai-err-details">Something went wrong while connecting to the elite
                        analyst core.</div>
                    <button onclick="fetchAIInsights()"
                        style="margin-top: 1rem; background: var(--accent-color); color: white; border: none; padding: 0.5rem 1.5rem; border-radius: 0.5rem; cursor: pointer; font-weight: 600;">Retry
                        Analysis</button>
                </div>
            </div>
        </div>

        <h2 style="margin-bottom: 1.5rem; font-size: 1.5rem;">Daily Health</h2>

        <div class="health-grid">

            <!-- Steps -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <div>

                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">Steps</h2>

                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">

                            <div class="metric-value" style="font-size: 2rem; margin-bottom: 0;"><span
                                    id="steps">--</span></div>

                            <div class="metric-unit" id="steps-goal-text" style="font-size: 0.8rem;">/ 10k</div>

                        </div>

                    </div>

                    <div style="text-align: right;">

                        <div style="font-size: 0.7rem; color: var(--text-secondary);">Streak</div>

                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--success-color);"><span
                                id="steps-streak">--</span></div>

                    </div>

                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">

                    <div class="range-selector" style="display: inline-flex; padding: 0.2rem;">

                        <button class="range-btn" onclick="updateStepsRange('1d', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1d</button>

                        <button class="range-btn active" onclick="updateStepsRange('1w', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1w</button>

                        <button class="range-btn" onclick="updateStepsRange('1m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1m</button>

                        <button class="range-btn" onclick="updateStepsRange('1y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1y</button>

                    </div>

                    <div style="flex-grow:1"></div>

                    <button class="nav-btn" id="steps-prev" onclick="shiftStepsDate(-1)"
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg></button>

                    <button class="nav-btn" id="steps-next" onclick="shiftStepsDate(1)" disabled
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg></button>

                </div>

                <div id="steps-visual-container" class="chart-container"
                    style="min-height: 200px; padding: 0; background: transparent; border: none; box-shadow: none;">

                    <canvas id="stepsHistoryChart"></canvas>

                    <div id="steps-donut-container"
                        style="display: none; width: 100%; height: 100%; position: relative;">

                        <!-- Donut logic kept, just resized via CSS or inline -->

                        <div class="donut-chart" id="steps-day-chart"
                            style="width: 140px; height: 140px; margin: 0 auto;">

                            <div class="donut-inner" style="width: 110px; height: 110px;">

                                <span class="donut-percent" id="steps-day-percent" style="font-size: 1.5rem;">0%</span>

                            </div>

                        </div>

                    </div>

                </div>

            </div>

            <!-- Sleep -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <div>

                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">Sleep</h2>

                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">

                            <div class="metric-value" style="font-size: 2rem; margin-bottom: 0;"><span
                                    id="sleep">--</span><span class="metric-unit">h</span></div>

                            <div class="metric-unit">Score: <span id="sleep-score-val">--</span></div>

                        </div>

                    </div>

                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">

                    <div class="range-selector" style="display: inline-flex; padding: 0.2rem;">

                        <button class="range-btn active" onclick="updateSleepRange('1d', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1d</button>

                        <button class="range-btn" onclick="updateSleepRange('1w', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1w</button>

                        <button class="range-btn" onclick="updateSleepRange('1m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1m</button>

                        <button class="range-btn" onclick="updateSleepRange('1y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1y</button>

                    </div>

                    <div style="flex-grow:1"></div>

                    <button class="nav-btn" id="sleep-prev" onclick="shiftSleepDate(-1)"
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg></button>

                    <button class="nav-btn" id="sleep-next" onclick="shiftSleepDate(1)" disabled
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg></button>

                </div>

                <div id="sleep-visual-container" class="chart-container"
                    style="min-height: 200px; padding: 0; background: transparent; border: none; box-shadow: none;">

                    <canvas id="sleepHistoryChart"></canvas>

                </div>

            </div>

            <!-- Hydration -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <div>

                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">Hydration</h2>

                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">

                            <div class="metric-value" style="font-size: 2rem; margin-bottom: 0;"><span
                                    id="hydration-val">--</span></div>

                            <div class="metric-unit">oz</div>

                        </div>

                    </div>

                    <div style="text-align: right;">

                        <div id="hydration-goal" style="font-size: 0.8rem; color: var(--text-secondary);">Goal: -- oz

                        </div>

                    </div>

                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">

                    <div class="range-selector" style="display: inline-flex; padding: 0.2rem;">

                        <button class="range-btn active" onclick="updateHydrationRange('1d', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1d</button>

                        <button class="range-btn" onclick="updateHydrationRange('1w', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1w</button>

                        <button class="range-btn" onclick="updateHydrationRange('1m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1m</button>

                        <button class="range-btn" onclick="updateHydrationRange('1y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1y</button>

                    </div>

                    <div style="flex-grow:1"></div>

                    <button class="nav-btn" id="hydration-prev" onclick="shiftHydrationDate(-1)"
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg></button>

                    <button class="nav-btn" id="hydration-next" onclick="shiftHydrationDate(1)" disabled
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg></button>

                </div>

                <div id="hydration-visual-container" class="chart-container"
                    style="min-height: 200px; padding: 0; background: transparent; border: none; box-shadow: none;">

                    <canvas id="hydrationHistoryChart"></canvas>

                    <div id="hydration-donut-container"
                        style="display: none; width: 100%; height: 100%; position: relative;">

                        <div class="donut-chart" id="hydration-chart"
                            style="width: 140px; height: 140px; margin: 0 auto;">

                            <div class="donut-inner" style="width: 110px; height: 110px;">

                                <span class="donut-percent" id="hydration-percent" style="font-size: 1.5rem;">0%</span>

                            </div>

                        </div>

                    </div>

                </div>

            </div>

            <!-- Heart Rate -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <div>

                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">Heart Rate</h2>

                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">

                            <div class="metric-value" style="font-size: 2rem; margin-bottom: 0;"><span
                                    id="rhr">--</span></div>

                            <div class="metric-unit">RHR</div>

                        </div>

                    </div>

                    <div style="text-align: right;">

                        <div style="font-size: 0.7rem; color: var(--text-secondary);">Max</div>

                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--danger-color);"><span
                                id="hr-max-val">--</span></div>

                    </div>

                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">

                    <div class="range-selector" style="display: inline-flex; padding: 0.2rem;">

                        <button class="range-btn active" onclick="updateHRVRange('1d', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1d</button>

                        <button class="range-btn" onclick="updateHRVRange('1w', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1w</button>

                        <button class="range-btn" onclick="updateHRVRange('1m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1m</button>

                        <button class="range-btn" onclick="updateHRVRange('1y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1y</button>

                    </div>

                    <div style="flex-grow:1"></div>

                    <button class="nav-btn" id="hr-prev" onclick="shiftHRDate(-1)" style="width:24px; height:24px;"><svg
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg></button>

                    <button class="nav-btn" id="hr-next" onclick="shiftHRDate(1)" disabled
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg></button>

                </div>

                <div id="hr-visual-container" class="chart-container"
                    style="min-height: 200px; padding: 0; background: transparent; border: none; box-shadow: none;">

                    <canvas id="hrHistoryChart"></canvas>

                </div>

            </div>

            <!-- Stress -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <div>

                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">Stress</h2>

                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">

                            <div class="metric-value" style="font-size: 2rem; margin-bottom: 0;"><span
                                    id="stress">--</span></div>

                            <div class="metric-unit">Avg</div>

                        </div>

                    </div>

                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">

                    <div class="range-selector" style="display: inline-flex; padding: 0.2rem;">

                        <button class="range-btn active" onclick="updateStressRange('1d', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1d</button>

                        <button class="range-btn" onclick="updateStressRange('1w', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1w</button>

                        <button class="range-btn" onclick="updateStressRange('1m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1m</button>

                        <button class="range-btn" onclick="updateStressRange('1y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1y</button>

                    </div>

                    <div style="flex-grow:1"></div>

                    <button class="nav-btn" id="stress-prev" onclick="shiftStressDate(-1)"
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg></button>

                    <button class="nav-btn" id="stress-next" onclick="shiftStressDate(1)" disabled
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg></button>

                </div>

                <div style="height: 200px;">

                    <canvas id="stressHistoryChart"></canvas>

                </div>

            </div>

            <!-- HRV Status -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <div>

                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">HRV Status</h2>

                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">

                            <div class="metric-value" style="font-size: 2rem; margin-bottom: 0;"><span
                                    id="hrv-val">--</span></div>

                            <div class="metric-unit">ms (Avg)</div>

                        </div>

                    </div>

                    <div style="text-align: right;">

                        <div id="hrv-status-badge" class="badge" style="margin-bottom: 0.25rem;">--</div>

                        <div id="hrv-weekly-avg" style="font-size: 0.75rem; color: var(--text-secondary);">7d Avg: -- ms
                        </div>

                    </div>

                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">

                    <div class="range-selector" style="display: inline-flex; padding: 0.2rem;">

                        <button class="range-btn active" onclick="updateHRVRange('1d', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1d</button>

                        <button class="range-btn" onclick="updateHRVRange('1w', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1w</button>

                        <button class="range-btn" onclick="updateHRVRange('1m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1m</button>

                        <button class="range-btn" onclick="updateHRVRange('1y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1y</button>

                    </div>

                    <div style="flex-grow:1"></div>

                    <button class="nav-btn" id="hrv-prev" onclick="shiftHRVDate(-1)"
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg></button>

                    <button class="nav-btn" id="hrv-next" onclick="shiftHRVDate(1)" disabled
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg></button>

                </div>

                <div id="hrv-visual-container" class="chart-container"
                    style="min-height: 200px; padding: 0; background: transparent; border: none; box-shadow: none;">

                    <canvas id="hrvHistoryChart" style="display: none;"></canvas>

                    <div id="hrv-status-container" style="margin-top: 1.5rem;">

                        <div
                            style="display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-secondary); margin-bottom: 0.5rem;">
                            <span>Baseline: <span id="hrv-baseline-low">--</span> - <span
                                    id="hrv-baseline-high">--</span>
                                ms</span>
                        </div>

                        <div class="hrv-gauge-container"
                            style="height: 12px; background: rgba(255,255,255,0.05); border-radius: 6px; position: relative; overflow: hidden; margin-bottom: 2rem;">
                            <div id="hrv-baseline-zone"
                                style="position: absolute; height: 100%; background: rgba(74, 222, 128, 0.2); left: 30%; width: 40%;">
                            </div>
                            <div id="hrv-marker"
                                style="position: absolute; height: 100%; width: 4px; background: var(--text-primary); border-radius: 2px; left: 0; transition: left 0.5s ease; box-shadow: 0 0 10px rgba(255,255,255,0.5); z-index: 2;">
                            </div>
                        </div>

                        <div id="hrv-feedback"
                            style="font-size: 0.85rem; color: var(--text-secondary); line-height: 1.4; min-height: 3em;">
                            --
                        </div>

                    </div>

                </div>

            </div>
            <!-- Intensity Minutes -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <div>

                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">Intensity Minutes</h2>

                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">

                            <div class="metric-value" style="font-size: 2rem; margin-bottom: 0;"><span
                                    id="im-val">--</span></div>

                            <div class="metric-unit">min</div>

                        </div>

                    </div>

                    <div style="text-align: right;">

                        <div style="font-size: 0.7rem; color: var(--text-secondary);">Goal</div>

                        <div style="font-size: 1.2rem; font-weight: 700; color: var(--accent-color);"><span
                                id="im-goal">--</span></div>

                    </div>

                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">

                    <div class="range-selector" style="display: inline-flex; padding: 0.2rem;">

                        <button class="range-btn" onclick="updateIMRange('1d', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1d</button>

                        <button class="range-btn active" onclick="updateIMRange('1w', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1w</button>

                        <button class="range-btn" onclick="updateIMRange('1m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1m</button>

                        <button class="range-btn" onclick="updateIMRange('6m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">6m</button>

                        <button class="range-btn" onclick="updateIMRange('1y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1y</button>

                    </div>

                    <div style="flex-grow:1"></div>

                    <button class="nav-btn" id="im-prev" onclick="shiftIMDate(-1)" style="width:24px; height:24px;"><svg
                            viewBox="0 0 24 24" stroke="currentColor" stroke-width="2" fill="none">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg></button>

                    <button class="nav-btn" id="im-next" onclick="shiftIMDate(1)" disabled
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg></button>

                </div>

                <div style="height: 200px;">

                    <canvas id="imHistoryChart"></canvas>

                </div>

            </div>

            <!-- Weight -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <div>

                        <h2 style="font-size: 1rem; margin-bottom: 0.5rem;">Weight</h2>

                        <div style="display: flex; align-items: baseline; gap: 0.5rem;">

                            <div class="metric-value" style="font-size: 2rem; margin-bottom: 0;"><span
                                    id="weight">--</span></div>

                            <div class="metric-unit">lbs</div>

                        </div>

                    </div>

                    <button class="range-btn" onclick="openWeightModal()"
                        style="font-size: 0.8rem; padding: 0.25rem 0.5rem;">+ Log</button>

                </div>

                <div style="display: flex; gap: 0.5rem; align-items: center; margin-bottom: 1rem;">

                    <div class="range-selector" style="display: inline-flex; padding: 0.2rem;">

                        <button class="range-btn active" onclick="updateWeightRange('1m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1m</button>

                        <button class="range-btn" onclick="updateWeightRange('6m', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">6m</button>

                        <button class="range-btn" onclick="updateWeightRange('1y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">1y</button>

                        <button class="range-btn" onclick="updateWeightRange('5y', this)"
                            style="padding: 0.2rem 0.5rem; font-size: 0.75rem;">5y</button>

                    </div>

                    <div style="flex-grow:1"></div>

                    <button class="nav-btn" id="weight-prev" onclick="shiftWeightDate(-1)"
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg></button>

                    <button class="nav-btn" id="weight-next" onclick="shiftWeightDate(1)" disabled
                        style="width:24px; height:24px;"><svg viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"
                            fill="none">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg></button>

                </div>

                <div style="height: 200px;">

                    <canvas id="weightHistoryChart"></canvas>

                </div>

            </div>

        </div>

        <!-- Performance Trends Grid -->

        <h2 style="margin-bottom: 1.5rem; font-size: 1.5rem;">Performance Goals & Trends</h2>

        <div class="dashboard-grid-1">

            <!-- Monthly Goals -->

            <div class="card">

                <h2 style="font-size: 1rem; margin-bottom: 1rem;">Monthly Goals</h2>

                <div class="goals-grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">

                    <div style="text-align: center;">

                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">Run</div>

                        <div class="donut-chart" id="month-run-chart"
                            style="width: 100px; height: 100px; margin: 0 auto 0.5rem auto;">

                            <div class="donut-inner" style="width: 80px; height: 80px;">

                                <span class="donut-percent" id="month-run-percent" style="font-size: 1.2rem;">0%</span>

                            </div>

                        </div>

                        <div id="month-run" style="font-size: 1rem; font-weight: 600; margin-bottom: 0.2rem;">--</div>

                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Goal: <span
                                id="month-run-goal">20</span></div>

                    </div>

                    <div style="text-align: center;">

                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">Cycle</div>

                        <div class="donut-chart" id="month-cycle-chart"
                            style="width: 100px; height: 100px; margin: 0 auto 0.5rem auto;">

                            <div class="donut-inner" style="width: 80px; height: 80px;">

                                <span class="donut-percent" id="month-cycle-percent"
                                    style="font-size: 1.2rem;">0%</span>

                            </div>

                        </div>

                        <div id="month-cycle" style="font-size: 1rem; font-weight: 600; margin-bottom: 0.2rem;">--</div>

                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Goal: <span
                                id="month-cycle-goal">200</span></div>

                    </div>

                </div>

            </div>

            <!-- Yearly Goals -->

            <div class="card">

                <h2 style="font-size: 1rem; margin-bottom: 1rem;">Yearly Goals</h2>

                <div class="goals-grid" style="grid-template-columns: 1fr 1fr; gap: 1rem;">

                    <div style="text-align: center;">

                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">Run</div>

                        <div class="donut-chart" id="year-run-chart"
                            style="width: 100px; height: 100px; margin: 0 auto 0.5rem auto;">

                            <div class="donut-inner" style="width: 80px; height: 80px;">

                                <span class="donut-percent" id="year-run-percent" style="font-size: 1.2rem;">0%</span>

                            </div>

                        </div>

                        <div id="year-run" style="font-size: 1rem; font-weight: 600; margin-bottom: 0.2rem;">--</div>

                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Goal: <span
                                id="year-run-goal">600</span></div>

                    </div>

                    <div style="text-align: center;">

                        <div style="font-size: 0.9rem; margin-bottom: 0.5rem;">Cycle</div>

                        <div class="donut-chart" id="year-cycle-chart"
                            style="width: 100px; height: 100px; margin: 0 auto 0.5rem auto;">

                            <div class="donut-inner" style="width: 80px; height: 80px;">

                                <span class="donut-percent" id="year-cycle-percent" style="font-size: 1.2rem;">0%</span>

                            </div>

                        </div>

                        <div id="year-cycle" style="font-size: 1rem; font-weight: 600; margin-bottom: 0.2rem;">--</div>

                        <div style="font-size: 0.8rem; color: var(--text-secondary);">Goal: <span
                                id="year-cycle-goal">2400</span></div>

                    </div>

                </div>

            </div>

            <!-- YTD Cycling -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <h2 style="font-size: 1rem; margin-bottom: 0;">YTD Cycling Trend</h2>

                    <button class="range-btn" onclick="resetChartZoom('ytdCyclingChart')"
                        style="padding: 0.2rem 0.5rem; font-size: 0.7rem;">Reset</button>

                </div>

                <div style="height: 350px;">

                    <canvas id="ytdCyclingChart"></canvas>

                </div>

            </div>

            <!-- YTD Running -->

            <div class="card">

                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">

                    <h2 style="font-size: 1rem; margin-bottom: 0;">YTD Running Trend</h2>

                    <button class="range-btn" onclick="resetChartZoom('ytdRunningChart')"
                        style="padding: 0.2rem 0.5rem; font-size: 0.7rem;">Reset</button>

                </div>

                <div style="height: 350px;">

                    <canvas id="ytdRunningChart"></canvas>

                </div>

            </div>

        </div>

        <!-- Nutrition & Metabolism -->
        <h2 style="margin-bottom: 1.5rem; font-size: 1.5rem;">Nutrition & Metabolism</h2>
        <div class="nutrition-grid"
            style="display: grid; grid-template-columns: 2fr 1fr; gap: 2rem; margin-bottom: 3rem;">
            <!-- Calorie Balance Card -->
            <div class="card"
                style="background: linear-gradient(135deg, rgba(16, 185, 129, 0.1) 0%, rgba(5, 150, 105, 0.05) 100%); border: 1px solid rgba(16, 185, 129, 0.2);">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                    <div
                        style="display: flex; align-items: center; gap: 1rem; background: rgba(255,255,255,0.05); padding: 0.5rem 1rem; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.1);">
                        <button class="nav-btn" onclick="shiftNutritionDate(-1)"
                            style="width: 32px; height: 32px; padding: 0;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                                stroke-linecap="round" stroke-linejoin="round" style="width: 16px;">
                                <polyline points="15 18 9 12 15 6"></polyline>
                            </svg>
                        </button>
                        <div id="nutrition-date-display"
                            style="font-weight: 800; font-family: 'Lexend', sans-serif; min-width: 120px; text-align: center; font-size: 0.95rem; color: #10b981;">
                            Today</div>
                        <button class="nav-btn" onclick="shiftNutritionDate(1)"
                            style="width: 32px; height: 32px; padding: 0;">
                            <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5"
                                stroke-linecap="round" stroke-linejoin="round" style="width: 16px;">
                                <polyline points="9 18 15 12 9 6"></polyline>
                            </svg>
                        </button>
                        <button onclick="resetNutritionToToday()" id="nutrition-today-btn"
                            style="background: rgba(16, 185, 129, 0.15); border: none; color: #10b981; padding: 0.4rem 0.8rem; border-radius: 0.5rem; font-size: 0.75rem; font-weight: 700; cursor: pointer; margin-left: 0.5rem; display: none;">Today</button>
                    </div>
                    <button class="range-btn active" onclick="openFoodModal()"
                        style="background: #10b981; color: #fff; padding: 1rem 1.8rem; border-radius: 1rem; border: none; font-weight: 700; cursor: pointer; display: flex; align-items: center; gap: 0.6rem; transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275); box-shadow: 0 8px 16px rgba(16, 185, 129, 0.25);">
                        <span>üçé</span> Log Food
                    </button>
                </div>

                <div
                    style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 2rem;">
                    <div>
                        <h3 style="font-size: 1.2rem; color: #10b981; margin-bottom: 0.5rem;">Energy Balance</h3>
                        <div style="display: flex; align-items: baseline; gap: 0.75rem;">
                            <div id="net-calories"
                                style="font-size: 3.5rem; font-weight: 800; font-family: 'Lexend', sans-serif; letter-spacing: -2px;">
                                --</div>
                            <div id="net-label"
                                style="font-size: 1rem; color: var(--text-secondary); font-weight: 600;">Net Calories
                            </div>
                        </div>
                    </div>
                </div>

                <!-- New Gauge Visualization (Scale Selector) -->
                <div style="margin-bottom: 2.5rem; position: relative; padding: 0 1.5rem; margin-top: 2rem;">
                    <div
                        style="height: 8px; background: linear-gradient(to right, #10b981, rgba(255,255,255,0.05) 50%, #f87171); border-radius: 20px; position: relative; box-shadow: inset 0 2px 4px rgba(0,0,0,0.3);">
                        <!-- Scale Labels -->
                        <div
                            style="position: absolute; width: 100%; top: -22px; display: flex; justify-content: space-between; font-size: 0.7rem; color: var(--text-secondary); font-weight: 800; font-family: 'Lexend', sans-serif; letter-spacing: 0.05em;">
                            <span style="color: #10b981;">-5000</span>
                            <span style="opacity: 0.3;">BALANCE</span>
                            <span style="color: #f87171;">+5000</span>
                        </div>

                        <!-- Center Notch -->
                        <div
                            style="position: absolute; left: 50%; top: 0; width: 2px; height: 100%; background: rgba(255,255,255,0.2); transform: translateX(-50%); z-index: 1;">
                        </div>

                        <!-- Needle / Pointer -->
                        <div id="balance-pointer"
                            style="position: absolute; left: 50%; top: -10px; width: 4px; height: 28px; background: #fff; border-radius: 4px; transition: all 1s cubic-bezier(0.34, 1.56, 0.64, 1); box-shadow: 0 0 15px rgba(255,255,255,0.5); z-index: 5; transform: translateX(-50%);">
                            <div
                                style="position: absolute; top: 0; left: 50%; transform: translateX(-50%); width: 12px; height: 12px; background: inherit; border-radius: 50%; filter: blur(6px); opacity: 0.6;">
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                    <div
                        style="background: rgba(16, 185, 129, 0.05); padding: 1.2rem; border-radius: 1rem; border: 1px solid rgba(16, 185, 129, 0.1);">
                        <div
                            style="color: #10b981; font-size: 0.8rem; font-weight: 700; margin-bottom: 0.5rem; text-transform: uppercase;">
                            Consumption</div>
                        <div id="intake-calories"
                            style="font-size: 1.6rem; font-weight: 800; font-family: 'Lexend', sans-serif;">--</div>
                    </div>
                    <div
                        style="background: rgba(56, 189, 248, 0.05); padding: 1.2rem; border-radius: 1rem; border: 1px solid rgba(56, 189, 248, 0.1);">
                        <div
                            style="color: #38bdf8; font-size: 0.8rem; font-weight: 700; margin-bottom: 0.5rem; text-transform: uppercase;">
                            Energy Out</div>
                        <div id="outtake-calories"
                            style="font-size: 1.6rem; font-weight: 800; font-family: 'Lexend', sans-serif;">--</div>
                    </div>
                </div>

                <!-- Nutrition AI Blurb -->
                <div id="nutrition-ai-box"
                    style="background: rgba(16, 185, 129, 0.05); border-left: 3px solid #10b981; padding: 1.2rem; border-radius: 0 0.75rem 0.75rem 0;">
                    <div
                        style="font-size: 0.8rem; text-transform: uppercase; letter-spacing: 0.05em; color: #10b981; margin-bottom: 0.5rem; font-weight: 700;">
                        Metabolic Analysis</div>
                    <div id="nutrition-ai-content"
                        style="font-size: 0.95rem; line-height: 1.6; color: var(--text-primary);">
                        Waiting for nutrient stream logs...
                    </div>
                </div>
            </div>

            <!-- Recent Logs Card -->
            <div class="card" style="display: flex; flex-direction: column;">
                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1.5rem;">
                    <h3 id="food-list-title" style="font-size: 1rem;">Today's Food</h3>
                    <a href="/api/nutrition/export" target="_blank"
                        style="font-size: 0.8rem; color: var(--accent-color); text-decoration: none; border-bottom: 1px solid transparent; transition: all 0.2s;"
                        onmouseover="this.style.borderBottomColor='var(--accent-color)'"
                        onmouseout="this.style.borderBottomColor='transparent'">Export CSV</a>
                </div>
                <div id="food-logs-list"
                    style="flex-grow: 1; overflow-y: auto; max-height: 380px; padding-right: 0.5rem;">
                    <!-- Logs injected here -->
                    <div style="text-align: center; color: var(--text-secondary); margin-top: 2rem;">No entries for
                        today.</div>
                </div>
                <button onclick="openLibraryModal()"
                    style="margin-top: 1.5rem; width: 100%; font-size: 0.9rem; padding: 0.8rem; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.03); border-radius: 0.75rem; color: var(--text-secondary); cursor: pointer; transition: all 0.2s; font-weight: 600; font-family: 'Lexend', sans-serif;"
                    onmouseover="this.style.background='rgba(255,255,255,0.08)'; this.style.borderColor='rgba(255,255,255,0.2)';"
                    onmouseout="this.style.background='rgba(255,255,255,0.03)'; this.style.borderColor='rgba(255,255,255,0.1)';">
                    üìñ Manage Food Library
                </button>
            </div>
        </div>

        <!-- Global Activity Heatmap -->
        <section style="margin-bottom: 3rem;">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                <h2>Global Activity Heatmap</h2>

                <div style="display: flex; gap: 1rem; align-items: center;">
                    <!-- Activity Filters -->
                    <div
                        style="display: flex; gap: 0.5rem; background: rgba(255,255,255,0.05); padding: 0.2rem 0.5rem; border-radius: 0.5rem;">
                        <label
                            style="font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 0.2rem; color: #94a3b8;">
                            <input type="checkbox" id="heatmap-run" checked onchange="updateGlobalHeatmap()"> Run
                        </label>
                        <label
                            style="font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 0.2rem; color: #94a3b8;">
                            <input type="checkbox" id="heatmap-cycle" checked onchange="updateGlobalHeatmap()"> Cycle
                        </label>
                        <label
                            style="font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 0.2rem; color: #94a3b8;">
                            <input type="checkbox" id="heatmap-walk" checked onchange="updateGlobalHeatmap()"> Walk
                        </label>
                        <label
                            style="font-size: 0.8rem; cursor: pointer; display: flex; align-items: center; gap: 0.2rem; color: #94a3b8;">
                            <input type="checkbox" id="heatmap-virtual" checked onchange="updateGlobalHeatmap()">
                            Virtual
                        </label>
                    </div>

                    <!-- Range Selector -->
                    <select id="heatmap-range" onchange="updateGlobalHeatmap()"
                        style="background: #1e293b; color: #e2e8f0; border: 1px solid rgba(255,255,255,0.1); padding: 0.3rem 0.8rem; border-radius: 0.5rem; font-size: 0.85rem; cursor: pointer;">
                        <option value="this_month" style="background: #1e293b; color: #e2e8f0;">This Month</option>
                        <option value="last_month" style="background: #1e293b; color: #e2e8f0;">Last Month</option>
                        <option value="this_year" style="background: #1e293b; color: #e2e8f0;">This Year</option>
                        <option value="last_year" style="background: #1e293b; color: #e2e8f0;">Last Year</option>
                        <option value="all" style="background: #1e293b; color: #e2e8f0;">All Time</option>
                        <option value="90d" style="background: #1e293b; color: #e2e8f0;">Last 90 Days</option>
                    </select>
                </div>
            </div>

            <div id="global-map-container"
                style="height: 500px; width: 100%; border-radius: 1rem; overflow: hidden; border: 1px solid rgba(255,255,255,0.1); position: relative;">
                <div id="globalHeatmap" style="width: 100%; height: 100%;"></div>

                <!-- Map Controls Overlay -->
                <div
                    style="position: absolute; top: 1rem; left: 1rem; z-index: 500; display: flex; flex-direction: column; gap: 0.5rem;">
                    <button onclick="resetGlobalHeatmapView()"
                        style="background: rgba(30, 41, 59, 0.9); color: white; border: 1px solid rgba(255,255,255,0.2); padding: 0.4rem 0.8rem; border-radius: 0.4rem; font-size: 0.8rem; cursor: pointer; backdrop-filter: blur(4px);">
                        Reset View
                    </button>
                </div>

                <div id="heatmap-loading"
                    style="position: absolute; bottom: 1rem; right: 1rem; background: rgba(0,0,0,0.8); padding: 0.5rem 1rem; border-radius: 2rem; font-size: 0.8rem; display: none; align-items: center; gap: 0.5rem; z-index: 1000; border: 1px solid rgba(255,255,255,0.1);">
                    <div class="pulse-dot" id="heatmap-dot"></div>
                    <span id="heatmap-status">Loading activities...</span>
                </div>
            </div>
        </section>

        <!-- Activity Heatmap -->

        <section style="margin-bottom: 3rem;">

            <div style="display: flex; justify-content: space-between; align-items: baseline; margin-bottom: 1rem;">

                <h2>Activity Calendar</h2>

                <div
                    style="font-size: 0.9rem; color: var(--text-secondary); display: flex; align-items: center; gap: 0.5rem;">

                    <span>Less</span>

                    <div style="display: flex; gap: 2px;">

                        <div style="width: 10px; height: 10px; background: rgba(255,255,255,0.05); border-radius: 2px;">

                        </div>

                        <div style="width: 10px; height: 10px; background: rgba(34, 197, 94, 0.3); border-radius: 2px;">

                        </div>

                        <div style="width: 10px; height: 10px; background: rgba(34, 197, 94, 0.6); border-radius: 2px;">

                        </div>

                        <div style="width: 10px; height: 10px; background: rgba(34, 197, 94, 1); border-radius: 2px;">

                        </div>

                    </div>

                    <span>More</span>

                </div>

            </div>

            <div id="heatmap-scroll-container" style="overflow-x: auto; padding-bottom: 1rem;">

                <div id="activity-heatmap" style="display: flex; gap: 4px; min-width: max-content;">

                    <!-- Heatmap injected via JS -->

                </div>

            </div>

        </section>

        <!-- Detailed Calendar Widget -->

        <section class="calendar-widget">

            <div class="calendar-header">

                <div class="calendar-nav">

                    <button class="nav-btn" onclick="shiftCalendarMonth(-1)">

                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">

                            <polyline points="15 18 9 12 15 6"></polyline>

                        </svg>

                    </button>

                    <div class="calendar-title" id="calendar-title">January 2026</div>

                    <button class="nav-btn" onclick="shiftCalendarMonth(1)">

                        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"
                            stroke-linecap="round" stroke-linejoin="round">

                            <polyline points="9 18 15 12 9 6"></polyline>

                        </svg>

                    </button>

                    <button class="range-btn" onclick="resetCalendarToToday()">Today</button>

                </div>

                <div class="range-selector">

                    <button class="range-btn" id="cal-view-week" onclick="setCalendarView('week')">Week</button>

                    <button class="range-btn active" id="cal-view-month"
                        onclick="setCalendarView('month')">Month</button>

                    <button class="range-btn" id="cal-view-year" onclick="setCalendarView('year')">Year</button>

                </div>

            </div>

            <div class="calendar-grid-wrapper">
                <div class="calendar-layout">
                    <!-- Sidebar Totals -->
                    <div class="calendar-totals" id="calendar-totals">
                        <!-- Totals injected via JS -->
                    </div>

                    <!-- Calendar Grid -->
                    <div>
                        <div class="calendar-grid" style="margin-bottom: 0;">
                            <div class="calendar-day-header">Mon</div>
                            <div class="calendar-day-header">Tue</div>
                            <div class="calendar-day-header">Wed</div>
                            <div class="calendar-day-header">Thu</div>
                            <div class="calendar-day-header">Fri</div>
                            <div class="calendar-day-header">Sat</div>
                            <div class="calendar-day-header">Sun</div>
                        </div>
                        <div class="calendar-grid" id="calendar-grid">
                            <!-- Days injected via JS -->
                        </div>
                    </div>
                </div>
            </div>

        </section>

        <section class="activities-section">

            <h2>Recent Activities</h2>

            <div id="activity-list" class="activity-list">

                <!-- Activities will be injected here -->

                <div class="activity-item" style="justify-content: center; padding: 2rem;">

                    <div class="loading"></div>

                </div>

            </div>

        </section>

    </div>

    <!-- Activity Detail Modal -->

    <div id="activityModal" class="modal">

        <div class="modal-content">

            <button class="modal-close" onclick="closeModal()">&times;</button>

            <h2 id="modal-title">Activity Details</h2>

            <p id="modal-date" style="color: var(--text-secondary); margin-bottom: 2rem;"></p>

            <div id="activity-map-container"
                style="height: 350px; margin-bottom: 2rem; border-radius: 0.75rem; overflow: hidden; display: none; border: 1px solid rgba(255,255,255,0.1);">
                <div id="activityMap" style="width: 100%; height: 100%; z-index: 1;"></div>
            </div>

            <div id="modal-ai-insight" class="ai-insight-box"
                style="display: none; margin-bottom: 2rem; background: rgba(56, 189, 248, 0.05); border: 1px solid rgba(56, 189, 248, 0.1); padding: 1.5rem; border-radius: 1rem;">
                <h3
                    style="color: var(--accent-color); margin-bottom: 1rem; display: flex; align-items: center; justify-content: space-between;">
                    <span style="display: flex; align-items: center; gap: 0.5rem;">
                        <span>‚ú®</span> Coach's Recap
                    </span>
                    <span id="modal-ai-model-name"
                        style="font-size: 0.7rem; color: var(--text-secondary); font-style: italic; font-weight: normal;"></span>
                </h3>
                <div id="modal-ai-content" style="line-height: 1.6;"></div>
            </div>

            <div id="modal-dynamic-body">
                <!-- Dynamic stages will be injected here -->
            </div>

            <div style="display: flex; justify-content: center; margin-top: 2rem;">
                <button class="range-btn active" style="padding: 0.8rem 2rem;" onclick="closeModal()">Close
                    Details</button>
            </div>

        </div>

    </div>

    <!-- Settings Modal -->
    <div id="settingsModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <button class="modal-close" onclick="closeSettings()">&times;</button>

            <h2 style="margin-bottom: 2rem; display: flex; align-items: center; gap: 0.5rem;">
                <span>‚öôÔ∏è</span> Dashboard Settings
            </h2>

            <div style="margin-bottom: 2rem;">
                <h3 style="color: var(--accent-color); margin-bottom: 1rem; font-size: 1.1rem;">AI Model Selection</h3>
                <p style="color: var(--text-secondary); margin-bottom: 1.5rem; font-size: 0.9rem;">
                    Choose which AI model to use for generating insights. Different models have different capabilities
                    and rate limits.
                </p>

                <div id="model-options" style="display: flex; flex-direction: column; gap: 0.75rem;">
                    <!-- Model options will be populated dynamically -->
                </div>

                <div id="settings-status"
                    style="margin-top: 1rem; padding: 0.75rem; border-radius: 0.5rem; display: none;"></div>
            </div>

            <div style="display: flex; justify-content: space-between; gap: 1rem; margin-top: 2rem;">
                <button class="range-btn" style="padding: 0.8rem 2rem;" onclick="closeSettings()">Cancel</button>
                <button class="range-btn active" style="padding: 0.8rem 2rem;" onclick="saveSettings()">Save
                    Settings</button>
            </div>
        </div>
    </div>

    <!-- Weight Log Modal -->

    <div id="weightModal" class="modal">

        <div class="modal-content" style="max-width: 400px; text-align: center;">

            <button class="modal-close" onclick="closeWeightModal()">&times;</button>

            <h2 style="margin-bottom: 2rem;">Log Weight</h2>

            <div style="margin-bottom: 2rem;">

                <input type="number" id="weight-input" step="0.1" placeholder="Enter weight"
                    style="width: 100%; padding: 1rem; border-radius: 0.5rem; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; font-size: 1.5rem; text-align: center; margin-bottom: 1rem;">

                <div style="display: flex; justify-content: center; gap: 2rem;">

                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">

                        <input type="radio" name="weight-unit" value="lbs" checked style="transform: scale(1.5);">

                        <span style="font-size: 1.1rem;">lbs</span>

                    </label>

                    <label style="display: flex; align-items: center; gap: 0.5rem; cursor: pointer;">

                        <input type="radio" name="weight-unit" value="kg" style="transform: scale(1.5);">

                        <span style="font-size: 1.1rem;">kg</span>

                    </label>

                </div>

            </div>

            <button class="range-btn active" style="padding: 0.8rem 2rem; width: 100%; font-size: 1.1rem;"
                onclick="submitWeight()">Save Weight</button>

        </div>

    </div>

    <!-- Food Log Modal -->
    <div id="foodModal" class="modal">
        <div class="modal-content"
            style="max-width: 650px; background: #0f172a; border: 1px solid rgba(255,255,255,0.1);">
            <button class="modal-close" onclick="closeFoodModal()">&times;</button>
            <h2
                style="margin-bottom: 1.5rem; display: flex; align-items: center; gap: 0.75rem; font-family: 'Lexend', sans-serif;">
                <span style="font-size: 1.8rem;">ü•ó</span> Log Nutrition
            </h2>

            <div
                style="display: flex; align-items: center; gap: 1rem; padding: 0.5rem 1rem; margin-bottom: 1.5rem; background: rgba(255,255,255,0.02); border-radius: 1rem; border: 1px solid rgba(255,255,255,0.05);">
                <span style="font-size: 0.9rem; color: #94a3b8; font-weight: 600;">Time:</span>
                <input type="time" id="food-log-time"
                    style="background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.1); color: white; padding: 0.6rem 0.8rem; border-radius: 0.75rem; font-family: 'Lexend', sans-serif; cursor: pointer; border-left: 3px solid #10b981; font-size: 0.9rem;">
            </div>

            <!-- Main Search View -->
            <div id="food-main-view">
                <div style="margin-bottom: 2rem;">
                    <div class="search-container" style="position: relative;">
                        <input type="text" id="food-search-input" placeholder="What did you eat? (e.g. Turkey Sandwich)"
                            style="width: 100%; padding: 1.2rem; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.1); background: rgba(255,255,255,0.05); color: white; font-size: 1.1rem; transition: all 0.2s; box-shadow: inset 0 2px 4px rgba(0,0,0,0.2);"
                            oninput="onFoodSearchInput()"
                            onfocus="this.style.borderColor='var(--accent-color)'; this.style.background='rgba(56, 189, 248, 0.05)'"
                            onblur="this.style.borderColor='rgba(255,255,255,0.1)'; this.style.background='rgba(255,255,255,0.05)'">
                        <div id="food-search-results"
                            style="position: absolute; top: 100%; left: 0; right: 0; background: #1e293b; border: 1px solid rgba(255,255,255,0.2); border-radius: 0 0 1rem 1rem; z-index: 1000; display: none; overflow: hidden; box-shadow: 0 15px 35px rgba(0,0,0,0.6);">
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem; margin-top: 2rem;">
                    <button class="range-btn" style="flex: 1; padding: 1rem; border-radius: 0.75rem;"
                        onclick="closeFoodModal()">Cancel</button>
                    <button class="range-btn active" id="btn-log-food"
                        style="flex: 1; padding: 1rem; border-radius: 0.75rem; background: #10b981;"
                        onclick="submitFoodLog()">
                        Analyze & Review with AI
                    </button>
                </div>

                <div
                    style="margin-top: 2.5rem; border-top: 1px solid rgba(255,255,255,0.05); padding-top: 1.5rem; text-align: center;">
                    <button onclick="showCustomFoodForm()"
                        style="background: rgba(16, 185, 129, 0.1); border: 1px solid rgba(16, 185, 129, 0.2); color: #10b981; font-size: 0.95rem; cursor: pointer; padding: 0.8rem 1.5rem; font-weight: 600; border-radius: 2rem; display: inline-flex; align-items: center; gap: 0.5rem; transition: all 0.2s;"
                        onmouseover="this.style.background='rgba(16, 185, 129, 0.2)'"
                        onmouseout="this.style.background='rgba(16, 185, 129, 0.1)'">
                        <span>‚ûï</span> Create Gourmet Recipe / Meal
                    </button>
                </div>
            </div>

            <!-- Enhanced Custom Food Form -->
            <div id="custom-food-form" style="display: none;">
                <h3
                    style="margin-bottom: 2rem; color: #10b981; display: flex; justify-content: space-between; align-items: center;">
                    <span>Recipe Constructor</span>
                    <button onclick="hideCustomFoodForm()"
                        style="background:none; border:none; color:var(--text-secondary); cursor:pointer;">‚úï</button>
                </h3>

                <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 1.5rem; margin-bottom: 2rem;">
                    <div>
                        <label
                            style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.4rem; display: block;">Recipe
                            Name</label>
                        <input type="text" id="custom-name" placeholder="e.g. Morning Turkey Club"
                            style="width: 100%; padding: 1rem; border-radius: 0.75rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white;">
                    </div>
                    <div>
                        <label
                            style="font-size: 0.75rem; color: var(--text-secondary); margin-bottom: 0.4rem; display: block;">Category</label>
                        <select id="custom-category"
                            style="width: 100%; padding: 1rem; border-radius: 0.75rem; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white;">
                            <option value="Breakfast">Breakfast</option>
                            <option value="Lunch">Lunch</option>
                            <option value="Dinner">Dinner</option>
                            <option value="Snack">Snack</option>
                            <option value="Meal">General Meal</option>
                        </select>
                    </div>
                </div>

                <div style="margin-bottom: 2rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span style="font-weight: 600; font-size: 0.9rem;">Ingredients</span>
                        <button onclick="estimateAllIngredients()" id="btn-ai-scan" class="range-btn active"
                            style="font-size: 0.75rem; background: #38bdf8; padding: 0.4rem 0.8rem; border-radius: 0.5rem; border: none; font-weight: 600;">
                            ‚ú® AI Full Scan
                        </button>
                    </div>
                    <div id="ingredient-list"
                        style="display: flex; flex-direction: column; gap: 0.75rem; margin-bottom: 1rem;">
                        <!-- Ingredient rows -->
                    </div>
                    <button class="range-btn" onclick="addIngredientRow()"
                        style="width: 100%; border: 1px dashed rgba(255,255,255,0.2); background: none; font-size: 0.85rem; padding: 0.8rem; color: #94a3b8;">
                        Ôºã Add Ingredient
                    </button>
                </div>

                <div
                    style="background: rgba(255,255,255,0.03); padding: 1.5rem; border-radius: 1rem; border: 1px solid rgba(255,255,255,0.05); margin-bottom: 2rem;">
                    <div
                        style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 1rem;">
                        <span style="font-weight: 600;">Nutrient Summary</span>
                        <div style="display: flex; gap: 1.5rem;">
                            <div style="text-align: right;">
                                <div
                                    style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase;">
                                    Calories</div>
                                <div id="summary-cal" style="font-size: 1.1rem; font-weight: 700;">0</div>
                            </div>
                            <div style="text-align: right;">
                                <div
                                    style="font-size: 0.7rem; color: var(--text-secondary); text-transform: uppercase;">
                                    Cholesterol</div>
                                <div id="summary-chol" style="font-size: 1.1rem; font-weight: 700; color: #fb923c;">0mg
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div style="display: flex; gap: 1rem;">
                    <button class="range-btn" style="flex: 1; padding: 1rem;"
                        onclick="hideCustomFoodForm()">Back</button>
                    <button class="range-btn"
                        style="flex: 1.5; padding: 1rem; border: 1px solid rgba(16, 185, 129, 0.3); color: #10b981;"
                        onclick="saveCustomFood(false)">
                        Save to Library
                    </button>
                    <button class="range-btn active" style="flex: 2; padding: 1rem; background: #10b981;"
                        onclick="saveCustomFood(true)">
                        Save & Log Today
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Library Modal -->
    <div id="libraryModal" class="modal">
        <div class="modal-content"
            style="max-width: 800px; background: #0f172a; border: 1px solid rgba(255,255,255,0.1);">
            <button class="modal-close" onclick="closeLibraryModal()">&times;</button>
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 2rem;">
                <h2 style="font-family: 'Lexend', sans-serif;">Food Library</h2>
                <a href="/api/nutrition/export_library" target="_blank" class="range-btn active"
                    style="background: rgba(255,255,255,0.1); font-size: 0.85rem; color: white; text-decoration: none; padding: 0.5rem 1rem; border-radius: 0.5rem;">Export
                    CSV</a>
            </div>

            <div id="library-list"
                style="display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 1rem; max-height: 60vh; overflow-y: auto; padding-right: 0.5rem;">
                <!-- Library items -->
            </div>
        </div>
    </div>

    <script>
        // Global chart instances
        const chartInstances = {};
        let cachedActivityInsights = {};
        let cachedModelName = '';

        // Helper to format AI model names for display
        function formatModelName(modelName) {
            if (!modelName) return '';

            const modelMap = {
                'gemini-2.5-flash-lite': 'Gemini 2.5 Flash Lite',
                'gemini-2.0-flash-exp': 'Gemini 2.0 Flash',
                'gemini-1.5-pro': 'Gemini 1.5 Pro',
                'gemini-1.5-flash': 'Gemini 1.5 Flash',
                'gemma-3-27b-it': 'Gemma 3 27B',
                'gemma-2-27b-it': 'Gemma 2 27B',
                'Local Logic (Fallback)': 'Local Logic'
            };

            return modelMap[modelName] || modelName;
        }

        // Helper to get local date string YYYY-MM-DD
        function getLocalDateStr(date = new Date()) {
            const year = date.getFullYear();
            const month = String(date.getMonth() + 1).padStart(2, '0');
            const day = String(date.getDate()).padStart(2, '0');
            return `${year}-${month}-${day}`;
        }

        function parseLocalDate(dateStr) {
            const [y, m, d] = dateStr.split('-').map(Number);
            return new Date(y, m - 1, d);
        }

        function formatTo12H(timeStr) {
            if (!timeStr) return '';
            const [hrs, mins] = timeStr.split(':');
            let h = parseInt(hrs);
            const ampm = h >= 12 ? 'PM' : 'AM';
            h = h % 12 || 12;
            return `${h}:${mins} ${ampm}`;
        }

        // Helper to format distance in both miles and km
        function formatDualDistance(miles) {
            const km = (miles * 1.60934).toFixed(1);
            const mi = Number(miles).toFixed(1);
            return `${mi} mi / ${km} km`;
        }

        // --- Nutrition & Calorie Tracking ---
        let customFoods = {};
        let currentNutritionLogs = [];
        let editingLogId = null;
        let activeNutritionDate = new Date();

        function shiftNutritionDate(dir) {
            activeNutritionDate.setDate(activeNutritionDate.getDate() + dir);
            const today = new Date();
            today.setHours(0, 0, 0, 0);
            const active = new Date(activeNutritionDate);
            active.setHours(0, 0, 0, 0);

            if (active > today) activeNutritionDate = new Date();

            updateNutritionDateUI();
            fetchNutritionData();
        }

        function resetNutritionToToday() {
            activeNutritionDate = new Date();
            updateNutritionDateUI();
            fetchNutritionData();
        }

        function updateNutritionDateUI() {
            const display = document.getElementById('nutrition-date-display');
            const todayBtn = document.getElementById('nutrition-today-btn');
            const title = document.getElementById('food-list-title');

            const dateStr = getLocalDateStr(activeNutritionDate);
            const todayStr = getLocalDateStr(new Date());

            if (dateStr === todayStr) {
                display.textContent = 'Today';
                if (todayBtn) todayBtn.style.display = 'none';
                if (title) title.textContent = "Today's Food";
            } else {
                const options = { month: 'short', day: 'numeric', year: 'numeric' };
                display.textContent = activeNutritionDate.toLocaleDateString(undefined, options);
                if (todayBtn) todayBtn.style.display = 'inline-block';
                if (title) title.textContent = `Food for ${activeNutritionDate.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })}`;
            }
        }

        async function fetchNutritionData() {
            try {
                const dateStr = getLocalDateStr(activeNutritionDate);
                const [logsRes, customRes] = await Promise.all([
                    fetch(`/api/nutrition/logs?date=${dateStr}`),
                    fetch('/api/nutrition/custom_foods')
                ]);

                if (logsRes.ok) {
                    const logs = await logsRes.json();

                    // Fetch stats - Use no_ai=true for faster load unless history is being browsed
                    const isToday = getLocalDateStr(activeNutritionDate) === getLocalDateStr(new Date());
                    const analysisUrl = `/api/nutrition/analysis?date=${dateStr}&no_ai=true`;
                    const statsRes = await fetch(analysisUrl);
                    const analysisData = await statsRes.json();

                    let outtake = 0;
                    if (isToday) {
                        // For today, we might already have stats from updateDashboard
                        // But we want to ensure sync, so we fetch locally if not provided
                        outtake = analysisData.metabolic ? analysisData.metabolic.total : 0;
                    } else {
                        if (analysisData.metabolic) {
                            outtake = analysisData.metabolic.total || 0;
                        }
                    }

                    updateNutritionUI(logs, outtake, analysisData.analysis);
                }
                if (customRes.ok) {
                    customFoods = await customRes.json();
                }
            } catch (err) {
                console.error("Nutrition fetch error:", err);
            }
        }

        function updateNutritionUI(logs, outtake, aiAnalysis) {
            currentNutritionLogs = logs;
            const intake = logs.reduce((sum, log) => sum + (log.calories || 0), 0);
            const net = intake - outtake;

            safeSetText('intake-calories', intake.toLocaleString());
            safeSetText('outtake-calories', outtake.toLocaleString());

            const netEl = document.getElementById('net-calories');
            const netLabel = document.getElementById('net-label');
            const pointer = document.getElementById('balance-pointer');

            if (netEl && pointer) {
                netEl.textContent = (net > 0 ? '+' : '') + Math.abs(net).toLocaleString();
                netLabel.textContent = net > 0 ? 'Surplus' : 'Deficit (Burned)';

                // Scale logic: -5000 to +5000
                const maxRange = 5000;
                // Clamp net between -5000 and 5000
                const clampedNet = Math.max(-maxRange, Math.min(maxRange, net));
                // Map -5000...5000 to 0%...100%
                const posPct = ((clampedNet + maxRange) / (maxRange * 2)) * 100;

                pointer.style.left = posPct + '%';

                if (net <= 0) {
                    pointer.style.background = '#10b981'; // Green for deficit
                    pointer.style.boxShadow = '0 0 15px rgba(16, 185, 129, 0.8)';
                    netEl.style.color = '#10b981';
                } else {
                    pointer.style.background = '#f87171'; // Red for surplus
                    pointer.style.boxShadow = '0 0 15px rgba(248, 113, 113, 0.8)';
                    netEl.style.color = '#f87171';
                }
            }

            const list = document.getElementById('food-logs-list');
            if (list) {
                if (logs.length === 0) {
                    list.innerHTML = `<div style="text-align: center; color: var(--text-secondary); margin-top: 2rem;">No entries for ${getLocalDateStr(activeNutritionDate) === getLocalDateStr(new Date()) ? 'today' : 'this date'}.</div>`;
                } else {
                    list.innerHTML = logs.slice().reverse().map(l => `
                        <div class="activity-item" style="padding: 1rem; margin-bottom: 0.75rem; background: rgba(255,255,255,0.02); border-radius: 0.75rem; border: 1px solid rgba(255,255,255,0.05); align-items: center; display: flex;">
                            <div style="font-size: 1.2rem; margin-right: 1rem;">${l.calories > 500 ? 'üç±' : (l.calories > 200 ? 'ü•™' : 'üçé')}</div>
                            <div style="flex-grow: 1;">
                                <div style="font-weight: 600; font-size: 0.95rem;">${l.name}</div>
                                <div style="font-size: 0.75rem; color: var(--text-secondary);">${formatTo12H(l.time)} ‚Ä¢ ${l.calories} kcal</div>
                            </div>
                            <div style="display: flex; gap: 0.5rem;">
                                <button onclick="editAnyMeal(${l.id})" style="background: none; border: none; color: #38bdf8; cursor: pointer; opacity: 0.5; padding: 0.5rem; font-size: 0.8rem;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.5">Edit</button>
                                <button onclick="deleteFoodLog(${l.id})" style="background: none; border: none; color: #f87171; cursor: pointer; opacity: 0.5; padding: 0.5rem;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.5">‚úï</button>
                            </div>
                        </div>
                    `).join('');
                }
            }

            if (aiAnalysis) {
                safeSetHTML('nutrition-ai-content', aiAnalysis);
            } else {
                refreshNutritionAnalysis();
            }
        }

        async function refreshNutritionAnalysis() {
            try {
                const dateStr = getLocalDateStr(activeNutritionDate);
                const res = await fetch(`/api/nutrition/analysis?date=${dateStr}`);
                if (res.ok) {
                    const data = await res.json();
                    safeSetHTML('nutrition-ai-content', data.analysis);
                }
            } catch (err) { console.error("Analysis error:", err); }
        }

        function openFoodModal() {
            document.getElementById('foodModal').classList.add('active');
            document.getElementById('food-search-input').focus();

            // Set current time as default
            const now = new Date();
            const timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            document.getElementById('food-log-time').value = timeStr;
        }
        function closeFoodModal() { document.getElementById('foodModal').classList.remove('active'); }

        function onFoodSearchInput() {
            const query = document.getElementById('food-search-input').value.toLowerCase();
            const results = document.getElementById('food-search-results');

            if (!query) {
                results.style.display = 'none';
                return;
            }

            const matches = Object.keys(customFoods).filter(f => f.toLowerCase().includes(query));

            if (matches.length > 0) {
                results.innerHTML = matches.map(m => `
                    <div style="padding: 1rem; border-bottom: 1px solid rgba(255,255,255,0.05); display: flex; justify-content: space-between; align-items: center; transition: background 0.2s;" onmouseover="this.style.background='rgba(255,255,255,0.05)'" onmouseout="this.style.background='transparent'">
                        <div onclick="selectFood('${m}')" style="flex-grow: 1; cursor: pointer;">
                            <div style="font-weight: 600;">${m}</div>
                            <div style="font-size: 0.75rem; color: var(--text-secondary);">${customFoods[m].calories} kcal ‚Ä¢ Saved Recipe</div>
                        </div>
                        <button onclick="editLibraryItem('${m}')" style="background: rgba(56, 189, 248, 0.1); border: 1px solid rgba(56, 189, 248, 0.2); color: #38bdf8; padding: 0.4rem 0.8rem; border-radius: 0.4rem; font-size: 0.75rem; cursor: pointer; font-weight: 600;">Edit Recipe</button>
                    </div>
                `).join('');
                results.style.display = 'block';
            } else {
                results.style.display = 'none';
            }
        }

        function selectFood(name) {
            document.getElementById('food-search-input').value = name;
            document.getElementById('food-search-results').style.display = 'none';

            // If it's a library item, open it in the constructor for review
            if (customFoods[name]) {
                editLibraryItem(name);
            } else {
                submitFoodLog();
            }
        }

        async function submitFoodLog() {
            const name = document.getElementById('food-search-input').value;
            if (!name) return;

            const btn = document.getElementById('btn-log-food');
            const originalText = btn.textContent;
            btn.textContent = "AI Analyzing...";
            btn.disabled = true;

            try {
                // Dry run to get estimates without logging yet
                const res = await fetch(`/api/nutrition/log?dry_run=true`, {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name: name })
                });

                if (res.ok) {
                    const estimates = await res.json();
                    if (estimates.length > 0) {
                        const data = estimates[0];
                        // Open constructor with these values
                        showCustomFoodForm();
                        document.getElementById('custom-name').value = data.name;

                        const list = document.getElementById('ingredient-list');
                        list.innerHTML = '';
                        addIngredientRow({
                            name: data.name,
                            qty: 1,
                            unit: 'serving',
                            calories: data.calories,
                            cholesterol_mg: data.cholesterol_mg || 0,
                            protein_g: data.protein_g || 0,
                            carbs_g: data.carbs_g || 0,
                            fat_g: data.fat_g || 0
                        });
                        updateNutrientSummary();
                        // Clear search
                        document.getElementById('food-search-input').value = '';
                    }
                }
            } catch (err) {
                console.error("Log food error:", err);
            } finally {
                btn.textContent = originalText;
                btn.disabled = false;
            }
        }

        async function editAnyMeal(logId) {
            const log = currentNutritionLogs.find(l => l.id === logId);
            if (!log) return;

            editingLogId = logId; // Mark for replacement

            // Set the time picker to the log's time
            if (log.time) {
                document.getElementById('food-log-time').value = log.time;
            }

            // Check if it's in library
            if (customFoods[log.name]) {
                editLibraryItem(log.name);
            } else {
                // It's a manual/AI log, load into constructor directly
                showCustomFoodForm();
                document.getElementById('custom-name').value = log.name;
                const list = document.getElementById('ingredient-list');
                list.innerHTML = '';
                addIngredientRow({
                    name: log.name,
                    qty: log.qty || 1,
                    unit: log.unit || 'serving',
                    calories: log.calories,
                    cholesterol_mg: log.cholesterol_mg || 0,
                    protein_g: log.protein_g || 0,
                    carbs_g: log.carbs_g || 0,
                    fat_g: log.fat_g || 0
                });
                updateNutrientSummary();
            }
        }


        async function deleteFoodLog(id) {
            if (!confirm("Remove this entry?")) return;
            try {
                await fetch('/api/nutrition/delete', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ id: id })
                });
                fetchNutritionData();
            } catch (err) { console.error("Delete log error:", err); }
        }

        // --- Recipe Constructor & Library Logic ---
        let ingredientIndex = 0;

        function showCustomFoodForm() {
            document.getElementById('food-main-view').style.display = 'none';
            document.getElementById('custom-food-form').style.display = 'block';
            document.getElementById('ingredient-list').innerHTML = '';
            ingredientIndex = 0;
            addIngredientRow();
        }

        function hideCustomFoodForm() {
            document.getElementById('food-main-view').style.display = 'block';
            document.getElementById('custom-food-form').style.display = 'none';
        }

        function addIngredientRow(data = null) {
            const list = document.getElementById('ingredient-list');
            const rowId = `ing-row-${ingredientIndex++}`;
            const div = document.createElement('div');
            div.id = rowId;
            div.className = 'ingredient-row';
            div.style.cssText = 'display: grid; grid-template-columns: 2fr 1fr 1fr 1.2fr auto; gap: 0.5rem; align-items: end; background: rgba(255,255,255,0.02); padding: 0.5rem; border-radius: 0.5rem;';

            div.innerHTML = `
                <div>
                    <input type="text" class="ing-name" placeholder="Item" value="${data?.name || ''}" 
                        style="width: 100%; height: 32px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 0.4rem; padding: 0 0.5rem; font-size: 0.85rem;">
                </div>
                <div>
                    <input type="number" class="ing-qty" placeholder="Qty" value="${data?.qty || 1}" 
                        oninput="onQtyChange(this)"
                        style="width: 100%; height: 32px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 0.4rem; padding: 0 0.5rem; font-size: 0.85rem;">
                </div>
                <div>
                    <select class="ing-unit" style="width: 100%; height: 32px; background: rgba(0,0,0,0.3); border: 1px solid rgba(255,255,255,0.1); color: white; border-radius: 0.4rem; font-size: 0.8rem;">
                        <option value="slices" ${data?.unit === 'slices' ? 'selected' : ''}>Slices</option>
                        <option value="oz" ${data?.unit === 'oz' ? 'selected' : ''}>Oz</option>
                        <option value="cups" ${data?.unit === 'cups' ? 'selected' : ''}>Cups</option>
                        <option value="grams" ${data?.unit === 'grams' ? 'selected' : ''}>Grams</option>
                        <option value="tbsp" ${data?.unit === 'tbsp' ? 'selected' : ''}>Tbsp</option>
                        <option value="pieces" ${data?.unit === 'pieces' ? 'selected' : ''}>Pcs</option>
                    </select>
                </div>
                <div style="position: relative;">
                    <input type="number" class="ing-cal" placeholder="kcal" value="${data?.calories || 0}" 
                        oninput="onCalChange(this)"
                        data-pro="${data?.protein_g || 0}" data-carb="${data?.carbs_g || 0}" data-fat="${data?.fat_g || 0}"
                        data-base-qty="${data?.qty || 1}"
                        style="width: 100%; height: 32px; background: rgba(16, 185, 129, 0.05); border: 1px solid rgba(16, 185, 129, 0.2); color: #10b981; border-radius: 0.4rem; padding: 0 0.5rem; font-size: 0.85rem; font-weight: 700;">
                    <input type="hidden" class="ing-chol" value="${data?.cholesterol_mg || 0}">
                </div>
                <button onclick="document.getElementById('${rowId}').remove(); updateNutrientSummary();" 
                    style="background:none; border:none; color:#f87171; cursor:pointer; padding: 0 0.5rem;">‚úï</button>
            `;
            list.appendChild(div);
        }

        async function estimateAllIngredients() {
            const rows = document.querySelectorAll('.ingredient-row');
            if (rows.length === 0) return;

            const btn = document.getElementById('btn-ai-scan');
            const originalText = btn.textContent;
            btn.textContent = 'AI Scanning...';
            btn.disabled = true;

            const ingredients = Array.from(rows).map(row => ({
                name: row.querySelector('.ing-name').value,
                qty: row.querySelector('.ing-qty').value,
                unit: row.querySelector('.ing-unit').value
            }));

            try {
                const res = await fetch('/api/nutrition/estimate_ingredients', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ingredients })
                });

                if (res.ok) {
                    const estimates = await res.json();
                    rows.forEach((row, i) => {
                        if (estimates[i]) {
                            const calInput = row.querySelector('.ing-cal');
                            calInput.value = estimates[i].calories;
                            row.querySelector('.ing-chol').value = estimates[i].cholesterol_mg || 0;
                            calInput.setAttribute('data-pro', estimates[i].protein_g || 0);
                            calInput.setAttribute('data-carb', estimates[i].carbs_g || 0);
                            calInput.setAttribute('data-fat', estimates[i].fat_g || 0);
                        }
                    });
                    updateNutrientSummary();
                }
            } catch (err) { console.error(err); }
            finally {
                btn.textContent = '‚ú® Scan Complete';
                setTimeout(() => btn.textContent = originalText, 2000);
                btn.disabled = false;
            }
        }

        function onQtyChange(input) {
            const row = input.closest('.ingredient-row');
            const calInput = row.querySelector('.ing-cal');
            const newQty = parseFloat(input.value) || 0;
            const baseQty = parseFloat(calInput.getAttribute('data-base-qty')) || 1;

            if (newQty > 0 && baseQty > 0) {
                const ratio = newQty / baseQty;

                // Scale calories
                const currentCal = parseFloat(calInput.value) || 0;
                calInput.value = Math.round(currentCal * ratio);

                // Scale macros (stored in attributes)
                const macros = ['pro', 'carb', 'fat'];
                macros.forEach(m => {
                    const val = parseFloat(calInput.getAttribute(`data-${m}`)) || 0;
                    calInput.setAttribute(`data-${m}`, Math.round(val * ratio));
                });

                // Scale cholesterol
                const chol = row.querySelector('.ing-chol');
                chol.value = Math.round((parseInt(chol.value) || 0) * ratio);

                calInput.setAttribute('data-base-qty', newQty);
            }
            updateNutrientSummary();
        }

        function onCalChange(input) {
            // If user manually edits calories, it stays as the "total" for current qty
            updateNutrientSummary();
        }

        function updateNutrientSummary() {
            let totalCal = 0;
            let totalChol = 0;
            document.querySelectorAll('.ingredient-row').forEach(row => {
                totalCal += parseInt(row.querySelector('.ing-cal').value) || 0;
                totalChol += parseInt(row.querySelector('.ing-chol').value) || 0;
            });
            safeSetText('summary-cal', totalCal);
            safeSetText('summary-chol', totalChol + 'mg');
        }

        async function saveCustomFood(alsoLog = true) {
            const name = document.getElementById('custom-name').value;
            const category = document.getElementById('custom-category').value;
            if (!name) return alert("Please name your recipe.");

            const ingredients = [];
            let totalCal = 0;
            let totalChol = 0;
            let totalPro = 0, totalCarb = 0, totalFat = 0;

            document.querySelectorAll('.ingredient-row').forEach(row => {
                const calInput = row.querySelector('.ing-cal');
                const cal = parseInt(calInput.value) || 0;
                const cholVal = parseInt(row.querySelector('.ing-chol').value) || 0;
                const pro = parseInt(calInput.getAttribute('data-pro')) || 0;
                const carb = parseInt(calInput.getAttribute('data-carb')) || 0;
                const fat = parseInt(calInput.getAttribute('data-fat')) || 0;

                ingredients.push({
                    name: row.querySelector('.ing-name').value,
                    qty: row.querySelector('.ing-qty').value,
                    unit: row.querySelector('.ing-unit').value,
                    calories: cal,
                    cholesterol_mg: cholVal,
                    protein_g: pro,
                    carbs_g: carb,
                    fat_g: fat
                });
                totalCal += cal;
                totalChol += cholVal;
                totalPro += pro;
                totalCarb += carb;
                totalFat += fat;
            });

            try {
                // 1. Save to library (Always)
                await fetch('/api/nutrition/custom_foods', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({
                        name, category, ingredients,
                        calories: totalCal, cholesterol_mg: totalChol,
                        protein_g: totalPro, carbs_g: totalCarb, fat_g: totalFat
                    })
                });

                // 2. Conditionally Log (or Update)
                if (editingLogId) {
                    // Remove old log first
                    await fetch('/api/nutrition/delete', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ id: editingLogId })
                    });
                }

                if (alsoLog || editingLogId) {
                    const timeStr = document.getElementById('food-log-time').value;
                    const dateStr = getLocalDateStr(activeNutritionDate);
                    await fetch('/api/nutrition/log', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ name: name, date: dateStr, time: timeStr })
                    });
                }

                editingLogId = null; // Reset
                hideCustomFoodForm();
                closeFoodModal();
                fetchNutritionData();
            } catch (err) { console.error(err); }
        }


        function openLibraryModal() {
            document.getElementById('libraryModal').classList.add('active');
            renderLibrary();
        }
        function closeLibraryModal() { document.getElementById('libraryModal').classList.remove('active'); }

        async function renderLibrary() {
            const list = document.getElementById('library-list');
            try {
                const res = await fetch('/api/nutrition/custom_foods');
                const library = await res.json();

                if (Object.keys(library).length === 0) {
                    list.innerHTML = '<div style="grid-column: 1/-1; text-align: center; color: var(--text-secondary);">Library is empty.</div>';
                    return;
                }

                list.innerHTML = Object.entries(library).map(([name, data]) => `
                    <div class="card" style="margin-bottom: 0; background: rgba(255,255,255,0.02);">
                        <div style="display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 0.5rem;">
                            <span style="font-size: 0.7rem; color: #10b981; font-weight: 700; text-transform: uppercase;">${data.category || 'Meal'}</span>
                            <button onclick="deleteLibraryItem('${name}')" style="background:none; border:none; color:#f87171; cursor:pointer; opacity: 0.5;" onmouseover="this.style.opacity=1" onmouseout="this.style.opacity=0.5">‚úï</button>
                        </div>
                        <div style="font-weight: 600; margin-bottom: 0.25rem;">${name}</div>
                        <div style="font-size: 1.2rem; font-weight: 700; margin-bottom: 1rem;">${data.calories} kcal</div>
                        <div style="font-size: 0.8rem; color: var(--text-secondary); line-height: 1.4;">
                            ${(data.ingredients || []).map(i => `${i.qty} ${i.unit} ${i.name}`).join(', ')}
                        </div>
                        <div style="display: flex; gap: 0.5rem; margin-top: 1.5rem;">
                            <button onclick="editLibraryItem('${name}')" class="range-btn" style="flex: 1; padding: 0.6rem; font-size: 0.8rem; background: rgba(56, 189, 248, 0.1); border: 1px solid rgba(56, 189, 248, 0.2); color: #38bdf8;">Edit</button>
                            <button onclick="logFromLibrary('${name}')" class="range-btn active" style="flex: 2; padding: 0.6rem; font-size: 0.8rem; background: #10b981;">Log This</button>
                        </div>
                    </div>
                `).join('');
            } catch (err) { console.error(err); }
        }

        async function deleteLibraryItem(name) {
            if (!confirm(`Delete "${name}" from your library?`)) return;
            await fetch('/api/nutrition/delete_library_item', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name })
            });
            renderLibrary();
        }

        async function editLibraryItem(name) {
            try {
                const res = await fetch('/api/nutrition/custom_foods');
                const library = await res.json();
                const data = library[name];
                if (!data) return;

                closeLibraryModal();
                openFoodModal();
                showCustomFoodForm();

                document.getElementById('custom-name').value = name;
                document.getElementById('custom-category').value = data.category || 'Meal';

                const list = document.getElementById('ingredient-list');
                list.innerHTML = '';
                ingredientIndex = 0;

                (data.ingredients || []).forEach(ing => {
                    addIngredientRow(ing);
                });

                updateNutrientSummary();
            } catch (err) { console.error(err); }
        }

        async function logFromLibrary(name) {
            let timeStr;
            const timeInput = document.getElementById('food-log-time');
            if (timeInput && timeInput.value) {
                timeStr = timeInput.value;
            } else {
                const now = new Date();
                timeStr = now.getHours().toString().padStart(2, '0') + ':' + now.getMinutes().toString().padStart(2, '0');
            }

            await fetch('/api/nutrition/log', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ name: name, date: getLocalDateStr(activeNutritionDate), time: timeStr })
            });
            closeLibraryModal();
            closeFoodModal();
            fetchNutritionData();
        }

        function safeSetText(id, text) {
            const el = document.getElementById(id);
            if (el) el.textContent = text;
        }

        function safeSetHTML(id, text) {
            const el = document.getElementById(id);
            if (el) el.innerHTML = parseMarkdown(text || '');
        }

        function parseMarkdown(text) {
            if (!text) return '';
            // Basic bold support
            return text.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        }

        function showError(msg) {
            const el = document.getElementById('error-message');
            if (el) {
                el.textContent = msg;
                el.style.display = 'block';
            }
            safeSetText('last-sync', 'Error');
        }

        // HRV Support
        let currentHRVEndDate = new Date();
        let currentHRVRange = '1d';

        async function updateHRVRange(range, btn) {
            if (range) currentHRVRange = range;
            if (btn) {
                btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            try {
                const res = await fetch(`/api/hrv?end_date=${currentHRVEndDate.toISOString().split('T')[0]}&range=${currentHRVRange}`);
                if (res.ok) {
                    const data = await res.json();
                    if (!data.error) renderHRVVisual(data);
                }
            } catch (err) {
                console.error('HRV error:', err);
            }
        }

        function shiftHRVDate(dir) {
            currentHRVEndDate.setDate(currentHRVEndDate.getDate() + (dir * (currentHRVRange === '1d' ? 1 : 7)));
            if (currentHRVEndDate > new Date()) currentHRVEndDate = new Date();
            updateHRVRange();
        }

        function renderHRVVisual(data) {
            const canvasId = 'hrvHistoryChart';
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const statusContainer = document.getElementById('hrv-status-container');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            const range = data.range || currentHRVRange;

            if (range === '1d') {
                if (canvas) canvas.style.display = 'none';
                if (statusContainer) statusContainer.style.display = 'block';

                if (!data.hrvSummary) return;
                const summary = data.hrvSummary;

                // Use 7-day average (weeklyAvg) as the primary metric
                safeSetText('hrv-val', summary.weeklyAvg || '--');
                safeSetText('hrv-weekly-avg', `7d Avg: ${summary.weeklyAvg || '--'} ms`);

                const statusEl = document.getElementById('hrv-status-badge');
                if (statusEl) {
                    const status = summary.status || 'NO_STATUS';
                    statusEl.textContent = status.replace(/_/g, ' ');
                    statusEl.className = 'badge';

                    if (status === 'BALANCED') statusEl.classList.add('badge-balanced');
                    else if (status === 'UNBALANCED') statusEl.classList.add('badge-unbalanced');
                    else if (status === 'LOW') statusEl.classList.add('badge-low');
                    else statusEl.classList.add('badge-gray');
                }

                const baseline = summary.baseline;
                if (baseline) {
                    safeSetText('hrv-baseline-low', baseline.balancedLow || '--');
                    safeSetText('hrv-baseline-high', baseline.balancedUpper || '--');

                    const low = (baseline.balancedLow || 40) - 15;
                    const high = (baseline.balancedUpper || 80) + 15;
                    const rangeVal = high - low;
                    const val = summary.weeklyAvg || low;
                    const pct = Math.max(0, Math.min(100, ((val - low) / rangeVal) * 100));

                    const marker = document.getElementById('hrv-marker');
                    if (marker) marker.style.left = `${pct}%`;

                    const zone = document.getElementById('hrv-baseline-zone');
                    if (zone) {
                        const zoneStart = Math.max(0, ((baseline.balancedLow - low) / rangeVal) * 100);
                        const zoneWidth = ((baseline.balancedUpper - baseline.balancedLow) / rangeVal) * 100;
                        zone.style.left = `${zoneStart}%`;
                        zone.style.width = `${zoneWidth}%`;
                    }
                }

                const feedback = summary.feedbackPhrase || '';
                const friendlyFeedback = feedback
                    .replace(/HRV_STATUS_FEEDBACK_/g, '')
                    .replace(/HRV_UNBALANCED_/g, 'Unbalanced: ')
                    .replace(/_/g, ' ')
                    .toLowerCase()
                    .replace(/^\w/, c => c.toUpperCase());
                safeSetText('hrv-feedback', friendlyFeedback || 'No feedback available');

            } else {
                if (canvas) canvas.style.display = 'block';
                if (statusContainer) statusContainer.style.display = 'none';

                if (!data.history || data.history.length === 0) return;

                const labels = data.history.map(d => {
                    const p = d.calendarDate.split('-');
                    return p[1] + '/' + p[2];
                });

                const lastSummary = data.history[data.history.length - 1];
                if (lastSummary) {
                    safeSetText('hrv-val', lastSummary.weeklyAvg || '--');
                    safeSetText('hrv-weekly-avg', `7d Avg: ${lastSummary.weeklyAvg || '--'} ms`);

                    const statusEl = document.getElementById('hrv-status-badge');
                    if (statusEl) {
                        const status = lastSummary.status || 'NO_STATUS';
                        statusEl.textContent = status.replace(/_/g, ' ');
                        statusEl.className = 'badge';
                        if (status === 'BALANCED') statusEl.classList.add('badge-balanced');
                        else if (status === 'UNBALANCED') statusEl.classList.add('badge-unbalanced');
                        else if (status === 'LOW') statusEl.classList.add('badge-low');
                        else statusEl.classList.add('badge-gray');
                    }
                }

                // Prepare datasets for dot plot with shaded baseline
                const hrvData = data.history.map(d => d.weeklyAvg);
                const baselineHighs = data.history.map(d => d.baseline ? d.baseline.balancedUpper : null);
                const baselineLows = data.history.map(d => d.baseline ? d.baseline.balancedLow : null);

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [
                            {
                                label: 'HRV (7d Avg)',
                                data: hrvData,
                                borderColor: 'rgba(56, 189, 248, 0.5)',
                                backgroundColor: data.history.map(d => {
                                    if (d.status === 'BALANCED') return '#4ade80';
                                    if (d.status === 'UNBALANCED') return '#fb923c';
                                    if (d.status === 'LOW') return '#f87171';
                                    return '#38bdf8';
                                }),
                                pointRadius: 5,
                                pointHoverRadius: 7,
                                showLine: false, // Dot plot
                                order: 1
                            },
                            {
                                label: 'Baseline Upper',
                                data: baselineHighs,
                                borderColor: 'transparent',
                                backgroundColor: 'rgba(74, 222, 128, 0.1)',
                                fill: {
                                    target: 2,
                                    above: 'rgba(74, 222, 128, 0.1)'
                                },
                                pointRadius: 0,
                                tension: 0.2,
                                order: 2
                            },
                            {
                                label: 'Baseline Lower',
                                data: baselineLows,
                                borderColor: 'transparent',
                                pointRadius: 0,
                                fill: false,
                                tension: 0.2,
                                order: 2
                            }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                display: true,
                                labels: {
                                    color: '#94a3b8',
                                    filter: item => item.text !== 'Baseline Lower' && item.text !== 'Baseline Upper'
                                }
                            }
                        },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 7 } },
                            y: {
                                beginAtZero: false,
                                grid: { color: 'rgba(255,255,255,0.05)' },
                                ticks: { color: '#94a3b8' }
                            }
                        }
                    }
                });
            }
        }

        // Intensity Minutes Support
        let currentIMEndDate = new Date();
        let currentIMRange = '1w';

        async function updateIMRange(range, btn) {
            if (range) currentIMRange = range;
            if (btn) {
                btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            updateNavButtons('im', currentIMEndDate);
            try {
                const res = await fetch(`/api/intensity_minutes_history?range=${currentIMRange}&end_date=${getLocalDateStr(currentIMEndDate)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (!data.error) renderIntensityMinutesVisualV2(data);
                }
            } catch (err) {
                console.error('Intensity minutes error:', err);
            }
        }

        function shiftIMDate(dir) {
            const shift = currentIMRange === '1d' ? 1 : 7;
            currentIMEndDate.setDate(currentIMEndDate.getDate() + (dir * shift));
            if (currentIMEndDate > new Date()) currentIMEndDate = new Date();
            updateIMRange();
        }

        function renderIntensityMinutesVisual(data) {
            const canvasId = 'imHistoryChart';
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            const range = data.range || currentIMRange;
            const history = data.history || [];
            const goal = data.goal || 150;

            // Updated im-val should be the cumulative total for THIS WEEK (Mon-Sun)
            if (history.length > 0) {
                let thisWeekTotal = 0;
                // Walk backwards to find the current week's total starting Monday
                for (let i = history.length - 1; i >= 0; i--) {
                    const d = history[i];
                    const dt = parseLocalDate(d.date);
                    thisWeekTotal += d.total;
                    if (dt.getDay() === 1) break; // Monday found
                }
                safeSetText('im-val', thisWeekTotal);
                safeSetText('im-goal', goal);
            }

            if (range === '1d') {
                safeSetText('im-val', data.summary.total || '0');
                safeSetText('im-goal', data.summary.goal || '150');

                // Cumulative for the day, starting from startDayMinutes (total at beginning of day)
                let cumulative = data.summary.startDayMinutes || 0;
                const points = data.samples.map(s => {
                    cumulative += s[1];
                    return { x: s[0], y: cumulative };
                });

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Intensity Minutes',
                            data: points,
                            borderColor: '#38bdf8',
                            backgroundColor: 'rgba(56, 189, 248, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { type: 'time', time: { displayFormats: { hour: 'HH:mm' } }, grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            } else if (range === '1w') {
                const lastDay = data.history[data.history.length - 1];
                safeSetText('im-val', lastDay ? lastDay.total : '--');
                safeSetText('im-goal', data.goal || '150');

                // Calculate cumulative, resetting on Monday
                let cumulative = 0;
                const cumulativeData = data.history.map(d => {
                    const date = parseLocalDate(d.date);
                    if (date.getDay() === 1) cumulative = 0; // Monday reset
                    cumulative += d.total;
                    return cumulative;
                });

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.history.map(d => parseLocalDate(d.date).toLocaleDateString([], { weekday: 'short' })),
                        datasets: [{
                            label: 'Cumulative Intensity Minutes',
                            data: cumulativeData,
                            borderColor: '#38bdf8',
                            borderWidth: 3,
                            pointRadius: 4,
                            fill: true,
                            backgroundColor: 'rgba(56, 189, 248, 0.1)',
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            } else if (range === '1m') {
                // Separate lines for each week (last 4 weeks)
                const lastDay = data.history[data.history.length - 1];
                safeSetText('im-val', lastDay ? lastDay.total : '--');

                const weeks = [];
                for (let i = 0; i < data.history.length; i += 7) {
                    weeks.push(data.history.slice(i, i + 7));
                }

                const datasets = weeks.map((week, idx) => {
                    let cumulative = 0;
                    const cData = week.map(d => {
                        cumulative += d.total;
                        return cumulative;
                    });

                    return {
                        label: `Week ${weeks.length - idx}`,
                        data: cData,
                        borderColor: `hsla(${200 + idx * 40}, 70%, 60%, ${1 - idx * 0.2})`,
                        borderWidth: idx === 0 ? 3 : 2,
                        pointRadius: idx === 0 ? 3 : 0,
                        tension: 0.1,
                        fill: idx === 0 ? 'origin' : false,
                        backgroundColor: idx === 0 ? 'rgba(56, 189, 248, 0.05)' : 'transparent'
                    };
                }).reverse();

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: ['Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat', 'Sun'],
                        datasets: datasets
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: true, position: 'top', labels: { color: '#94a3b8', boxWidth: 10 } } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            } else { // 6m or 1y
                const lastWeek = history[history.length - 1];
                safeSetText('im-val', lastWeek ? lastWeek.total : '--');
                safeSetText('im-goal', lastWeek ? lastWeek.goal : '150');

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: history.map((d, i) => (i % 4 === 0) ? parseLocalDate(d.date).toLocaleDateString([], { month: 'short', day: 'numeric' }) : ''),
                        datasets: [{
                            label: 'Weekly Total',
                            data: history.map(d => d.total),
                            backgroundColor: history.map(d => d.total >= d.goal ? '#4ade80' : '#38bdf8'),
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94a3b8', autoSkip: false } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }

        // --- Settings Management ---

        let currentSettings = null;
        let selectedModel = null;

        async function openSettings() {
            const modal = document.getElementById('settingsModal');
            if (!modal) return;

            try {
                const res = await fetch('/api/settings');
                if (res.ok) {
                    currentSettings = await res.json();
                    selectedModel = currentSettings.ai_model;
                    renderModelOptions(currentSettings);
                    modal.classList.add('active');
                }
            } catch (err) {
                console.error('Failed to load settings:', err);
                showSettingsStatus('Failed to load settings', 'error');
            }
        }

        function closeSettings() {
            const modal = document.getElementById('settingsModal');
            if (modal) modal.classList.remove('active');
        }

        function renderModelOptions(settings) {
            const container = document.getElementById('model-options');
            if (!container) return;

            container.innerHTML = '';
            const models = settings.available_models || [];

            models.forEach(model => {
                const isSelected = model.id === selectedModel;
                const optionDiv = document.createElement('div');
                optionDiv.style.cssText = `
                    padding: 1rem;
                    border: 2px solid ${isSelected ? 'var(--accent-color)' : 'rgba(255,255,255,0.1)'};
                    border-radius: 0.75rem;
                    cursor: pointer;
                    transition: all 0.2s;
                    background: ${isSelected ? 'rgba(56, 189, 248, 0.05)' : 'transparent'};
                `;

                optionDiv.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 1rem;">
                        <input type="radio" name="ai-model" value="${model.id}" ${isSelected ? 'checked' : ''} 
                               style="width: 20px; height: 20px; cursor: pointer; accent-color: var(--accent-color);">
                        <div style="flex: 1;">
                            <div style="font-weight: 600; margin-bottom: 0.25rem;">${model.name}</div>
                            <div style="font-size: 0.85rem; color: var(--text-secondary);">${model.description}</div>
                        </div>
                    </div>
                `;

                optionDiv.onclick = () => {
                    selectedModel = model.id;
                    renderModelOptions(settings);
                };

                container.appendChild(optionDiv);
            });
        }

        async function saveSettings() {
            if (!selectedModel) {
                showSettingsStatus('Please select a model', 'error');
                return;
            }

            showSettingsStatus('Saving...', 'info');

            try {
                const res = await fetch('/api/settings', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ ai_model: selectedModel })
                });

                if (res.ok) {
                    const result = await res.json();
                    if (result.success) {
                        showSettingsStatus('Settings saved! AI insights will be regenerated.', 'success');
                        setTimeout(() => {
                            closeSettings();
                            // Refresh AI insights with new model
                            fetchAIInsights();
                        }, 1500);
                    } else {
                        showSettingsStatus('Failed to save settings', 'error');
                    }
                } else {
                    showSettingsStatus('Failed to save settings', 'error');
                }
            } catch (err) {
                console.error('Failed to save settings:', err);
                showSettingsStatus('Error saving settings', 'error');
            }
        }

        function showSettingsStatus(message, type) {
            const status = document.getElementById('settings-status');
            if (!status) return;

            const colors = {
                success: { bg: 'rgba(74, 222, 128, 0.1)', text: '#4ade80' },
                error: { bg: 'rgba(248, 113, 113, 0.1)', text: '#f87171' },
                info: { bg: 'rgba(56, 189, 248, 0.1)', text: '#38bdf8' }
            };

            const color = colors[type] || colors.info;
            status.style.background = color.bg;
            status.style.color = color.text;
            status.style.display = 'block';
            status.textContent = message;
        }

        async function fetchAIInsights() {
            const thinking = document.getElementById('ai-thinking');
            const grid = document.getElementById('ai-content-grid');
            const error = document.getElementById('ai-error');
            const modelLabel = document.getElementById('ai-model-name');
            const section = document.getElementById('ai-insights-section');

            if (section) section.style.display = 'block';
            if (thinking) thinking.style.display = 'flex';
            if (grid) grid.style.display = 'none';
            if (error) error.style.display = 'none';

            // Creative thinking messages
            const messages = [
                "Scanning metabolic history...",
                "Calculating power-to-weight trends...",
                "Analyzing recovery efficiency...",
                "Identifying training outliers...",
                "Optimizing cardiac drift profiles...",
                "Benchmarking YTD milestones...",
                "Synthesizing coach insights..."
            ];
            let msgIdx = 0;
            const msgEl = document.getElementById('ai-loading-msg');
            const interval = setInterval(() => {
                if (msgEl) {
                    msgEl.style.opacity = 0;
                    setTimeout(() => {
                        msgEl.textContent = messages[msgIdx % messages.length];
                        msgEl.style.opacity = 1;
                        msgIdx++;
                    }, 200);
                }
            }, 3000);

            try {
                const res = await fetch('/api/ai_insights');
                clearInterval(interval);

                if (res.ok) {
                    const data = await res.json();

                    if (data.error) {
                        if (thinking) thinking.style.display = 'none';
                        if (grid) grid.style.display = 'none';
                        if (error) {
                            error.style.display = 'block';
                            const titleEl = document.getElementById('ai-err-title');
                            const detailsEl = document.getElementById('ai-err-details');

                            titleEl.textContent = "Analysis Interrupted";
                            detailsEl.innerHTML = `<div style="margin-bottom: 0.5rem; font-weight: 600;">${data.error}</div><div style="font-size: 0.75rem; opacity: 0.7; font-family: monospace; background: rgba(0,0,0,0.2); padding: 0.5rem; border-radius: 0.25rem; overflow-x: auto; text-align: left;">${data.details || ''}</div>`;

                            if (data.error.toLowerCase().includes('quota') || data.error.includes('429')) {
                                titleEl.textContent = "Model Capacity Reached";
                            }
                        }
                        return;
                    }

                    if (thinking) thinking.style.display = 'none';
                    if (grid) grid.style.display = 'grid';

                    safeSetHTML('ai-daily-summary', data.daily_summary);
                    safeSetHTML('ai-yesterday-summary', data.yesterday_summary);
                    safeSetHTML('ai-suggestions', data.suggestions);

                    const titleEl = document.getElementById('ai-insight-title');
                    if (titleEl) {
                        titleEl.textContent = data.is_ai ? "AI Training Insight" : "Training Insight";
                    }

                    if (data.model_name) {
                        cachedModelName = data.model_name;
                        if (modelLabel) modelLabel.textContent = formatModelName(data.model_name);
                    }

                    if (data.activity_insights) {
                        data.activity_insights.forEach(insight => {
                            if (insight.activity_id) cachedActivityInsights[insight.activity_id] = insight;
                        });
                    }
                } else {
                    throw new Error(`Server responded with ${res.status}`);
                }
            } catch (err) {
                clearInterval(interval);
                console.error('AI insights error:', err);
                if (thinking) thinking.style.display = 'none';
                if (grid) grid.style.display = 'none';
                if (error) {
                    error.style.display = 'block';
                    document.getElementById('ai-err-title').textContent = "Connection Terminated";
                    document.getElementById('ai-err-details').textContent = err.message || "The analyst core is currently offline.";
                }
            }
        }

        async function fetchData() {
            // 1. Fetch AI Insights (HIGHEST PRIORITY - Start immediately, don't block others)
            fetchAIInsights();

            try {
                // 2. Fetch basic stats (Medium Priority)
                const statsRes = await fetch('/api/stats');
                if (statsRes.ok) {
                    const stats = await statsRes.json();
                    if (!stats.error) updateDashboard(stats);
                    else showError(stats.error);
                } else {
                    console.error("Stats fetch failed with status:", statsRes.status);
                    const activityList = document.getElementById('activity-list');
                    if (activityList) activityList.innerHTML = '<div class="activity-item" style="justify-content: center;">Failed to load activities</div>';
                }

                // 3. Fetch configurations and summaries
                const [goalsRes, ltRes, ytdRes] = await Promise.allSettled([
                    fetch('/api/goals_config'),
                    fetch('/api/longterm_stats'),
                    fetch('/api/ytd_mileage_comparison')
                ]);

                if (goalsRes.status === 'fulfilled' && goalsRes.value.ok) {
                    const goalsConfig = await goalsRes.value.json();
                    if (!goalsConfig.error) {
                        const runGoalEl = document.getElementById('month-run-goal');
                        const cycleGoalEl = document.getElementById('month-cycle-goal');
                        const yearRunGoalEl = document.getElementById('year-run-goal');
                        const yearCycleGoalEl = document.getElementById('year-cycle-goal');

                        if (runGoalEl) runGoalEl.innerHTML = formatDualDistance(goalsConfig.monthly.running);
                        if (cycleGoalEl) cycleGoalEl.innerHTML = formatDualDistance(goalsConfig.monthly.cycling);
                        if (yearRunGoalEl) yearRunGoalEl.innerHTML = formatDualDistance(goalsConfig.yearly.running);
                        if (yearCycleGoalEl) yearCycleGoalEl.innerHTML = formatDualDistance(goalsConfig.yearly.cycling);
                    } else {
                        console.error("Goals config error:", goalsConfig.error);
                    }
                } else if (goalsRes.status === 'rejected') {
                    console.error("Goals fetch failed:", goalsRes.reason);
                }

                if (ltRes.status === 'fulfilled' && ltRes.value.ok) {
                    const ltStats = await ltRes.value.json();
                    if (!ltStats.error) updateLongtermStats(ltStats);
                    else console.error("Longterm stats error:", ltStats.error);
                } else if (ltRes.status === 'rejected') {
                    console.error("Longterm stats fetch failed:", ltRes.reason);
                }

                if (ytdRes.status === 'fulfilled' && ytdRes.value.ok) {
                    const ytdData = await ytdRes.value.json();
                    if (!ytdData.error) {
                        renderYTDChart('ytdCyclingChart', ytdData.labels, ytdData.cycling);
                        renderYTDChart('ytdRunningChart', ytdData.labels, ytdData.running);
                    } else {
                        console.error("YTD mileage comparison error:", ytdData.error);
                    }
                } else if (ytdRes.status === 'rejected') {
                    console.error("YTD fetch failed:", ytdRes.reason);
                }

                // 4. Initialize historical charts (Parallel)
                await Promise.allSettled([
                    updateWeightRange('1m'),
                    updateStepsRange('1w'),
                    updateHRRange('1d'),
                    updateStressRange('1d'),
                    updateSleepRange('1d'),
                    updateHydrationRange('1d'),
                    updateHRVRange('1d'),
                    updateIMRange('1w'),
                    fetchCalendarData(),
                    fetchNutritionData()
                ]);

                // 5. Light status update
                const syncEl = document.getElementById('last-sync');
                if (syncEl) syncEl.textContent = 'Synced: ' + new Date().toLocaleTimeString();

                // 6. Heavy Route Overlays (LOWEST PRIORITY - Load last after everything else)
                setTimeout(() => {
                    fetchActivityHeatmap();
                    updateGlobalHeatmap();
                }, 1500);

            } catch (err) {
                console.error("Dashboard load error:", err);
                showError('Could not load dashboard fully. Check console.');
            }
        }

        // Expose functions to global window scope so onclick handlers work
        window.shiftNutritionDate = shiftNutritionDate;
        window.resetNutritionToToday = resetNutritionToToday;
        window.openFoodModal = openFoodModal;
        window.closeFoodModal = closeFoodModal;
        window.onFoodSearchInput = onFoodSearchInput;
        window.selectFood = selectFood;
        window.submitFoodLog = submitFoodLog;
        window.showCustomFoodForm = showCustomFoodForm;
        window.hideCustomFoodForm = hideCustomFoodForm;
        window.addIngredientRow = addIngredientRow;
        window.saveCustomFood = saveCustomFood;
        window.deleteFoodLog = deleteFoodLog;
        window.editAnyMeal = editAnyMeal;
        window.refreshNutritionAnalysis = refreshNutritionAnalysis;
        window.editLibraryItem = editLibraryItem;
        window.logFromLibrary = logFromLibrary;
        window.closeLibraryModal = closeLibraryModal;
        window.openLibraryModal = openLibraryModal;
        window.updateDashboard = function (data) {
            safeSetText('steps', data.steps ? data.steps.toLocaleString() : '0');
            safeSetText('rhr', data.resting_hr || '--');
            safeSetText('stress', data.stress_avg || '--');

            if (data.weight_grams) {
                const kg = (data.weight_grams / 1000).toFixed(1);
                const lbs = (kg * 2.20462).toFixed(1);
                safeSetText('weight', lbs + ' lbs');
                safeSetText('weight-dual', kg + ' kg');
            }

            const sleepHours = data.sleep_seconds ? (data.sleep_seconds / 3600).toFixed(1) : '--';
            safeSetText('sleep', sleepHours);
            safeSetText('sleep-score-val', data.sleep_score || '--');

            const activityList = document.getElementById('activity-list');
            if (activityList) {
                activityList.innerHTML = '';
                if (data.activities && data.activities.length > 0) {
                    data.activities.forEach(activity => {
                        if (!activity) return;
                        const el = document.createElement('div');
                        el.className = 'activity-item' + (activity.is_grouped ? ' grouped-session' : '');

                        const startTime = activity.startTimeLocal || new Date().toISOString();
                        const date = new Date(startTime).toLocaleDateString([], { month: 'short', day: 'numeric' });
                        const dist = activity.distance || 0;
                        const distanceKm = (dist / 1000).toFixed(2);
                        const distanceMi = (dist / 1609.34).toFixed(2);
                        const dur = activity.duration || 0;
                        const durationMin = Math.round(dur / 60);

                        const typeKey = (activity.activityType && activity.activityType.typeKey) || 'other';
                        const typeDisplay = (activity.activityType && activity.activityType.display) || 'Activity';
                        const actName = activity.activityName || 'Activity';

                        el.innerHTML = `
                            <div class="activity-info">
                                <div class="activity-icon">${getActivityIcon(typeKey)}</div>
                                <div class="activity-details">
                                    <h3 style="display: flex; align-items: center; gap: 0.5rem;">
                                        ${actName}
                                        ${activity.is_grouped ? `<span class="grouped-badge">${(activity.grouped_activities || []).length} Stages</span>` : ''}
                                    </h3>
                                    <div class="activity-meta">${date} ‚Ä¢ ${typeDisplay}</div>
                                </div>
                            </div>
                            <div class="activity-stats">
                                <div class="stat-group">
                                    <div>${distanceMi} mi / ${distanceKm} km</div>
                                    <div>distance</div>
                                </div>
                                <div class="stat-group">
                                    <div>${durationMin}</div>
                                    <div>min</div>
                                </div>
                            </div>
                        `;
                        el.onclick = () => openActivityDetail(activity.activityId, activity);
                        activityList.appendChild(el);
                    });
                }
                else {
                    activityList.innerHTML = '<div class="activity-item" style="justify-content: center;">No recent activities found</div>';
                }
            }
        }

        function getActivityIcon(type) {
            if (type.includes('running')) return 'üèÉ';
            if (type.includes('cycling') || type.includes('ride')) return 'üö¥';
            if (type.includes('swimming')) return 'üèä';
            if (type.includes('walking')) return 'üö∂';
            if (type.includes('strength')) return 'üí™';
            return '‚ö°';
        }

        function updateLongtermStats(data) {
            const getSafeGoal = (id) => {
                const el = document.getElementById(id);
                if (!el) return 1;
                const val = parseFloat(el.textContent);
                return (isNaN(val) || val <= 0) ? 1 : val;
            };

            const updateMetric = (type, timeframe, goalId, valId, percentId, chartId) => {
                const goal = getSafeGoal(goalId);
                const value = data[timeframe][type];
                const percent = Math.min(100, Math.round((value / goal) * 100));

                const valEl = document.getElementById(valId);
                const percentEl = document.getElementById(percentId);
                const chartEl = document.getElementById(chartId);

                if (valEl) valEl.innerHTML = formatDualDistance(value);
                if (percentEl) percentEl.textContent = percent + '%';
                if (chartEl) chartEl.style.background = `conic-gradient(var(--accent-color) 0% ${percent}%, rgba(255,255,255,0.1) ${percent}% 100%)`;
            };

            updateMetric('running', 'month', 'month-run-goal', 'month-run', 'month-run-percent', 'month-run-chart');
            updateMetric('cycling', 'month', 'month-cycle-goal', 'month-cycle', 'month-cycle-percent', 'month-cycle-chart');
            updateMetric('running', 'year', 'year-run-goal', 'year-run', 'year-run-percent', 'year-run-chart');
            updateMetric('cycling', 'year', 'year-cycle-goal', 'year-cycle', 'year-cycle-percent', 'year-cycle-chart');
        }

        // --- Historical & Chart Functions ---

        function resetChartZoom(id) {
            if (chartInstances[id]) chartInstances[id].resetZoom();
        }

        function renderYTDChart(canvasId, labels, data) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [
                        { label: '2024', data: data.years['2024'], borderColor: '#818cf8', backgroundColor: 'rgba(129, 140, 248, 0.1)', borderWidth: 2, tension: 0.1, pointRadius: 0 },
                        { label: '2025', data: data.years['2025'], borderColor: '#38bdf8', backgroundColor: 'rgba(56, 189, 248, 0.1)', borderWidth: 2, tension: 0.1, pointRadius: 0 },
                        { label: '2026 (Current)', data: data.years['2026'], borderColor: '#4ade80', backgroundColor: 'rgba(74, 222, 128, 0.1)', borderWidth: 3, tension: 0.1, pointRadius: 0 },
                        { label: `Goal (${data.yearly_goal} mi)`, data: data.goal_line, borderColor: '#f87171', backgroundColor: 'rgba(248, 113, 113, 0.1)', borderWidth: 2, borderDash: [5, 5], tension: 0, pointRadius: 0 }
                    ]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } },
                        legend: { position: 'top', labels: { color: '#f1f5f9', boxWidth: 12, boxHeight: 2, padding: 10, font: { size: 11 } } },
                        tooltip: { callbacks: { label: (ctx) => `${ctx.dataset.label}: ${ctx.parsed.y.toFixed(1)} mi / ${(ctx.parsed.y * 1.60934).toFixed(1)} km` } }
                    },
                    scales: {
                        y: { beginAtZero: true, ticks: { color: '#94a3b8', font: { size: 12 }, callback: val => val + ' mi' }, grid: { color: 'rgba(255, 255, 255, 0.1)' } },
                        x: { ticks: { color: '#94a3b8', font: { size: 12 }, maxTicksLimit: 15 }, grid: { color: 'rgba(255, 255, 255, 0.1)' } }
                    }
                }
            });
        }

        let currentWeightEndDate = new Date();
        let currentWeightRange = '1m';
        async function updateWeightRange(range, btn) {
            if (range) currentWeightRange = range;
            if (btn) {
                btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            updateNavButtons('weight', currentWeightEndDate);
            try {
                const res = await fetch(`/api/weight_history?range=${currentWeightRange}&end_date=${getLocalDateStr(currentWeightEndDate)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (!data.error) renderWeightChart(data, currentWeightRange);
                }
            } catch (err) { console.error('Weight history error:', err); }
        }

        function renderWeightChart(history, range) {
            const canvasId = 'weightHistoryChart';
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            const weights = history.map(d => d.weight_lbs);
            const min = Math.floor(Math.min(...weights) - 2);
            const max = Math.ceil(Math.max(...weights) + 2);

            chartInstances[canvasId] = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{ label: 'Weight (lbs)', data: history.map(d => ({ x: d.date, y: d.weight_lbs })), borderColor: '#818cf8', backgroundColor: 'rgba(129, 140, 248, 0.1)', borderWidth: 3, tension: 0.3, pointRadius: 3, fill: true }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false,
                    plugins: {
                        zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } },
                        legend: { display: false },
                        tooltip: { callbacks: { label: (ctx) => `Weight: ${ctx.parsed.y.toFixed(1)} lbs` } }
                    },
                    scales: {
                        x: { type: 'time', time: { unit: 'month' }, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } },
                        y: { min, max, ticks: { color: '#94a3b8', callback: v => v + ' lbs' }, grid: { color: 'rgba(255,255,255,0.1)' } }
                    }
                }
            });
        }

        let currentStepsEndDate = new Date();
        let currentStepsRange = '1w';
        async function updateStepsRange(range, btn) {
            if (range) currentStepsRange = range;
            if (btn) {
                btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            updateNavButtons('steps', currentStepsEndDate);
            try {
                const res = await fetch(`/api/steps_history?range=${currentStepsRange}&end_date=${getLocalDateStr(currentStepsEndDate)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (!data.error) renderStepsVisual(data);
                }
            } catch (err) { console.error('Steps history error:', err); }
        }

        function renderStepsVisual(data) {
            const canvasId = 'stepsHistoryChart';
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            const donutContainer = document.getElementById('steps-donut-container');
            const streakEl = document.getElementById('steps-streak');
            if (streakEl) streakEl.textContent = data.streak || 0;

            if (data.range === '1d') {
                if (canvas) canvas.style.display = 'none';
                if (donutContainer) donutContainer.style.display = 'flex';
                const day = data.history[data.history.length - 1] || { totalSteps: 0, stepGoal: 10000 };
                const percent = Math.min(100, Math.round((day.totalSteps / day.stepGoal) * 100));
                safeSetText('steps', day.totalSteps.toLocaleString());
                safeSetText('steps-day-percent', percent + '%');
                const chart = document.getElementById('steps-day-chart');
                if (chart) chart.style.background = `conic-gradient(${percent >= 100 ? 'var(--success-color)' : 'var(--accent-color)'} 0% ${percent}%, rgba(255,255,255,0.1) ${percent}% 100%)`;
            } else {
                if (canvas) canvas.style.display = 'block';
                if (donutContainer) donutContainer.style.display = 'none';
                if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: data.history.map(d => { const p = d.calendarDate.split('-'); return `${p[1]}/${p[2]}`; }),
                        datasets: [{ label: 'Steps', data: data.history.map(d => d.totalSteps), backgroundColor: data.history.map(d => d.totalSteps >= d.stepGoal ? '#4ade80' : '#38bdf8'), borderRadius: 4 }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } },
                            legend: { display: false },
                            tooltip: { callbacks: { label: (ctx) => `Steps: ${ctx.parsed.y.toLocaleString()}` } }
                        },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94a3b8', maxTicksLimit: 7 } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }

        let currentHREndDate = new Date();
        let currentHRRange = '1d';
        async function updateHRRange(range, btn) {
            if (range) currentHRRange = range;
            if (btn) {
                btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            updateNavButtons('hr', currentHREndDate);
            try {
                const res = await fetch(`/api/hr_history?range=${currentHRRange}&end_date=${getLocalDateStr(currentHREndDate)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (!data.error) renderHRVisual(data);
                }
            } catch (err) { console.error('HR history error:', err); }
        }

        function renderHRVisual(data) {
            const canvasId = 'hrHistoryChart';
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            if (data.range === '1d') {
                const maxHR = data.max_hr || 190;
                const zones = data.zones || [95, 114, 133, 152, 171];
                safeSetText('hr-max-val', data.summary.max || '--');

                const points = data.samples.map(s => ({ x: s[0], y: s[1] }));
                const getZoneColor = (hr) => {
                    if (hr >= zones[4]) return '#a855f7';
                    if (hr >= zones[3]) return '#ef4444';
                    if (hr >= zones[2]) return '#f97316';
                    if (hr >= zones[1]) return '#22c55e';
                    if (hr >= zones[0]) return '#3b82f6';
                    return '#94a3b8';
                };

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Heart Rate',
                            data: points,
                            borderWidth: 2,
                            pointRadius: 0,
                            segment: { borderColor: ctx => getZoneColor(ctx.p1.parsed.y) },
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } } },
                        scales: {
                            x: { type: 'time', time: { displayFormats: { hour: 'HH:mm', minute: 'HH:mm' } }, grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { min: 40, max: Math.max(200, maxHR + 5), grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            } else {
                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.history.map(d => d.date),
                        datasets: [
                            { label: 'Resting HR', data: data.history.map(d => d.rhr), borderColor: '#38bdf8', backgroundColor: 'rgba(56, 189, 248, 0.1)', borderWidth: 3, fill: true, tension: 0.3 },
                            { label: 'Max HR', data: data.history.map(d => d.max), borderColor: '#ef4444', borderDash: [5, 5], borderWidth: 2, pointRadius: 2, tension: 0.3 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } },
                            legend: { display: true, position: 'top', labels: { color: '#94a3b8', boxWidth: 12 } }
                        },
                        scales: {
                            x: { type: 'time', time: { unit: 'day' }, grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }

        let currentStressEndDate = new Date();
        let currentStressRange = '1d';
        async function updateStressRange(range, btn) {
            if (range) currentStressRange = range;
            if (btn) {
                btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            updateNavButtons('stress', currentStressEndDate);
            try {
                const res = await fetch(`/api/stress_history?range=${currentStressRange}&end_date=${getLocalDateStr(currentStressEndDate)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (!data.error) renderStressVisual(data);
                }
            } catch (err) { console.error('Stress history error:', err); }
        }

        function renderStressVisual(data) {
            const canvasId = 'stressHistoryChart';
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            if (data.range === '1d') {
                safeSetText('stress', data.summary.avg || '--');
                const points = data.samples.map(s => ({ x: s[0], y: s[1] }));
                const getStressColor = (val) => {
                    if (val < 0) return 'rgba(148, 163, 184, 0.1)';
                    if (val <= 25) return '#94a3b8';
                    if (val <= 50) return '#f97316';
                    if (val <= 75) return '#f43f5e';
                    return '#ef4444';
                };

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Stress',
                            data: points,
                            borderWidth: 2,
                            pointRadius: 0,
                            segment: { borderColor: ctx => getStressColor(ctx.p1.parsed.y) },
                            tension: 0.4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } } },
                        scales: {
                            x: { type: 'time', time: { displayFormats: { hour: 'HH:mm', minute: 'HH:mm' } }, grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { min: 0, max: 100, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            } else {
                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.history.map(d => d.date),
                        datasets: [
                            { label: 'Avg Stress', data: data.history.map(d => d.avg), borderColor: '#f97316', backgroundColor: 'rgba(249, 115, 22, 0.1)', borderWidth: 3, fill: true, tension: 0.3 },
                            { label: 'Max Stress', data: data.history.map(d => d.max), borderColor: '#ef4444', borderDash: [5, 5], borderWidth: 2, pointRadius: 2, tension: 0.3 }
                        ]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: {
                            zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } },
                            legend: { display: true, labels: { color: '#94a3b8' } }
                        },
                        scales: {
                            x: { type: 'time', time: { unit: 'day' }, grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { min: 0, max: 100, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }

        let currentSleepEndDate = new Date();
        let currentSleepRange = '1d';
        async function updateSleepRange(range, btn) {
            if (range) currentSleepRange = range;
            if (btn) {
                btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active'));
                btn.classList.add('active');
            }
            updateNavButtons('sleep', currentSleepEndDate);
            try {
                const res = await fetch(`/api/sleep_history?range=${currentSleepRange}&end_date=${getLocalDateStr(currentSleepEndDate)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (!data.error) renderSleepVisual(data);
                }
            } catch (err) { console.error('Sleep history error:', err); }
        }

        function renderSleepVisual(data) {
            const canvasId = 'sleepHistoryChart';
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            if (data.range === '1d') {
                const s = data.summary;
                safeSetText('sleep', (s.total / 3600).toFixed(1));
                safeSetText('sleep-score-val', s.score || '--');
                const stageData = [
                    { label: 'Deep', value: s.deep || 0, color: '#6366f1' },
                    { label: 'Light', value: s.light || 0, color: '#3b82f6' },
                    { label: 'REM', value: s.rem || 0, color: '#2dd4bf' },
                    { label: 'Awake', value: s.awake || 0, color: '#f97316' }
                ].filter(d => d.value > 0);

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'doughnut',
                    data: { labels: stageData.map(d => d.label), datasets: [{ data: stageData.map(d => d.value), backgroundColor: stageData.map(d => d.color), borderWidth: 0 }] },
                    options: {
                        responsive: true, maintainAspectRatio: false, cutout: '70%', plugins: {
                            legend: { display: true, position: 'right', labels: { color: '#94a3b8', boxWidth: 12, padding: 20 } },
                            tooltip: { callbacks: { label: (ctx) => `${ctx.label}: ${Math.floor(ctx.raw / 3600)}h ${Math.round((ctx.raw % 3600) / 60)}m` } }
                        }
                    }
                });
            } else {
                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: data.history.map(d => d.date),
                        datasets: [{ label: 'Sleep Score', data: data.history.map(d => d.score), borderColor: '#818cf8', backgroundColor: 'rgba(129, 140, 248, 0.1)', borderWidth: 3, fill: true, tension: 0.3, pointRadius: 4 }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false }, zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } } },
                        scales: {
                            x: { type: 'time', time: { unit: 'day' }, grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { min: 0, max: 100, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }

        let currentHydrationRange = '1d';
        let currentHydrationEndDate = new Date();
        async function updateHydrationRange(range, btn) {
            if (range) currentHydrationRange = range;
            if (btn) { btn.parentElement.querySelectorAll('.range-btn').forEach(b => b.classList.remove('active')); btn.classList.add('active'); }
            const donut = document.getElementById('hydration-donut-container');
            const hChartCanvas = document.getElementById('hydrationHistoryChart');
            if (donut) donut.style.display = currentHydrationRange === '1d' ? 'block' : 'none';
            if (hChartCanvas) hChartCanvas.style.display = currentHydrationRange === '1d' ? 'none' : 'block';
            updateNavButtons('hydration', currentHydrationEndDate);
            await renderHydrationVisual();
        }

        async function renderHydrationVisual() {
            try {
                const res = await fetch(`/api/hydration_history?range=${currentHydrationRange}&end_date=${getLocalDateStr(currentHydrationEndDate)}`);
                if (res.ok) {
                    const data = await res.json();
                    if (data.error) return;
                    const oz = (ml) => (ml * 0.033814).toFixed(1);
                    if (currentHydrationRange === '1d') {
                        const p = Math.min(100, Math.round((data.summary.intake / data.summary.goal) * 100));
                        safeSetText('hydration-val', oz(data.summary.intake) + ' oz');
                        safeSetText('hydration-goal', 'Goal: ' + oz(data.summary.goal) + ' oz');
                        safeSetText('hydration-percent', p + '%');
                        const hChart = document.getElementById('hydration-chart');
                        if (hChart) hChart.style.background = `conic-gradient(${p >= 100 ? '#22c55e' : '#38bdf8'} ${p}%, rgba(255,255,255,0.05) ${p}% 100%)`;
                    } else {
                        const ctx = document.getElementById('hydrationHistoryChart').getContext('2d');
                        if (chartInstances['hydrationHistoryChart']) chartInstances['hydrationHistoryChart'].destroy();
                        chartInstances['hydrationHistoryChart'] = new Chart(ctx, {
                            type: 'bar',
                            data: { labels: data.history.map(d => parseLocalDate(d.date).toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' })), datasets: [{ label: 'oz', data: data.history.map(d => parseFloat(oz(d.intake))), backgroundColor: data.history.map(d => d.intake >= d.goal ? '#22c55e' : '#38bdf8'), borderRadius: 6 }] },
                            options: {
                                responsive: true, maintainAspectRatio: false,
                                plugins: {
                                    zoom: { pan: { enabled: true, mode: 'x' }, zoom: { wheel: { enabled: true }, pinch: { enabled: true }, mode: 'x' } },
                                    legend: { display: false }
                                },
                                scales: { y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' } }, x: { grid: { display: false } } }
                            }
                        });
                    }
                }
            } catch (err) { console.error('Hydration error:', err); }
        }

        function updateNavButtons(metric, endDate) {
            const nextBtn = document.getElementById(`${metric}-next`);
            if (nextBtn) {
                const todayStr = getLocalDateStr(new Date());
                const endStr = getLocalDateStr(endDate);
                nextBtn.disabled = (endStr >= todayStr);
            }
        }

        function shiftStepsDate(dir) {
            const shift = currentStepsRange === '1d' ? 1 : (currentStepsRange === '1w' ? 7 : (currentStepsRange === '1m' ? 30 : 365));
            currentStepsEndDate.setDate(currentStepsEndDate.getDate() + (dir * shift));
            if (currentStepsEndDate > new Date()) currentStepsEndDate = new Date();
            updateNavButtons('steps', currentStepsEndDate);
            updateStepsRange();
        }

        function shiftSleepDate(dir) {
            const shift = currentSleepRange === '1d' ? 1 : (currentSleepRange === '1w' ? 7 : (currentSleepRange === '1m' ? 30 : 365));
            currentSleepEndDate.setDate(currentSleepEndDate.getDate() + (dir * shift));
            if (currentSleepEndDate > new Date()) currentSleepEndDate = new Date();
            updateNavButtons('sleep', currentSleepEndDate);
            updateSleepRange();
        }

        function shiftHydrationDate(dir) {
            const shift = currentHydrationRange === '1d' ? 1 : (currentHydrationRange === '1w' ? 7 : (currentHydrationRange === '1m' ? 30 : 365));
            currentHydrationEndDate.setDate(currentHydrationEndDate.getDate() + (dir * shift));
            if (currentHydrationEndDate > new Date()) currentHydrationEndDate = new Date();
            updateNavButtons('hydration', currentHydrationEndDate);
            renderHydrationVisual();
        }

        function shiftHRDate(dir) {
            const shift = currentHRRange === '1d' ? 1 : (currentHRRange === '1w' ? 7 : (currentHRRange === '1m' ? 30 : 365));
            currentHREndDate.setDate(currentHREndDate.getDate() + (dir * shift));
            if (currentHREndDate > new Date()) currentHREndDate = new Date();
            updateNavButtons('hr', currentHREndDate);
            updateHRRange();
        }

        function shiftStressDate(dir) {
            const shift = currentStressRange === '1d' ? 1 : (currentStressRange === '1w' ? 7 : (currentStressRange === '1m' ? 30 : 365));
            currentStressEndDate.setDate(currentStressEndDate.getDate() + (dir * shift));
            if (currentStressEndDate > new Date()) currentStressEndDate = new Date();
            updateNavButtons('stress', currentStressEndDate);
            updateStressRange();
        }

        function shiftWeightDate(dir) {
            const shift = currentWeightRange === '1m' ? 30 : (currentWeightRange === '6m' ? 180 : 365);
            currentWeightEndDate.setDate(currentWeightEndDate.getDate() + (dir * shift));
            if (currentWeightEndDate > new Date()) currentWeightEndDate = new Date();
            updateNavButtons('weight', currentWeightEndDate);
            updateWeightRange();
        }

        // --- Activity Modal & Detail Charts ---

        let activityMap = null;

        function renderActivityMap(polyline) {
            const container = document.getElementById('activity-map-container');
            if (!container) return;

            // Always cleanup old map instance first
            if (activityMap) {
                activityMap.remove();
                activityMap = null;
            }

            if (!polyline || polyline.length === 0) {
                container.style.display = 'none';
                return;
            }

            container.style.display = 'block';

            // Handle both compact [[lat, lon]] and Garmin [{lat, lon}] formats
            const latlngs = (polyline.length > 0 && Array.isArray(polyline[0]))
                ? polyline
                : polyline.map(p => [p.lat, p.lon]);

            // Dark mode map tiles (CartoDB Dark Matter)
            activityMap = L.map('activityMap', {
                zoomControl: false,
                attributionControl: false
            });

            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors &copy; <a href="https://carto.com/attributions">CARTO</a>',
                subdomains: 'abcd',
                maxZoom: 20
            }).addTo(activityMap);

            const path = L.polyline(latlngs, {
                color: '#38bdf8',
                weight: 4,
                opacity: 0.8,
                lineJoin: 'round'
            }).addTo(activityMap);

            // Fit bounds
            activityMap.fitBounds(path.getBounds(), { padding: [20, 20] });

            // Fix for map rendering in modal
            setTimeout(() => {
                activityMap.invalidateSize();
                activityMap.fitBounds(path.getBounds(), { padding: [20, 20] });
            }, 200);
        }

        // --- Global Heatmap Functions ---

        let globalHeatmap = null;
        let heatmapLayer = null;
        let heatmapData = []; // Raw data from API
        let heatmapPollInterval = null;

        async function updateGlobalHeatmap() {
            const range = document.getElementById('heatmap-range').value;
            const loadingEl = document.getElementById('heatmap-loading');
            const statusEl = document.getElementById('heatmap-status');
            const dot = document.getElementById('heatmap-dot');

            if (loadingEl) {
                loadingEl.style.display = 'flex';
                statusEl.textContent = 'Fetching routes...';
                if (dot) dot.style.display = 'block';
            }

            try {
                const res = await fetch(`/api/heatmap_data?range=${range}`);
                if (res.ok) {
                    const data = await res.json();
                    heatmapData = data.data || [];

                    renderGlobalHeatmap();

                    if (data.missing_count > 0) {
                        statusEl.textContent = `Syncing ${data.missing_count} routes...`;
                        dot.style.display = 'block';
                        // Start polling if missing data exists
                        if (!heatmapPollInterval) {
                            heatmapPollInterval = setInterval(updateGlobalHeatmapSilent, 5000);
                        }
                    } else {
                        statusEl.textContent = 'All activities loaded';
                        if (dot) dot.style.display = 'none';
                        setTimeout(() => {
                            if (loadingEl) loadingEl.style.display = 'none';
                        }, 3000);

                        if (heatmapPollInterval) {
                            clearInterval(heatmapPollInterval);
                            heatmapPollInterval = null;
                        }
                    }
                }
            } catch (err) {
                console.error('Heatmap error:', err);
                if (loadingEl) statusEl.textContent = 'Error loading data';
            }
        }

        async function updateGlobalHeatmapSilent() {
            const range = document.getElementById('heatmap-range').value;
            try {
                const res = await fetch(`/api/heatmap_data?range=${range}`);
                if (res.ok) {
                    const data = await res.json();

                    const statusEl = document.getElementById('heatmap-status');
                    const loadingEl = document.getElementById('heatmap-loading');
                    const dot = document.getElementById('heatmap-dot');

                    // Determine if we have new data
                    if (data.data.length > heatmapData.length) {
                        const oldCount = heatmapData.length;
                        heatmapData = data.data;
                        renderGlobalHeatmap(false); // false = don't reset view

                        if (statusEl) statusEl.textContent = `Added ${data.data.length - oldCount} new routes...`;
                    }

                    if (data.missing_count > 0) {
                        if (loadingEl) loadingEl.style.display = 'flex';
                        if (statusEl) statusEl.textContent = `Syncing ${data.missing_count} routes...`;
                        if (dot) dot.style.display = 'block';
                    } else {
                        if (statusEl) statusEl.textContent = 'All activities loaded';
                        if (dot) dot.style.display = 'none';
                        setTimeout(() => {
                            if (loadingEl) loadingEl.style.display = 'none';
                        }, 3000);

                    }
                }
            } catch (e) { console.error('Silent poll error', e); }
        }

        // Global container for polyline layers
        let globalLayerGroup = null;
        let clusterLayerGroup = null;

        function handleZoomEnd() {
            if (!globalLayerGroup) return;
            const z = globalHeatmap.getZoom();

            // Dynamic Line Styling: Bold when zoomed out, thin when in
            const newWeight = z < 11 ? 4 : 2;
            const newOpacity = z < 11 ? 0.5 : 0.6;

            // Debounce update to prevent stutter
            if (globalLayerGroup._updateTimeout) clearTimeout(globalLayerGroup._updateTimeout);
            globalLayerGroup._updateTimeout = setTimeout(() => {
                globalLayerGroup.eachLayer(l => {
                    if (l.options.weight !== newWeight) {
                        l.setStyle({ weight: newWeight, opacity: newOpacity });
                    }
                });
            }, 50);
        }

        function renderGlobalHeatmap(resetView = true) {
            if (!document.getElementById('globalHeatmap')) return;

            // Initialize Map
            if (!globalHeatmap) {
                globalHeatmap = L.map('globalHeatmap', {
                    zoomControl: true,
                    attributionControl: false,
                    preferCanvas: true // Important for performance
                }).setView([0, 0], 2);

                L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                    attribution: '&copy; OpenStreetMap &copy; CARTO',
                    subdomains: 'abcd',
                    maxZoom: 20
                }).addTo(globalHeatmap);

                // create layer groups
                globalLayerGroup = L.layerGroup(); // Lines

                // Cluster Group
                clusterLayerGroup = L.markerClusterGroup({
                    showCoverageOnHover: false,
                    zoomToBoundsOnClick: true,
                    spiderfyOnMaxZoom: true,
                    removeOutsideVisibleBounds: true,
                    animate: true,
                    maxClusterRadius: 60,
                    iconCreateFunction: function (cluster) {
                        return L.divIcon({
                            html: '<div><span>' + cluster.getChildCount() + '</span></div>',
                            className: 'marker-cluster marker-cluster-medium',
                            iconSize: new L.Point(40, 40)
                        });
                    }
                });

                // Set initial state: BOTH active
                globalHeatmap.addLayer(globalLayerGroup);
                globalHeatmap.addLayer(clusterLayerGroup);

                // Add smart zoom listener
                globalHeatmap.on('zoomend', handleZoomEnd);
            }

            // Clear previous layers
            if (globalLayerGroup) globalLayerGroup.clearLayers();
            if (clusterLayerGroup) clusterLayerGroup.clearLayers();

            // Filter Data
            const showRun = document.getElementById('heatmap-run').checked;
            const showCycle = document.getElementById('heatmap-cycle').checked;
            const showWalk = document.getElementById('heatmap-walk').checked;
            const showVirtual = document.getElementById('heatmap-virtual').checked;

            const boundsArr = [];

            // Shared canvas renderer for performance
            const myRenderer = L.canvas({ padding: 0.5 });

            heatmapData.forEach(item => {
                const type = item.type.toLowerCase();
                let include = false;
                let color = '#38bdf8'; // default blue

                if (type.includes('run')) {
                    if (showRun) include = true;
                    color = '#f97316'; // Orange
                } else if ((type.includes('virtual') || type.includes('indoor_cycling'))) {
                    if (showVirtual) include = true;
                    color = '#a855f7'; // Purple for virtual
                } else if (type.includes('cycle') || type.includes('ride') || type.includes('biking')) {
                    if (showCycle) include = true;
                    color = '#3b82f6'; // Blue
                } else if (type.includes('walk') || type.includes('hike')) {
                    if (showWalk) include = true;
                    color = '#22c55e'; // Green
                }

                if (include && item.poly && item.poly.length > 1) {
                    // Handle both compact and Garmin formats
                    const latlngs = Array.isArray(item.poly[0]) ? item.poly : item.poly.map(p => [p.lat, p.lon]);
                    const startPoint = latlngs[0];

                    // Add to Cluster Group (Invisible marker)
                    const marker = L.marker(startPoint, {
                        icon: L.divIcon({ className: 'hidden-marker', html: '', iconSize: [0, 0] })
                    });
                    if (clusterLayerGroup) clusterLayerGroup.addLayer(marker);

                    // Add polyline to group (Fixed weight since we switch to clusters zoomed out)
                    L.polyline(latlngs, {
                        color: color,
                        weight: 3,
                        opacity: 0.6,
                        renderer: myRenderer,
                        interactive: false
                    }).addTo(globalLayerGroup);

                    // Collect points for bounds (sample start/mid/end to save time)
                    if (resetView) {
                        boundsArr.push(latlngs[0]);
                        boundsArr.push(latlngs[Math.floor(latlngs.length / 2)]);
                        boundsArr.push(latlngs[latlngs.length - 1]);
                    }
                }
            });

            // Fit bounds & force zoom check
            if (resetView && boundsArr.length > 0) {
                const bounds = L.latLngBounds(boundsArr);
                globalHeatmap.fitBounds(bounds, { padding: [20, 20] });
                setTimeout(handleZoomEnd, 200); // Ensure correct layer shows
            }
        }

        function resetGlobalHeatmapView() {
            renderGlobalHeatmap(true);
        }

        async function openActivityDetail(id, basic) {
            const modal = document.getElementById('activityModal');
            if (!modal) return;
            modal.classList.add('active');

            // Reset Map
            const mapCont = document.getElementById('activity-map-container');
            if (mapCont) mapCont.style.display = 'none';

            const aiSection = document.getElementById('modal-ai-insight');
            const aiContent = document.getElementById('modal-ai-content');
            if (aiSection) aiSection.style.display = 'none';
            if (aiContent) aiContent.innerHTML = '<div class="loading"></div>';

            const dynamicBody = document.getElementById('modal-dynamic-body');
            if (dynamicBody) dynamicBody.innerHTML = '<div style="text-align:center; padding: 2rem;"><div class="loading"></div></div>';

            safeSetText('modal-title', basic.activityName);
            safeSetText('modal-date', new Date(basic.startTimeLocal).toLocaleString());

            // Check for AI Insight for this activity/session
            if (aiSection && aiContent) {
                const insight = cachedActivityInsights[id];
                const modelNameEl = document.getElementById('modal-ai-model-name');

                if (insight) {
                    aiSection.style.display = 'block';

                    // Display model name
                    if (modelNameEl && cachedModelName) {
                        modelNameEl.textContent = cachedModelName;
                    }

                    aiContent.innerHTML = `
                        <div style="background: rgba(56, 189, 248, 0.1); border-left: 3px solid var(--accent-color); padding: 0.75rem 1rem; margin-bottom: 1rem; border-radius: 0 0.5rem 0.5rem 0; font-style: italic; font-weight: 500; font-family: 'Lexend', sans-serif;">
                            üåü Highlight: ${parseMarkdown(insight.highlight || 'Standout performance recorded.')}
                        </div>
                        <p style="margin-bottom: 0.8rem;"><strong>Recap:</strong> ${parseMarkdown(insight.was)}</p>
                        <p style="margin-bottom: 0.8rem;"><strong>Focus:</strong> ${parseMarkdown(insight.worked_on)}</p>
                        <p><strong>Coach's Tip:</strong> ${parseMarkdown(insight.better_next)}</p>
                    `;
                } else {
                    aiSection.style.display = 'none';
                    if (modelNameEl) modelNameEl.textContent = '';
                }
            }

            try {
                const ids = basic.is_grouped ? basic.grouped_ids : [id];
                const results = await Promise.all(ids.map(stageId =>
                    fetch(`/api/activity/${stageId}`).then(r => r.json())
                ));

                if (dynamicBody) dynamicBody.innerHTML = '';
                let allPolylines = [];

                results.forEach((data, index) => {
                    if (!data || data.error) return;

                    const stageBasic = basic.is_grouped ? basic.grouped_activities[index] : basic;
                    const stageNum = basic.is_grouped ? (index + 1) : null;

                    // Render the stage UI
                    renderStage(data, stageBasic, stageNum);

                    if (data.polyline && data.polyline.length > 0) {
                        allPolylines = allPolylines.concat(data.polyline);
                    }
                });

                // Render Map if we have any data
                if (allPolylines.length > 0) {
                    renderActivityMap(allPolylines);
                }
            } catch (err) {
                console.error('Activity detail error:', err);
                if (dynamicBody) dynamicBody.innerHTML = '<div style="color: var(--danger-color); text-align:center;">Failed to load activity details.</div>';
            }
        }

        function renderStage(data, basic, stageNum) {
            const dynamicBody = document.getElementById('modal-dynamic-body');
            if (!dynamicBody) return;

            const isRun = basic.activityType.typeKey.toLowerCase().includes('run');
            const isCycle = basic.activityType.typeKey.toLowerCase().includes('cycling') || basic.activityType.typeKey.toLowerCase().includes('ride');
            const prefix = `stage-${basic.activityId}`;

            const summary = data.summary || basic;
            const hasPower = data.charts.power && data.charts.power.length > 0 && data.charts.power.some(p => p !== null && p > 0);

            // Create Stage Container
            const stageDiv = document.createElement('div');
            stageDiv.className = 'activity-stage';
            stageDiv.style.marginBottom = '3rem';
            stageDiv.style.paddingTop = '2rem';
            stageDiv.style.borderTop = '1px solid rgba(255,255,255,0.1)';

            const distMi = (summary.distance / 1609.34).toFixed(2);
            const durMin = Math.round(summary.duration / 60);

            let paceStr = '--';
            let paceLabel = isCycle ? 'Avg Speed' : 'Overall Pace';
            if (isCycle) {
                paceStr = (summary.averageSpeed * 2.23694).toFixed(1) + ' mph';
            } else if (data.avg_pace_str) {
                paceStr = data.avg_pace_str;
            }

            const elevGain = summary.elevationGain || 0;
            const gainFeet = Math.round(elevGain * 3.28084);
            const gainMeters = Math.round(elevGain);

            const avgCadence = summary.averageBikeCadence || summary.averageRunCadence || summary.averageCadence ||
                summary.averageBikingCadenceInRevPerMinute || summary.averageRunningCadenceInStepsPerMinute;

            stageDiv.innerHTML = `
                ${stageNum ? `<h3 style="color: var(--accent-color); margin-bottom: 1.5rem; font-family: 'Lexend', sans-serif;">Stage ${stageNum}: ${basic.activityName}</h3>` : ''}
                
                <div class="activity-detail-grid">
                    <div class="activity-detail-card">
                        <div class="activity-detail-label">Distance</div>
                        <div class="activity-detail-value">${distMi} mi / ${(summary.distance / 1000).toFixed(2)} km</div>
                    </div>
                    <div class="activity-detail-card">
                        <div class="activity-detail-label">${paceLabel}</div>
                        <div class="activity-detail-value">${paceStr}</div>
                    </div>
                    <div class="activity-detail-card">
                        <div class="activity-detail-label">Duration</div>
                        <div class="activity-detail-value">${durMin} min</div>
                    </div>
                    <div class="activity-detail-card">
                        <div class="activity-detail-label">Avg HR</div>
                        <div class="activity-detail-value">${summary.averageHR ? Math.round(summary.averageHR) + ' bpm' : '--'}</div>
                    </div>
                    <div class="activity-detail-card">
                        <div class="activity-detail-label">Elevation</div>
                        <div class="activity-detail-value">${gainFeet} ft / ${gainMeters} m</div>
                    </div>
                    <div class="activity-detail-card">
                        <div class="activity-detail-label">Avg Cadence</div>
                        <div class="activity-detail-value">${avgCadence ? Math.round(avgCadence) + (isRun ? ' spm' : ' rpm') : '--'}</div>
                    </div>
                    <div class="activity-detail-card" style="display: ${hasPower ? 'block' : 'none'}">
                        <div class="activity-detail-label">Avg Power</div>
                        <div class="activity-detail-value">${summary.averagePower ? Math.round(summary.averagePower) + ' W' : '--'}</div>
                    </div>
                    <div class="activity-detail-card">
                        <div class="activity-detail-label">Calories</div>
                        <div class="activity-detail-value">${Math.round(summary.calories)} kcal</div>
                    </div>
                </div>

                <div id="${prefix}-splits-section" style="display: none; margin-bottom: 2rem;">
                    <h4 style="margin-bottom: 1rem; color: var(--text-secondary); font-size: 0.9rem;">Mile Splits</h4>
                    <div id="${prefix}-splits-table"></div>
                </div>

                <div class="stage-charts">
                    <h4 style="margin-bottom: 1rem; font-size: 0.85rem; color: var(--text-secondary);">Elevation</h4>
                    <div class="small-chart-container"><canvas id="${prefix}-activityElevChart"></canvas></div>

                    <h4 style="margin-bottom: 1rem; font-size: 0.85rem; color: var(--text-secondary);">Heart Rate</h4>
                    <div class="small-chart-container"><canvas id="${prefix}-activityHrChart"></canvas></div>

                    <h4 style="margin-bottom: 1rem; font-size: 0.85rem; color: var(--text-secondary);">Cadence</h4>
                    <div class="small-chart-container"><canvas id="${prefix}-activityCadenceChart"></canvas></div>

                    <h4 id="${prefix}-power-title" style="margin-bottom: 1rem; font-size: 0.85rem; color: var(--text-secondary); display: none;">Power</h4>
                    <div id="${prefix}-power-chart-container" class="small-chart-container" style="display: none;">
                        <canvas id="${prefix}-activityPowerChart"></canvas>
                    </div>

                    <h4 style="margin-bottom: 1rem; font-size: 0.85rem; color: var(--text-secondary);">Speed/Pace</h4>
                    <div class="small-chart-container"><canvas id="${prefix}-activitySpeedChart"></canvas></div>
                </div>
            `;
            dynamicBody.appendChild(stageDiv);

            // Render Splits for this stage
            const splitsSection = document.getElementById(`${prefix}-splits-section`);
            const splitsTable = document.getElementById(`${prefix}-splits-table`);
            if (splitsSection && splitsTable && data.splits && data.splits.length > 0) {
                splitsSection.style.display = 'block';
                let html = `<table class="splits-table"><thead><tr><th>${isCycle ? 'Distance' : 'Mile'}</th><th>Time</th><th>${isCycle ? 'Speed' : 'Pace'}</th></tr></thead><tbody>`;
                data.splits.forEach(s => {
                    html += `<tr><td>${s.mile}</td><td>${formatDuration(s.duration)}</td><td>${s.pace_str}${isCycle ? '' : ' /mi'}</td></tr>`;
                });
                html += '</tbody></table>';
                splitsTable.innerHTML = html;
            }

            // Render Charts for this stage
            clearActivityCharts(prefix);
            renderActivityCharts(data.charts, isRun, isCycle, prefix);
        }
        function closeModal() { document.getElementById('activityModal').classList.remove('active'); }

        const activityChartIds = ['activityElevChart', 'activityHrChart', 'activityCadenceChart', 'activityPowerChart', 'activitySpeedChart'];

        function clearActivityCharts(prefix = '') {
            activityChartIds.forEach(id => {
                const fullId = prefix ? `${prefix}-${id}` : id;
                const canvas = document.getElementById(fullId);
                if (canvas) {
                    if (chartInstances[fullId]) {
                        chartInstances[fullId].destroy();
                        delete chartInstances[fullId];
                    }
                    const newCanvas = canvas.cloneNode(true);
                    canvas.parentNode.replaceChild(newCanvas, canvas);
                }
            });
        }

        function syncActivityCharts(source, prefix = '') {
            const { min, max } = source.scales.x;
            activityChartIds.forEach(id => {
                const fullId = prefix ? `${prefix}-${id}` : id;
                const chart = chartInstances[fullId];
                if (chart && chart !== source) {
                    chart.options.scales.x.min = min;
                    chart.options.scales.x.max = max;
                    chart.update('none');
                }
            });
        }

        function renderActivityCharts(charts, isRun, isCycle, prefix = '') {
            if (!charts.timestamps || charts.timestamps.length === 0) return;
            const start = new Date(charts.timestamps[0]).getTime();
            const elapsed = charts.timestamps.map(t => (new Date(t).getTime() - start) / 1000);

            const hasData = (arr, checkSignificant = true) => {
                if (!arr || arr.length === 0) return false;
                let found = false, max = 0;
                for (let i = 0; i < arr.length; i++) {
                    const v = arr[i];
                    if (v !== null && v !== undefined && !isNaN(v)) {
                        found = true;
                        if (checkSignificant) { const absV = Math.abs(v); if (absV > max) max = absV; }
                    }
                }
                return checkSignificant ? (max > 0.001) : found;
            };

            const chartConfigs = [
                { id: 'activityElevChart', data: charts.elevation, process: d => d.map(e => e === null ? null : e * 3.28084), label: 'Elevation', color: '#94a3b8', unit: 'ft', significant: true },
                { id: 'activityHrChart', data: charts.heart_rate, process: d => d, label: 'Heart Rate', color: '#f87171', unit: 'bpm', significant: true },
                { id: 'activityCadenceChart', data: charts.cadence, process: d => d, label: isRun ? 'spm' : 'rpm', color: '#4ade80', unit: '', significant: true },
                { id: 'activityPowerChart', data: charts.power, process: d => d, label: 'Power', color: '#a855f7', unit: 'W', colorFunc: getPowerZoneColor, significant: true }
            ];

            chartConfigs.forEach(conf => {
                const fullId = prefix ? `${prefix}-${conf.id}` : conf.id;
                const canvas = document.getElementById(fullId);
                if (!canvas) return;
                const container = canvas.parentElement;
                const title = document.getElementById(fullId.replace('Chart', '-title')) || container.previousElementSibling;

                if (hasData(conf.data, conf.significant)) {
                    if (container) container.style.display = 'block';
                    if (title && title.tagName === 'H4') title.style.display = 'block';

                    setTimeout(() => {
                        const processedData = conf.process(conf.data);
                        const points = elapsed.map((time, i) => {
                            const val = processedData[i];
                            return (val === null || val === undefined) ? null : { x: time, y: val };
                        }).filter(p => p !== null);
                        renderDetailChart(fullId, points, conf.label, conf.color, conf.unit, false, conf.colorFunc, prefix);
                    }, 50);
                } else {
                    if (container) container.style.display = 'none';
                    if (title && title.tagName === 'H4') title.style.display = 'none';
                }
            });

            // Speed/Pace
            const fullSpeedId = prefix ? `${prefix}-activitySpeedChart` : 'activitySpeedChart';
            const speedCanvas = document.getElementById(fullSpeedId);
            const speedContainer = speedCanvas ? speedCanvas.parentElement : null;
            const speedTitle = speedContainer ? speedContainer.previousElementSibling : null;

            if (hasData(charts.speed, true)) {
                if (speedContainer) speedContainer.style.display = 'block';
                if (speedTitle && speedTitle.tagName === 'H4') speedTitle.style.display = 'block';
                setTimeout(() => {
                    let points = [];
                    if (isRun) {
                        points = elapsed.map((time, i) => {
                            const s = charts.speed[i];
                            if (s && s > 0.1) return { x: time, y: 26.8224 / s };
                            return null;
                        }).filter(p => p !== null);
                        renderDetailChart(fullSpeedId, points, 'Pace', '#38bdf8', '/mi', true, null, prefix);
                    } else {
                        points = elapsed.map((time, i) => {
                            const s = charts.speed[i];
                            return (s === null || s === undefined) ? null : { x: time, y: s * 2.23694 };
                        }).filter(p => p !== null);
                        renderDetailChart(fullSpeedId, points, 'Speed', '#38bdf8', 'mph', false, null, prefix);
                    }
                }, 50);
            }
        }

        function renderDetailChart(id, points, label, color, unit, rev = false, colorFunc = null, prefix = '') {
            const canvas = document.getElementById(id);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chartInstances[id]) chartInstances[id].destroy();

            chartInstances[id] = new Chart(ctx, {
                type: 'line',
                data: {
                    datasets: [{
                        label, data: points, borderColor: color, backgroundColor: color + '22',
                        fill: true, pointRadius: 0, tension: 0.4, spanGaps: true,
                        segment: colorFunc ? {
                            borderColor: ctx => colorFunc(ctx.p1.parsed.y),
                            backgroundColor: ctx => colorFunc(ctx.p1.parsed.y) + '44'
                        } : undefined
                    }]
                },
                options: {
                    responsive: true, maintainAspectRatio: false, animation: false,
                    plugins: {
                        legend: { display: false },
                        zoom: {
                            pan: { enabled: true, mode: 'x', onPan: (c) => syncActivityCharts(c.chart, prefix) },
                            zoom: { wheel: { enabled: true }, mode: 'x', onZoom: (c) => syncActivityCharts(c.chart, prefix) }
                        }
                    },
                    scales: {
                        y: { reverse: rev, ticks: { color: '#94a3b8', callback: v => v.toFixed(1) + ' ' + unit }, grid: { color: 'rgba(255,255,255,0.05)' } },
                        x: { type: 'linear', ticks: { color: '#94a3b8', callback: v => formatDuration(v) }, grid: { display: false } }
                    }
                }
            });
        }

        function getPowerZoneColor(p) {
            if (p >= 450) return '#a855f7'; // Purple
            if (p >= 350) return '#ef4444'; // Red
            if (p >= 300) return '#f97316'; // Orange
            if (p >= 250) return '#eab308'; // Yellow
            if (p >= 200) return '#22c55e'; // Green
            if (p >= 150) return '#3b82f6'; // Blue
            return '#94a3b8'; // Grey
        }

        function formatDuration(s) {
            const h = Math.floor(s / 3600); const m = Math.floor((s % 3600) / 60); const sec = Math.floor(s % 60);
            return h > 0 ? `${h}:${m.toString().padStart(2, '0')}:${sec.toString().padStart(2, '0')}` : `${m}:${sec.toString().padStart(2, '0')}`;
        }

        // --- Heatmap & Calendar Functions ---

        async function fetchActivityHeatmap() {
            try {
                const res = await fetch('/api/activity_heatmap');
                if (res.ok) renderActivityHeatmap(await res.json());
            } catch (err) { console.error('Heatmap error:', err); }
        }

        function renderActivityHeatmap(data) {
            const container = document.getElementById('activity-heatmap');
            if (!container) return;
            container.innerHTML = '';


            const tooltip = document.getElementById('heatmap-tooltip');
            const today = new Date();
            const start = new Date();
            start.setDate(today.getDate() - 365);
            start.setDate(start.getDate() - ((start.getDay() + 6) % 7));

            let currentWeek = [];
            let current = new Date(start);

            while (current <= today || current.getDay() !== 1) {
                const dStr = getLocalDateStr(current);
                const activities = data[dStr] || [];


                currentWeek.push({
                    date: new Date(current),
                    dateStr: dStr,
                    activities: activities,
                    count: activities.length
                });

                if (current.getDay() === 0) {
                    const col = document.createElement('div');
                    col.style.display = 'flex';
                    col.style.flexDirection = 'column';
                    col.style.gap = '4px';

                    currentWeek.forEach(day => {
                        const cell = document.createElement('div');
                        cell.className = 'heatmap-cell';
                        cell.style.width = '12px';
                        cell.style.height = '12px';
                        cell.style.borderRadius = '2px';

                        let bg = 'rgba(255,255,255,0.05)';
                        if (day.count === 1) bg = 'rgba(34, 197, 94, 0.4)';
                        else if (day.count === 2) bg = 'rgba(34, 197, 94, 0.7)';
                        else if (day.count >= 3) bg = '#22c55e';
                        cell.style.background = bg;

                        const showTooltip = (e) => {
                            if (!tooltip) return;
                            const d = day.date.toLocaleDateString('en-US', { weekday: 'short', month: 'short', day: 'numeric', year: 'numeric' });
                            let html = `<div class="heatmap-tooltip-date">${d}</div>`;

                            if (day.activities.length > 0) {
                                day.activities.forEach(a => {
                                    html += `
                                        <div class="heatmap-tooltip-activity">
                                            <span>${a.name}</span>
                                            <span style="color: var(--text-secondary); white-space: nowrap;">${a.dist}mi / ${a.dur}m</span>
                                        </div>
                                    `;
                                });
                            } else {
                                html += `<div style="color: var(--text-secondary); font-size: 0.75rem;">No activities</div>`;
                            }

                            tooltip.innerHTML = html;
                            tooltip.style.display = 'block';

                            const x = e.clientX + 15;
                            const y = e.clientY + 15;
                            const rect = tooltip.getBoundingClientRect();
                            const finalX = (x + rect.width > window.innerWidth) ? (e.clientX - rect.width - 15) : x;
                            const finalY = (y + rect.height > window.innerHeight) ? (e.clientY - rect.height - 15) : y;

                            tooltip.style.left = finalX + 'px';
                            tooltip.style.top = finalY + 'px';
                        };

                        const hideTooltip = () => { if (tooltip) tooltip.style.display = 'none'; };

                        cell.onmouseenter = showTooltip;
                        cell.onmousemove = showTooltip;
                        cell.onmouseleave = hideTooltip;
                        cell.onclick = (e) => { showTooltip(e); };

                        col.appendChild(cell);
                    });
                    container.appendChild(col);
                    currentWeek = [];
                }
                current.setDate(current.getDate() + 1);
            }
            const scroll = document.getElementById('heatmap-scroll-container');
            if (scroll) scroll.scrollLeft = scroll.scrollWidth;
        }

        let calendarDate = new Date();
        let currentCalendarView = 'month';

        async function fetchCalendarData() {
            let startStr, endStr;
            const year = calendarDate.getFullYear();
            const month = calendarDate.getMonth();

            if (currentCalendarView === 'year') {
                startStr = `${year}-01-01`; endStr = `${year}-12-31`;
            } else if (currentCalendarView === 'month') {
                const first = new Date(year, month, 1);
                const last = new Date(year, month + 1, 0);
                const startPad = (first.getDay() + 6) % 7;
                const endPad = 6 - ((last.getDay() + 6) % 7);
                startStr = getLocalDateStr(new Date(year, month, 1 - startPad));
                endStr = getLocalDateStr(new Date(year, month + 1, endPad));
            } else {
                const day = calendarDate.getDay();
                const diff = calendarDate.getDate() - day + (day == 0 ? -6 : 1);
                const start = new Date(calendarDate); start.setDate(diff);
                const end = new Date(start); end.setDate(start.getDate() + 6);
                startStr = getLocalDateStr(start); endStr = getLocalDateStr(end);
            }

            try {
                const res = await fetch(`/api/calendar_activities?start_date=${startStr}&end_date=${endStr}`);
                if (res.ok) {
                    const activities = await res.json();
                    renderDetailedCalendar(activities, year, month);
                }
            } catch (e) { console.error("Calendar fetch error", e); }
        }

        function setCalendarView(view) {
            currentCalendarView = view;
            document.querySelectorAll('.calendar-widget .range-btn').forEach(b => b.classList.remove('active'));
            const btn = document.getElementById(`cal-view-${view}`);
            if (btn) btn.classList.add('active');
            fetchCalendarData();
        }

        function shiftCalendarMonth(dir) {
            if (currentCalendarView === 'year') calendarDate.setFullYear(calendarDate.getFullYear() + dir);
            else if (currentCalendarView === 'month') calendarDate.setMonth(calendarDate.getMonth() + dir);
            else calendarDate.setDate(calendarDate.getDate() + (dir * 7));
            fetchCalendarData();
        }

        function resetCalendarToToday() { calendarDate = new Date(); fetchCalendarData(); }

        function renderDetailedCalendar(activities, currentYear, currentMonth) {
            const titleEl = document.getElementById('calendar-title');
            if (titleEl) {
                if (currentCalendarView === 'year') titleEl.textContent = currentYear;
                else if (currentCalendarView === 'month') titleEl.textContent = `${calendarDate.toLocaleString('default', { month: 'long' })} ${currentYear}`;
                else {
                    const start = new Date(calendarDate); const day = calendarDate.getDay();
                    start.setDate(calendarDate.getDate() - day + (day == 0 ? -6 : 1));
                    const end = new Date(start); end.setDate(start.getDate() + 6);
                    titleEl.textContent = `${start.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })} - ${end.toLocaleDateString(undefined, { month: 'short', day: 'numeric' })} ${end.getFullYear()}`;
                }
            }

            const grid = document.getElementById('calendar-grid');
            if (!grid) return;
            grid.className = currentCalendarView === 'year' ? 'year-view-grid' : 'calendar-grid';
            grid.innerHTML = '';

            const activitiesByDate = {};
            activities.forEach(act => {
                const dateStr = act.startTimeLocal.split(' ')[0];
                if (!activitiesByDate[dateStr]) activitiesByDate[dateStr] = [];
                activitiesByDate[dateStr].push(act);
            });

            if (currentCalendarView === 'year') {
                renderYearView(grid, activitiesByDate, currentYear);
            } else if (currentCalendarView === 'month') {
                const first = new Date(currentYear, currentMonth, 1);
                const startPad = (first.getDay() + 6) % 7;
                const startDate = new Date(currentYear, currentMonth, 1 - startPad);
                for (let i = 0; i < 42; i++) {
                    const d = new Date(startDate); d.setDate(d.getDate() + i);
                    const dateStr = getLocalDateStr(d);
                    const cell = document.createElement('div');
                    cell.className = `calendar-cell ${dateStr === getLocalDateStr(new Date()) ? 'today' : ''} ${d.getMonth() !== currentMonth ? 'other-month' : ''}`;
                    cell.innerHTML = `<div class="calendar-date">${d.getDate()}</div>`;
                    if (activitiesByDate[dateStr]) {
                        activitiesByDate[dateStr].forEach(act => {
                            const pill = document.createElement('div');
                            pill.className = `activity-pill ${getActivityPillClass(act.activityType.typeKey)}`;
                            pill.innerHTML = `<span>${getActivityIcon(act.activityType.typeKey)}</span> ${act.distance > 0 ? (act.distance * 0.000621371).toFixed(1) + 'mi' : Math.round(act.duration / 60) + 'm'}`;
                            cell.appendChild(pill);
                        });
                    }
                    grid.appendChild(cell);
                }
            } else {
                // Week view
                const start = new Date(calendarDate); const day = calendarDate.getDay();
                start.setDate(calendarDate.getDate() - day + (day == 0 ? -6 : 1));
                for (let i = 0; i < 7; i++) {
                    const d = new Date(start); d.setDate(d.getDate() + i);
                    const dateStr = getLocalDateStr(d);
                    const cell = document.createElement('div');
                    cell.className = 'calendar-cell view-week';
                    cell.innerHTML = `<div class="calendar-date">${d.toLocaleDateString(undefined, { weekday: 'short', day: 'numeric' })}</div>`;
                    if (activitiesByDate[dateStr]) {
                        activitiesByDate[dateStr].forEach(act => {
                            const pill = document.createElement('div');
                            pill.className = `activity-pill ${getActivityPillClass(act.activityType.typeKey)}`;
                            pill.innerHTML = `<strong>${act.activityName}</strong><br>${act.distance > 0 ? (act.distance * 0.000621371).toFixed(2) + ' mi' : ''} | ${(act.duration / 60).toFixed(0)}m`;
                            cell.appendChild(pill);
                        });
                    }
                    grid.appendChild(cell);
                }
            }
            updateCalendarTotals(activities, currentYear, currentMonth);
        }

        function renderYearView(container, data, year) {
            for (let m = 0; m < 12; m++) {
                const monthDiv = document.createElement('div'); monthDiv.className = 'small-month';
                const mName = new Date(year, m, 1).toLocaleString('default', { month: 'short' });
                monthDiv.innerHTML = `<div class="small-month-title">${mName}</div>`;
                const mGrid = document.createElement('div'); mGrid.className = 'small-month-grid';
                const first = new Date(year, m, 1); const pad = (first.getDay() + 6) % 7;
                for (let p = 0; p < pad; p++) mGrid.appendChild(document.createElement('div'));
                const last = new Date(year, m + 1, 0).getDate();
                for (let d = 1; d <= last; d++) {
                    const dateStr = getLocalDateStr(new Date(year, m, d));
                    const dayEl = document.createElement('div'); dayEl.className = 'small-day'; dayEl.textContent = d;
                    if (data[dateStr]) {
                        const dot = document.createElement('div'); dot.className = 'day-dot';
                        dot.style.background = getActivityColor(data[dateStr][0].activityType.typeKey);
                        dayEl.appendChild(dot);
                    }
                    mGrid.appendChild(dayEl);
                }
                monthDiv.appendChild(mGrid); container.appendChild(monthDiv);
            }
        }

        function getActivityPillClass(type) {
            if (type.includes('running')) return 'act-running';
            if (type.includes('virtual_ride')) return 'act-virtual-ride';
            if (type.includes('cycling') || type.includes('ride')) return 'act-cycling';
            if (type.includes('swimming')) return 'act-swimming';
            if (type.includes('walking')) return 'act-walking';
            if (type.includes('strength')) return 'act-strength';
            return 'act-other';
        }

        function getActivityColor(type) {
            if (type.includes('running')) return '#3b82f6';
            if (type.includes('virtual_ride')) return '#f59e0b';
            if (type.includes('cycling') || type.includes('ride')) return '#f97316';
            if (type.includes('swimming')) return '#06b6d4';
            return '#64748b';
        }

        function updateCalendarTotals(activities, currentYear, currentMonth) {
            const container = document.getElementById('calendar-totals');
            if (!container) return;
            container.innerHTML = '';
            let totals = { count: 0, distance: 0, duration: 0, types: {} };

            activities.forEach(act => {
                const date = parseLocalDate(act.startTimeLocal.split(' ')[0]);
                const inRange = (currentCalendarView === 'year') ||
                    (currentCalendarView === 'month' && date.getMonth() === currentMonth) ||
                    (currentCalendarView === 'week');

                if (inRange) {
                    totals.count++;
                    totals.distance += act.distance || 0;
                    totals.duration += act.duration || 0;
                    const type = act.activityType.typeKey;
                    if (!totals.types[type]) totals.types[type] = { count: 0, distance: 0, time: 0 };
                    totals.types[type].count++;
                    totals.types[type].distance += act.distance || 0;
                    totals.types[type].time += act.duration || 0;
                }
            });

            container.innerHTML += `
                <div class="total-card">
                    <div class="total-type" style="font-size: 1.1rem; margin-bottom: 1rem;">Summary</div>
                    <div class="total-value-row"><span>Activities</span><span>${totals.count}</span></div>
                    <div class="total-value-row"><span>Distance</span><span>${(totals.distance * 0.000621371).toFixed(1)} mi</span></div>
                    <div class="total-value-row"><span>Time</span><span>${Math.floor(totals.duration / 3600)}h ${Math.round((totals.duration % 3600) / 60)}m</span></div>
                </div>`;

            Object.keys(totals.types).forEach(type => {
                const data = totals.types[type];
                container.innerHTML += `
                    <div class="total-card" style="border-left: 4px solid ${getActivityColor(type)};">
                        <div class="total-type">${type.replace(/_/g, ' ')}</div>
                        <div class="total-value-row"><span>Count</span><span>${data.count}</span></div>
                        <div class="total-value-row"><span>Distance</span><span>${(data.distance * 0.000621371).toFixed(1)} mi</span></div>
                    </div>`;
            });
        }

        function openWeightModal() { document.getElementById('weightModal').classList.add('active'); }
        function closeWeightModal() { document.getElementById('weightModal').classList.remove('active'); }
        async function submitWeight() {
            const val = parseFloat(document.getElementById('weight-input').value);
            const unit = document.querySelector('input[name="weight-unit"]:checked').value;
            if (!val) return;
            try {
                const res = await fetch('/api/add_weight', { method: 'POST', headers: { 'Content-Type': 'application/json' }, body: JSON.stringify({ weight: unit === 'lbs' ? val / 2.20462 : val }) });
                if (res.ok) { closeWeightModal(); fetchData(); }
            } catch (err) { console.error('Add weight error:', err); }
        }

        function renderIntensityMinutesVisualV2(data) {
            const canvasId = 'imHistoryChart';
            const canvas = document.getElementById(canvasId);
            if (!canvas) return;
            const ctx = canvas.getContext('2d');
            if (chartInstances[canvasId]) chartInstances[canvasId].destroy();

            const range = data.range || currentIMRange;
            const history = data.history || [];
            const goal = data.goal || 150;

            if (history.length > 0) {
                let thisWeekTotal = 0;
                for (let i = history.length - 1; i >= 0; i--) {
                    const d = history[i];
                    const dt = parseLocalDate(d.date);
                    thisWeekTotal += d.total;
                    if (dt.getDay() === 1) break;
                }
                safeSetText('im-val', thisWeekTotal);
                safeSetText('im-goal', goal);
            }

            if (range === '1d') {
                const points = data.samples.map(s => ({ x: s[0], y: s[1] }));
                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: {
                        datasets: [{
                            label: 'Intensity Minutes',
                            data: points,
                            borderColor: '#38bdf8',
                            backgroundColor: 'rgba(56, 189, 248, 0.1)',
                            borderWidth: 2,
                            pointRadius: 0,
                            fill: true,
                            tension: 0.1
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { type: 'time', time: { displayFormats: { hour: 'HH:mm' } }, grid: { display: false }, ticks: { color: '#94a3b8' } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            } else if (range === '1w' || range === '1m') {
                const weeks_seg = [];
                let curWeek = [];
                history.forEach(d => {
                    const dt = parseLocalDate(d.date);
                    if (dt.getDay() === 1 && curWeek.length > 0) {
                        weeks_seg.push(curWeek);
                        curWeek = [];
                    }
                    curWeek.push(d);
                });
                if (curWeek.length > 0) weeks_seg.push(curWeek);

                const dsLabels = history.map(d => {
                    const dt = parseLocalDate(d.date);
                    if (dt.getDay() === 1) return dt.toLocaleDateString([], { month: 'short', day: 'numeric' });
                    if (range === '1w') return dt.toLocaleDateString([], { weekday: 'short' });
                    return '';
                });

                const dsDatasets = weeks_seg.map((week, idx) => {
                    let cumulative = 0;
                    const weekData = history.map(h => {
                        const dayInWeek = week.find(w => w.date === h.date);
                        if (dayInWeek) {
                            cumulative += dayInWeek.total;
                            return cumulative;
                        }
                        return null;
                    });
                    const isGoalMet = cumulative >= goal;
                    const color = isGoalMet ? '#4ade80' : '#38bdf8';
                    return {
                        label: `Week ${idx + 1}`,
                        data: weekData,
                        borderColor: color,
                        borderWidth: 3,
                        pointRadius: 0,
                        stepped: 'before',
                        fill: false,
                        spanGaps: false
                    };
                });

                dsDatasets.push({
                    label: 'Weekly Goal',
                    data: history.map(() => goal),
                    borderColor: 'rgba(255, 255, 255, 0.3)',
                    borderDash: [5, 5],
                    borderWidth: 1.5,
                    pointRadius: 0,
                    fill: false,
                    order: 0
                });

                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'line',
                    data: { labels: dsLabels, datasets: dsDatasets },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8', autoSkip: false } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            } else {
                const lw = history[history.length - 1];
                safeSetText('im-val', lw ? lw.total : '--');
                safeSetText('im-goal', lw ? lw.goal : '150');
                chartInstances[canvasId] = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: history.map((d, i) => (i % 4 === 0) ? parseLocalDate(d.date).toLocaleDateString([], { month: 'short', day: 'numeric' }) : ''),
                        datasets: [{
                            label: 'Weekly Total',
                            data: history.map(d => d.total),
                            backgroundColor: history.map(d => d.total >= d.goal ? '#4ade80' : '#38bdf8'),
                            borderRadius: 4
                        }]
                    },
                    options: {
                        responsive: true, maintainAspectRatio: false,
                        plugins: { legend: { display: false } },
                        scales: {
                            x: { grid: { display: false }, ticks: { color: '#94a3b8', autoSkip: false } },
                            y: { beginAtZero: true, grid: { color: 'rgba(255,255,255,0.05)' }, ticks: { color: '#94a3b8' } }
                        }
                    }
                });
            }
        }

        // Start everything when DOM is ready
        document.addEventListener('DOMContentLoaded', () => {
            fetchData();
        });

        window.addEventListener('resize', () => {
            Object.values(chartInstances).forEach(chart => { chart.update(); });
        });
    </script>
    <div id="heatmap-tooltip"></div>
</body>


</html>